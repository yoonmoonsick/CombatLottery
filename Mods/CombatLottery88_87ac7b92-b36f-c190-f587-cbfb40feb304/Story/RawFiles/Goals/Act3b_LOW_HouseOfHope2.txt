Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION House of Hope

DB_DangerZone((TRIGGER)S_LOW_HouseOfHope_DangerZone_20215348-49a6-4c6b-ba2b-5d01b77b1e02, "LOW_HouseOfHope_DangerZone");

DB_DefeatedStateFlag(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, (FLAG)LOW_HouseOfHope_State_HopeDefeated_98f3ca61-a2dd-4d17-81b8-c516c5ce9e4d);

DB_InRegionFlag((TRIGGER)S_LOW_HouseOfHope_SUB_49462249-7f39-4b91-af1d-ba121c711213, (FLAG)LOW_HouseOfHope_State_InRegion_216b82aa-2d9a-47d2-9793-2638226c8f61);
DB_InRegionFlag((TRIGGER)S_LOW_HouseOfHope_Prison_SUB_829b3df1-01b1-4d31-b251-0495c7692bec, (FLAG)LOW_HouseOfHope_State_InRegion_216b82aa-2d9a-47d2-9793-2638226c8f61);

DB_TriggerEvents_TriggerSet("LOW_HouseOfHope", (TRIGGER)S_LOW_HouseOfHope_SUB_49462249-7f39-4b91-af1d-ba121c711213);
DB_TriggerEvents_TriggerSet("LOW_HouseOfHope", (TRIGGER)S_LOW_HouseOfHope_Prison_SUB_829b3df1-01b1-4d31-b251-0495c7692bec);

//END_REGION

//REGION Hope delivery system

DB_LOW_HouseOfHope_HopeFoopPoofVFX((EFFECTRESOURCE)EFFECTRESOURCEGUID_VFX_Script_Stub_Poof_01_31f76ec6-b35d-b9e5-4bca-d10240b5969e);

DB_LOW_HouseOfHope_HopeSpirits(S_LOW_HopeSpirit01_bd1a71ec-0cea-4caf-9ead-be7e1cc84ede);
DB_LOW_HouseOfHope_HopeSpirits(S_LOW_HopeSpirit02_f269f979-fe67-40c7-b658-b554bb84d36d);
DB_LOW_HouseOfHope_HopeSpirits(S_LOW_HopeSpirit03_addd16fc-118e-46c6-81d2-55d69fa919b5);
DB_LOW_HouseOfHope_HopeSpirits(S_LOW_HopeSpirit04_e42e7bf6-93c5-42df-be4e-af993c6adc25);
DB_LOW_HouseOfHope_HopeSpirits(S_LOW_HopeSpirit05_afce8d6b-24c5-4c00-903d-3ec20eb5d0e9);
DB_LOW_HouseOfHope_HopeSpirits(S_LOW_HopeSpirit06_e126d40a-2e86-4736-90b9-aa290f47a4ed);
DB_LOW_HouseOfHope_HopeSpirits(S_LOW_HopeSpirit_Alarm_8b0c3442-b9b9-4efa-aa05-2c1ea1240dae);
DB_LOW_HouseOfHope_HopeSpirits(S_LOW_HopeSpirit_Guide_51baa5f6-1248-499b-acf3-79b6bdd0f6bd);

DB_LOW_HouseOfHope_HopeTriggeredDialogues((TRIGGER)S_LOW_HouseOfHope_HopeSpirit01Trigger_ce6d730f-eb77-49ad-9f1c-db859990b036, 
(CHARACTER)S_LOW_HopeSpirit01_bd1a71ec-0cea-4caf-9ead-be7e1cc84ede, (DIALOGRESOURCE)LOW_HouseOfHope_HopeSpirit01_32a22a1a-6052-0556-509b-a30105e5f4dc, 1,
"LOW_HouseOfHope_Hope01Appearance", "LOW_HouseOfHope_Hope01Dialogue");
DB_LOW_HouseOfHope_HopeTriggeredDialogues((TRIGGER)S_LOW_HouseOfHope_HopeSpirit02Trigger_f2672999-a53d-4551-9756-0019fed430b9,
(CHARACTER)S_LOW_HopeSpirit02_f269f979-fe67-40c7-b658-b554bb84d36d, (DIALOGRESOURCE)LOW_HouseOfHope_HopeSpirit02_8d5c9ef9-f70b-0195-eab0-92bec85c2184, 0,
"LOW_HouseOfHope_Hope02Appearance", "LOW_HouseOfHope_Hope02Dialogue");
DB_LOW_HouseOfHope_HopeTriggeredDialogues((TRIGGER)S_LOW_HouseOfHope_HopeSpirit03Trigger_af50552d-ea83-4443-800f-f5701e933146,
(CHARACTER)S_LOW_HopeSpirit03_addd16fc-118e-46c6-81d2-55d69fa919b5, (DIALOGRESOURCE)LOW_HouseOfHope_HopeSpirit03_5cf2c5cf-db96-4d8a-e434-be363e9b3f81, 0,
"LOW_HouseOfHope_Hope03Appearance", "LOW_HouseOfHope_Hope03Dialogue");
DB_LOW_HouseOfHope_HopeTriggeredDialogues((TRIGGER)S_LOW_HouseOfHope_HopeSpirit04Trigger_b8711032-4967-4389-bfbb-e9eaddbbb19b,
(CHARACTER)S_LOW_HopeSpirit04_e42e7bf6-93c5-42df-be4e-af993c6adc25, (DIALOGRESOURCE)LOW_HouseOfHope_HopeSpirit04_9c2892d6-963c-f781-f9e4-0ee02d1446a3, 0,
"LOW_HouseOfHope_Hope04Appearance", "LOW_HouseOfHope_Hope04Dialogue");
DB_LOW_HouseOfHope_HopeTriggeredDialogues((TRIGGER)S_LOW_HouseOfHope_HopeSpirit05Trigger_6bb4787f-5143-4527-b90b-36a50639e054,
(CHARACTER)S_LOW_HopeSpirit05_afce8d6b-24c5-4c00-903d-3ec20eb5d0e9, (DIALOGRESOURCE)LOW_HouseOfHope_HopeSpirit_Prison_33f61440-9fb9-b8d3-270b-0dc0aa8a9792, 1,
"LOW_HouseOfHope_Hope05Appearance", "LOW_HouseOfHope_Hope05Dialogue");
DB_LOW_HouseOfHope_HopeTriggeredDialogues((TRIGGER)S_LOW_HouseOfHope_HopeSpirit06Trigger_e8ff0f5d-45d6-4ff1-8b9e-3ee055e53e29,
(CHARACTER)S_LOW_HopeSpirit06_e126d40a-2e86-4736-90b9-aa290f47a4ed, (DIALOGRESOURCE)LOW_HouseOfHope_HopeSpirit_Prison_33f61440-9fb9-b8d3-270b-0dc0aa8a9792, 1,
"LOW_HouseOfHope_Hope06Appearance", "LOW_HouseOfHope_Hope06Dialogue");
DB_LOW_HouseOfHope_HopeTriggeredDialogues((TRIGGER)S_LOW_HouseOfHope_HopeAlarmTrigger_a74b17a0-2343-46c8-b992-0af963fb13a8,
(CHARACTER)S_LOW_HopeSpirit_Alarm_8b0c3442-b9b9-4efa-aa05-2c1ea1240dae, (DIALOGRESOURCE)LOW_HouseOfHope_HopeSpirit_Alarm_b44dd29f-d9ca-faac-91e6-8de7eb05641d, 1,
"LOW_HouseOfHope_HopeAlarmAppearance", "LOW_HouseOfHope_HopeAlarmDialogue");

DB_LOW_HouseOfHope_HopeGuidance((TRIGGER)S_LOW_HouseOfHope_ArchiveGuide01Trigger_9a139e60-0043-492f-b774-083dcaf20c9c, 
(TRIGGER)S_LOW_HouseOfHope_ArchiveGuide02Point_93fa8940-49b2-4588-98d5-8b7e3b56011f, "LOW_HouseOfHope_HopeGuideTo2", 1);
DB_LOW_HouseOfHope_HopeGuidance((TRIGGER)S_LOW_HouseOfHope_ArchiveGuide02Trigger_e4dabd0c-c5d5-49cd-8041-e9707dcadb8e, 
(TRIGGER)S_LOW_HouseOfHope_ArchiveGuide03Point_91ad1b1a-810b-425f-8265-e8a5ed274a56, "LOW_HouseOfHope_HopeGuideTo3", 2);
DB_LOW_HouseOfHope_HopeGuidance((TRIGGER)S_LOW_HouseOfHope_ArchiveGuide03Trigger_64dabb4b-d360-4260-8858-d4d062c36cea, 
(TRIGGER)S_LOW_HouseOfHope_ArchiveGuide04Point_0cbb8aa4-d9f8-49a5-a27a-bbc66ac7d332, "LOW_HouseOfHope_HopeGuideTo4", 3);
DB_LOW_HouseOfHope_HopeGuidance((TRIGGER)S_LOW_HouseOfHope_ArchiveGuide04Trigger_1c8ca00a-3e68-4ae1-abc6-63d73b4bfe44, 
(TRIGGER)S_LOW_HouseOfHope_ArchiveGuide05Point_e367fa87-355c-4d34-b89d-167f9d3c5edf, "LOW_HouseOfHope_HopeGuideTo5", 4);


// Through AllowedHopeSpirits DB we can change what Hope Spirits can appear.
DB_LOW_HouseOfHope_AllowedHopeSpirits((CHARACTER)S_LOW_HopeSpirit01_bd1a71ec-0cea-4caf-9ead-be7e1cc84ede);

DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)LOW_HouseOfHope_HopeSpirit01_32a22a1a-6052-0556-509b-a30105e5f4dc, (TRIGGER)S_LOW_HouseOfHope_HopeSpirit01Trigger_ce6d730f-eb77-49ad-9f1c-db859990b036, 1);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)LOW_HouseOfHope_HopeSpirit_Prison_33f61440-9fb9-b8d3-270b-0dc0aa8a9792, (TRIGGER)S_LOW_HouseOfHope_HopeSpirit05Trigger_6bb4787f-5143-4527-b90b-36a50639e054, 1);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)LOW_HouseOfHope_HopeSpirit_Prison_33f61440-9fb9-b8d3-270b-0dc0aa8a9792, (TRIGGER)S_LOW_HouseOfHope_HopeSpirit06Trigger_e8ff0f5d-45d6-4ff1-8b9e-3ee055e53e29, 1);

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_HouseOfHope_Event_HopeGrantsDisguise_bb82e10f-9c0f-5c16-9f1d-e482d9074ca8, (DIALOGRESOURCE)LOW_HouseOfHope_HopeSpirit01_32a22a1a-6052-0556-509b-a30105e5f4dc);

DB_Dialogs(S_LOW_HopeSpirit_Guide_51baa5f6-1248-499b-acf3-79b6bdd0f6bd, LOW_HouseOfHope_HopeGuide_01f25a3c-7b0c-b5d6-8bbd-19866614639c);

DB_LOW_HouseOfHope_DebtorClothes(1, (ITEM)S_LOW_HouseOfHope_DebtorClothes01_d48eb109-f754-44f3-b298-3a5ecf04fd41);
DB_LOW_HouseOfHope_DebtorClothes(2, (ITEM)S_LOW_HouseOfHope_DebtorClothes02_919cfbec-1921-4ad3-958b-46775410783f);
DB_LOW_HouseOfHope_DebtorClothes(3, (ITEM)S_LOW_HouseOfHope_DebtorClothes03_6149e2e8-59a3-4e05-a9bd-da61e026999e);
DB_LOW_HouseOfHope_DebtorClothes(4, (ITEM)S_LOW_HouseOfHope_DebtorClothes04_c1401f8e-f6a5-4524-a0df-75a99fb289cc);

DB_LOW_HouseOfHope_DebtorClothesCounter(1);

DB_LOW_HouseOfHope_DebtorTemplates(UNI_Camp_Refugee_EternalDebtors_30c5721d-bdc3-4150-8cd1-d99197eb4870);
DB_LOW_HouseOfHope_DebtorTemplates(ARM_Vanity_Prison_EternalDebtors_6f7d15a8-9bcb-45de-94c5-8c77424aaf42);
//END_REGION

//REGION Foyer
DB_LOW_HouseOfHope_SoulPillarsDeactivated((ITEM)S_LOW_HouseOfHope_SoulPillar01_Deactivated_d4b6fdb1-4ae1-46de-8ecf-bd233c2961a2);
DB_LOW_HouseOfHope_SoulPillarsDeactivated((ITEM)S_LOW_HouseOfHope_SoulPillar02_Deactivated_4429842b-620e-4aa9-af5a-d7eb3f9b7f0d);
DB_LOW_HouseOfHope_SoulPillarsDeactivated((ITEM)S_LOW_HouseOfHope_SoulPillar03_Deactivated_fdfb9913-7fcc-4d38-bffc-159f40d25218);
DB_LOW_HouseOfHope_SoulPillarsDeactivated((ITEM)S_LOW_HouseOfHope_SoulPillar04_Deactivated_acd49cc3-0fd7-409e-9f57-aeba48090f12);

DB_OneShot_VoiceBarkTrigger((TRIGGER)S_LOW_HouseOfHope_FoyerBalconyPADTrigger_f46bd401-6667-4b29-a6f6-94237e2f56f9, (VOICEBARKRESOURCE)LOW_HouseOfHope_VB_FoyerBalcony_c4fe3dcb-9dba-bcfb-0549-209309be569a);

PROC_TriggerRegisterForParty((TRIGGER)S_LOW_HouseOfHope_EmperorBlockedPADTrigger_5699e9e8-59f5-43ae-ba8c-ed368708276c);

DB_LOW_HouseOfHope_SoulPillarTriggers((TRIGGER)S_LOW_HouseOfHope_Pillar01Trigger_c2f6bd9a-22ab-4259-a1a7-1b34d34a268d);
DB_LOW_HouseOfHope_SoulPillarTriggers((TRIGGER)S_LOW_HouseOfHope_Pillar02Trigger_23f67625-e8f9-400c-b661-214a214fde6b);
DB_LOW_HouseOfHope_SoulPillarTriggers((TRIGGER)S_LOW_HouseOfHope_Pillar03Trigger_0753ee64-c80d-416b-b933-5863b1a680f9);
DB_LOW_HouseOfHope_SoulPillarTriggers((TRIGGER)S_LOW_HouseOfHope_Pillar04Trigger_4c3de9f8-6f37-42dc-9016-ab0ae6708192);

DB_ItemDialog_NarratorAD((ITEM)S_LOW_HouseOfHope_SoulPillar01_Deactivated_d4b6fdb1-4ae1-46de-8ecf-bd233c2961a2, LOW_HouseOfHope_AD_SoulPillar01_2e042d39-a393-b449-45dd-b365af1aac40);
DB_ItemDialog_NarratorAD((ITEM)S_LOW_HouseOfHope_SoulPillar02_Deactivated_4429842b-620e-4aa9-af5a-d7eb3f9b7f0d, LOW_HouseOfHope_AD_SoulPillar02_3c80adea-b7c1-f37b-f1f8-fe7f66c93b9a);
DB_ItemDialog_NarratorAD((ITEM)S_LOW_HouseOfHope_SoulPillar03_Deactivated_fdfb9913-7fcc-4d38-bffc-159f40d25218, LOW_HouseOfHope_AD_SoulPillar03_47b173b7-7182-4678-aea1-5d5148e978e7);
DB_ItemDialog_NarratorAD((ITEM)S_LOW_HouseOfHope_SoulPillar04_Deactivated_acd49cc3-0fd7-409e-9f57-aeba48090f12, LOW_HouseOfHope_AD_SoulPillar04_a628ef13-5c24-267c-1e87-84eab7bb0994);

PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_HouseOfHope_FoyerRoom_de540d6b-f846-4c74-9f9e-56f49eb36cee);

//END_REGION

//REGION Feast Hall

TriggerRegisterForCharacter((TRIGGER)S_LOW_HouseOfHope_HopePreparesForRaphael_3f1e62fd-6b86-4cfa-b3bc-2e806ecd3297, S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce);

DB_ItemDialog_NarratorAD((ITEM)LOW_HouseOfHope_DeadSkeleton01_fc70c0ce-e582-48a5-8110-766a1163b283, (DIALOGRESOURCE)LOW_HouseOfHope_AD_DeadSkeleton01_ca1a40ad-6a57-abfd-0f43-9328e44d741a);
DB_ItemDialog_NarratorAD((ITEM)LOW_HouseOfHope_DeadSkeleton02_75becd69-1406-4f0e-9e21-39faaeba1700, (DIALOGRESOURCE)LOW_HouseOfHope_AD_DeadSkeleton02_9a9bb744-3f9b-2bb4-17b8-d057f344aac6);
DB_ItemDialog_NarratorAD((ITEM)LOW_HouseOfHope_DeadSkeleton03_09ee58ac-c21d-49db-b533-7a79cffd7af7, (DIALOGRESOURCE)LOW_HouseOfHope_AD_DeadSkeleton03_51423b9a-753e-b7f7-aeb7-b6eac6b2295c);

DB_LOW_HouseOfHope_DeadSkeletons((ITEM)LOW_HouseOfHope_SkeletonChair01_a2549100-fbf6-4c9a-a20e-5f0b5c53ddbd, (ITEM)LOW_HouseOfHope_DeadSkeleton01_fc70c0ce-e582-48a5-8110-766a1163b283);
DB_LOW_HouseOfHope_DeadSkeletons((ITEM)LOW_HouseOfHope_SkeletonChair02_ce04257c-fd5c-486c-906e-0eb152aecca9, (ITEM)LOW_HouseOfHope_DeadSkeleton02_75becd69-1406-4f0e-9e21-39faaeba1700);
DB_LOW_HouseOfHope_DeadSkeletons((ITEM)LOW_HouseOfHope_SkeletonChair03_48151a95-e92d-412e-b064-e27a63c5a8af, (ITEM)LOW_HouseOfHope_DeadSkeleton03_09ee58ac-c21d-49db-b533-7a79cffd7af7);

PROC_SetOnStage(S_LOW_HopeSpirit_LastHope_86a1ce5d-410f-42fc-a4d3-4b604bbc24b2, 0);

DB_Dialogs((CHARACTER)S_LOW_HouseOfHope_Debtor_Mason_7fa2834b-e31e-476a-bb3f-83b935b898e1, (DIALOGRESOURCE)LOW_HouseOfHope_Mason_d57b7bf4-32ae-1092-d64b-3c1a67fb9f51);

//END_REGION

//REGION Archive

DB_Dialogs(S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306, (DIALOGRESOURCE)LOW_HouseOfHope_Archivist_144d4b6a-428c-b650-21a8-cb49dff74aff);

PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_HouseOfHope_ArchiveADTrigger_f066cc2f-5289-492d-862f-69aebf1eff34);
TriggerRegisterForCharacter((TRIGGER)S_LOW_HouseOfHope_ArchiveADTrigger_f066cc2f-5289-492d-862f-69aebf1eff34, (CHARACTER)S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce);
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_HouseOfHope_ArchiveArea_82f690d2-ecd3-4f25-a46b-8d445a06210c);

PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_HouseOfHope_CheckMainTreasuresTrigger_78ff4130-3f04-4b61-900c-d28195a758cf);
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_HouseOfHope_CheckTrappedTreasuresTrigger01_1494ece0-3766-4ea6-8b1d-8385cdc81aec);
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_HouseOfHope_CheckTrappedTreasuresTrigger02_349786bf-287e-44a9-a445-2c988cd9bb00);
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_HouseOfHope_InterruptKorrillaTrigger_1923d441-01dc-4e6e-9533-8de96fce6a7d);

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_HouseOfHope_Event_BurnPlayersContract_bc2878ee-2cf0-b095-3325-53ec41ec023b, (DIALOGRESOURCE)LOW_HouseOfHope_DealWithContract_44b40928-57dd-bea2-922a-923358cdcfce);

DB_GLO_CharacterCorpseDialog((CHARACTER)S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306, (DIALOGRESOURCE)LOW_HouseOfHope_Archivist_SpeakWithDead_5f614148-4d3b-be08-5e03-4382fa446643);

DB_Dialogs(S_LOW_HouseOfHope_SkeletonDebtor01_79d71dfc-854d-4b0a-89e9-c8b834eab689, (DIALOGRESOURCE)LOW_HouseOfHope_SkeletonDebtor01_b5fceaf3-a337-231b-51d5-3c4662c3b939);
DB_Dialogs(S_LOW_HouseOfHope_SkeletonDebtor02_516ff175-6882-48f4-81e3-2198dc63b5a5, (DIALOGRESOURCE)LOW_HouseOfHope_SkeletonDebtor02_b4e74215-c0cd-2aae-a693-09f930cfe412);
DB_Dialogs(S_LOW_HouseOfHope_SkeletonDebtor03_25c91096-cfc4-45e4-b128-e2dda2fde57a, (DIALOGRESOURCE)LOW_HouseOfHope_SkeletonDebtor03_9843436b-eea8-70fd-63a9-be901886378d);
DB_Dialogs(S_LOW_HouseOfHope_SkeletonDebtor04_52b54f46-8ac6-4722-ac26-1e91aaf346d9, (DIALOGRESOURCE)LOW_HouseOfHope_SkeletonDebtor04_5be6f965-ba56-e217-2a20-124353e293ef);

DB_LOW_HouseOfHope_ArchivistIgnoreCrimes((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297);
DB_LOW_HouseOfHope_ArchivistIgnoreCrimes((CHARACTER)S_LOW_HouseOfHope_SkeletonDebtor01_79d71dfc-854d-4b0a-89e9-c8b834eab689);
DB_LOW_HouseOfHope_ArchivistIgnoreCrimes((CHARACTER)S_LOW_HouseOfHope_SkeletonDebtor02_516ff175-6882-48f4-81e3-2198dc63b5a5);
DB_LOW_HouseOfHope_ArchivistIgnoreCrimes((CHARACTER)S_LOW_HouseOfHope_SkeletonDebtor03_25c91096-cfc4-45e4-b128-e2dda2fde57a);
DB_LOW_HouseOfHope_ArchivistIgnoreCrimes((CHARACTER)S_LOW_HouseOfHope_SkeletonDebtor04_52b54f46-8ac6-4722-ac26-1e91aaf346d9);

DB_LOW_HouseOfHope_ArchiveSkeletons(S_LOW_HouseOfHope_SkeletonDebtor01_79d71dfc-854d-4b0a-89e9-c8b834eab689, (DIALOGRESOURCE)LOW_HouseOfHope_AD_SkeletonDebtor01_AfterAlarm_34eef2f1-8618-3471-77b8-f72834e116fa);
DB_LOW_HouseOfHope_ArchiveSkeletons(S_LOW_HouseOfHope_SkeletonDebtor02_516ff175-6882-48f4-81e3-2198dc63b5a5, (DIALOGRESOURCE)LOW_HouseOfHope_AD_SkeletonDebtor02_AfterAlarm_b3d4cd0b-4d1b-20f7-e144-be05a749957a);
DB_LOW_HouseOfHope_ArchiveSkeletons(S_LOW_HouseOfHope_SkeletonDebtor03_25c91096-cfc4-45e4-b128-e2dda2fde57a, NULL_00000000-0000-0000-0000-000000000000);
DB_LOW_HouseOfHope_ArchiveSkeletons(S_LOW_HouseOfHope_SkeletonDebtor04_52b54f46-8ac6-4722-ac26-1e91aaf346d9, (DIALOGRESOURCE)LOW_HouseOfHope_AD_SkeletonDebtor04_AfterAlarm_211fd694-4b49-a796-0cac-f4251b1326e5);

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_HouseOfHope_Event_ArchivistLeft_605964ba-fcd5-a9e5-999d-a08ff5e46c19, (DIALOGRESOURCE)LOW_HouseOfHope_Archivist_144d4b6a-428c-b650-21a8-cb49dff74aff);

PROC_CharacterDisableCrime((CHARACTER)S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306, "KeepAnEyeOnMe");

//END_REGION

//REGION Guards
DB_LOW_HouseOfHope_DebtorsIntoDemons(S_LOW_HouseOfHope_MerregonDebtor01_306e91b1-71af-4b6f-8df7-1e1dab6899d2, S_LOW_HouseOfHope_Merregon01_ba11228c-c75e-4df9-bd55-8091e1d48d36);
DB_LOW_HouseOfHope_DebtorsIntoDemons(S_LOW_HouseOfHope_MerregonDebtor02_b3037a96-9405-43b1-8041-0b928910fcc4, S_LOW_HouseOfHope_NotMerregon02_b8c31050-f17e-46a8-bae6-ac98481e3d5a);
DB_LOW_HouseOfHope_DebtorsIntoDemons(S_LOW_HouseOfHope_MerregonDebtor03_34a70c23-20a8-4aa8-a03d-8ac86b8b8654, S_LOW_HouseOfHope_NotMerregon03_8d08bf81-ae38-4493-8208-a9827fda6a36);
DB_LOW_HouseOfHope_DebtorsIntoDemons(S_LOW_HouseOfHope_MerregonDebtor04_37191419-9d40-495a-b480-a4971a5f7129, S_LOW_HouseOfHope_Merregon04_5e20448a-8824-4f0f-83e8-d31824894c9e);
DB_LOW_HouseOfHope_DebtorsIntoDemons(S_LOW_HouseOfHope_MerregonDebtor05_800614f0-49a8-4b2a-bc9d-50cd80fd72d4, S_LOW_HouseOfHope_Merregon05_f1c77e06-f470-4fdc-b191-3be213f2043f);
DB_LOW_HouseOfHope_DebtorsIntoDemons(S_LOW_HouseOfHope_ImpDebtor01_32c94fae-f910-45e4-a2a6-c0f55ecbbd99, S_LOW_HouseOfHope_Imp01_ad2d83ec-102b-4f92-b98a-5ca981a23421);
DB_LOW_HouseOfHope_DebtorsIntoDemons(S_LOW_HouseOfHope_ImpDebtor02_bd0d230f-fa57-42fb-8e39-858ee093285d, S_LOW_HouseOfHope_Imp02_d41533a3-b1d9-4cd3-b495-5732c989bd25);
DB_LOW_HouseOfHope_DebtorsIntoDemons(S_LOW_HouseOfHope_ImpDebtor03_9c3e4abd-c659-455c-a65f-3cc2307d94d1, S_LOW_HouseOfHope_Imp03_502cb8ab-7c8d-4465-b0cb-abab76da524a);
DB_LOW_HouseOfHope_DebtorsIntoDemons(S_LOW_HouseOfHope_ImpDebtor04_4ef2947c-cd4c-49f4-8be1-7d2240b90e78, S_LOW_HouseOfHope_Imp04_0e3d4128-0bd4-4c05-a6a3-3d654b75043b);
DB_LOW_HouseOfHope_DebtorsIntoDemons(S_LOW_HouseOfHope_FireDebtor01_f790dbe7-021c-4eb1-a7e9-ba172f8eaca9, S_LOW_HouseOfHope_FlamingBoar01_0d1cf2a6-0b56-4c14-83d1-7587e9c8c63c);
DB_LOW_HouseOfHope_DebtorsIntoDemons(S_LOW_HouseOfHope_FireDebtor02_8c149ab1-bb45-4bdc-a9b7-d07b98f9f924, S_LOW_HouseOfHope_FlamingBoar02_82efa3b1-ed21-4569-ac26-65b8a42dde9b);
DB_LOW_HouseOfHope_DebtorsIntoDemons(S_LOW_HouseOfHope_FireDebtor03_bbd649db-111b-4f20-87d0-917827c15252, S_LOW_HouseOfHope_FlamingBoar03_a618f956-d2e8-4108-b5e9-7729286c3993);

DB_Dialogs((CHARACTER)S_LOW_HouseOfHope_MerregonDebtor01_306e91b1-71af-4b6f-8df7-1e1dab6899d2, (DIALOGRESOURCE)LOW_HouseOfHope_MerregonDebtor01_b9b18e76-ab0a-48c2-dbdc-7e95203c8626);
DB_Dialogs((CHARACTER)S_LOW_HouseOfHope_MerregonDebtor02_b3037a96-9405-43b1-8041-0b928910fcc4, (DIALOGRESOURCE)LOW_HouseOfHope_MerregonDebtor02_4b724840-2ff6-73f8-269b-785be248f1a6);
DB_Dialogs((CHARACTER)S_LOW_HouseOfHope_MerregonDebtor03_34a70c23-20a8-4aa8-a03d-8ac86b8b8654, (DIALOGRESOURCE)LOW_HouseOfHope_MerregonDebtor03_d47488ae-829d-e41f-9151-f2ca72b3a288);
DB_Dialogs((CHARACTER)S_LOW_HouseOfHope_MerregonDebtor04_37191419-9d40-495a-b480-a4971a5f7129, (DIALOGRESOURCE)LOW_HouseOfHope_MerregonDebtor04_cac7efec-da6f-94bf-ab4d-4f35249d9f92);
DB_Dialogs((CHARACTER)S_LOW_HouseOfHope_MerregonDebtor05_800614f0-49a8-4b2a-bc9d-50cd80fd72d4, (DIALOGRESOURCE)LOW_HouseOfHope_MerregonDebtor05_d9879e70-a2ad-4e64-4554-2ed9bddeb466);

DB_Dialogs((CHARACTER)S_LOW_HouseOfHope_ImpDebtor01_32c94fae-f910-45e4-a2a6-c0f55ecbbd99, (DIALOGRESOURCE)LOW_HouseOfHope_ImpDebtor01_da499fe0-4c12-431c-9917-eeb37e697f7e);
DB_Dialogs((CHARACTER)S_LOW_HouseOfHope_ImpDebtor02_bd0d230f-fa57-42fb-8e39-858ee093285d, (DIALOGRESOURCE)LOW_HouseOfHope_ImpDebtor02_20f1bb7b-eae8-a1a4-a9d6-b8319c39bbd4);
DB_Dialogs((CHARACTER)S_LOW_HouseOfHope_ImpDebtor03_9c3e4abd-c659-455c-a65f-3cc2307d94d1, (DIALOGRESOURCE)LOW_HouseOfHope_ImpDebtor03_a1c02a0d-7b48-c869-8345-cf57a4dcc754);
DB_Dialogs((CHARACTER)S_LOW_HouseOfHope_ImpDebtor04_4ef2947c-cd4c-49f4-8be1-7d2240b90e78, (DIALOGRESOURCE)LOW_HouseOfHope_ImpDebtor04_32cb4b20-62d4-4cf4-ac9b-983cde40a0b3);

DB_Dialogs(S_LOW_HouseOfHope_FireDebtor01_f790dbe7-021c-4eb1-a7e9-ba172f8eaca9, (DIALOGRESOURCE)LOW_HouseOfHope_FireDebtor01_10342002-3c45-f169-a04c-f13d4d52ae6d);
DB_Dialogs(S_LOW_HouseOfHope_FireDebtor02_8c149ab1-bb45-4bdc-a9b7-d07b98f9f924, (DIALOGRESOURCE)LOW_HouseOfHope_FireDebtor02_68416fe1-649e-70ee-9adf-0eed487c9e3d);
DB_Dialogs(S_LOW_HouseOfHope_FireDebtor03_bbd649db-111b-4f20-87d0-917827c15252, (DIALOGRESOURCE)LOW_HouseOfHope_FireDebtor03_d028c691-41c4-3ff9-ccdd-3c102ec113aa);

// With Archive flow (the main one), I'm setting up all the guards (in whatever form they are now) in their positions, according to the expected path

DB_LOW_HouseOfHope_SetUpAmbush(S_LOW_HouseOfHope_MerregonDebtor01_306e91b1-71af-4b6f-8df7-1e1dab6899d2, (TRIGGER)S_LOW_HouseOfHope_Merregon01AmbushPoint_6bc7e89c-299f-45e0-8c7c-3b64c3710d9b);
DB_LOW_HouseOfHope_SetUpAmbush(S_LOW_HouseOfHope_MerregonDebtor02_b3037a96-9405-43b1-8041-0b928910fcc4, (TRIGGER)S_LOW_HouseOfHope_NotMerregon02AmbushPoint_c5b8b446-b1fd-4a6f-b212-f9ac600e50e4);
DB_LOW_HouseOfHope_SetUpAmbush(S_LOW_HouseOfHope_MerregonDebtor03_34a70c23-20a8-4aa8-a03d-8ac86b8b8654, (TRIGGER)S_LOW_HouseOfHope_NotMerregon03AmbushPoint_50596714-ff4f-4cdf-9d6b-191de01a431d);
DB_LOW_HouseOfHope_SetUpAmbush(S_LOW_HouseOfHope_MerregonDebtor04_37191419-9d40-495a-b480-a4971a5f7129, (TRIGGER)S_LOW_HouseOfHope_Merregon04AmbushPoint_ac28b98e-d437-44b1-b79c-cf0901a3c55d);
DB_LOW_HouseOfHope_SetUpAmbush(S_LOW_HouseOfHope_MerregonDebtor05_800614f0-49a8-4b2a-bc9d-50cd80fd72d4, (TRIGGER)S_LOW_HouseOfHope_Merregon05AmbushPoint_e604aa4f-0c56-416c-b98b-114ebd1bca2d);
DB_LOW_HouseOfHope_SetUpAmbush(S_LOW_HouseOfHope_ImpDebtor01_32c94fae-f910-45e4-a2a6-c0f55ecbbd99, (TRIGGER)S_LOW_HouseOfHope_Imp01AmbushPoint_29df84a1-9fc2-41e7-b758-726eeb54b358);
DB_LOW_HouseOfHope_SetUpAmbush(S_LOW_HouseOfHope_ImpDebtor02_bd0d230f-fa57-42fb-8e39-858ee093285d, (TRIGGER)S_LOW_HouseOfHope_Imp02AmbushPoint_d070049d-0d16-45da-a117-b0bae047bbb0);
DB_LOW_HouseOfHope_SetUpAmbush(S_LOW_HouseOfHope_ImpDebtor03_9c3e4abd-c659-455c-a65f-3cc2307d94d1, (TRIGGER)S_LOW_HouseOfHope_Imp03AmbushPoint_927cd3b4-823d-47ff-bc79-a776d465aca2);
DB_LOW_HouseOfHope_SetUpAmbush(S_LOW_HouseOfHope_ImpDebtor04_4ef2947c-cd4c-49f4-8be1-7d2240b90e78, (TRIGGER)S_LOW_HouseOfHope_Imp04AmbushPoint_f5533e1a-9ec2-49d3-a9a1-f4f2e5cd2613);
DB_LOW_HouseOfHope_SetUpAmbush(S_LOW_HouseOfHope_FireDebtor01_f790dbe7-021c-4eb1-a7e9-ba172f8eaca9, (TRIGGER)S_LOW_HouseOfHope_Fire01AmbushPoint_1e3251e2-0111-47ef-a706-2cb615311944);
DB_LOW_HouseOfHope_SetUpAmbush(S_LOW_HouseOfHope_FireDebtor02_8c149ab1-bb45-4bdc-a9b7-d07b98f9f924, (TRIGGER)S_LOW_HouseOfHope_Fire02AmbushPoint_3c292216-6bee-4959-9b48-bc4ede3e7e9d);
DB_LOW_HouseOfHope_SetUpAmbush(S_LOW_HouseOfHope_FireDebtor03_bbd649db-111b-4f20-87d0-917827c15252, (TRIGGER)S_LOW_HouseOfHope_Fire03AmbushPoint_1128cff5-a163-4e3c-8be5-ea0d11a45e85);

DB_LOW_HouseOfHope_CorridorGuards(S_LOW_HouseOfHope_FireDebtor01_f790dbe7-021c-4eb1-a7e9-ba172f8eaca9);
DB_LOW_HouseOfHope_CorridorGuards(S_LOW_HouseOfHope_FireDebtor03_bbd649db-111b-4f20-87d0-917827c15252);
DB_LOW_HouseOfHope_CorridorGuards(S_LOW_HouseOfHope_ImpDebtor03_9c3e4abd-c659-455c-a65f-3cc2307d94d1);
DB_LOW_HouseOfHope_CorridorGuards(S_LOW_HouseOfHope_ImpDebtor04_4ef2947c-cd4c-49f4-8be1-7d2240b90e78);
DB_LOW_HouseOfHope_CorridorGuards(S_LOW_HouseOfHope_MerregonDebtor04_37191419-9d40-495a-b480-a4971a5f7129);
DB_LOW_HouseOfHope_CorridorGuards(S_LOW_HouseOfHope_MerregonDebtor05_800614f0-49a8-4b2a-bc9d-50cd80fd72d4);

//DB_TrespassTrigger((TRIGGER)S_LOW_HouseOfHope_CrimeTrigger_e5576bab-d1e9-4b26-b5bf-e2f35af5f01b, NULL_00000000-0000-0000-0000-000000000000, "LOW_HouseOfHope_Trespass");

DB_ItemDialog_NarratorAD((ITEM)S_LOW_HouseOfHope_ChamberPot_1ae8201e-bfdc-4624-b38b-8fa3c8d98c40, LOW_HouseOfHope_AD_ChamberPot_bc225249-732b-c427-8b90-e212db221078);

DB_LOW_HouseOfHope_OverrideArrestDialogue((CHARACTER)S_LOW_HouseOfHope_Nubaldin_046f67d9-d477-42d5-8b70-fd0a7911caf4);
DB_LOW_HouseOfHope_OverrideArrestDialogue((CHARACTER)S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306);

//END_REGION

//REGION Treasures

DB_ItemDialog_NarratorAD((ITEM)S_LOW_HouseOfHope_Plaque_Treasure01_252f1bbe-cefd-41c5-b186-53fb09b08cfe, (DIALOGRESOURCE)LOW_HouseOfHope_AD_Treasures01Plaque_8349c5ae-168a-8ff7-9acb-0d9bbe533f93);
DB_ItemDialog_NarratorAD((ITEM)S_LOW_HouseOfHope_Plaque_MainTreasure_e75d92cc-6c08-4545-9861-c064fcc21f13, (DIALOGRESOURCE)LOW_HouseOfHope_AD_Treasures02Plaque_463ed784-6dc5-11e7-e5ca-38a323034905);
DB_ItemDialog_NarratorAD((ITEM)S_LOW_HouseOfHope_Plaque_Treasure05_c9694773-93ca-45a2-874f-fc03c09a2cd0, (DIALOGRESOURCE)LOW_HouseOfHope_AD_Treasures05Plaque_047a3444-1812-45ed-0035-642b4330c9b5);

DB_LOW_HouseOfHope_Treasures((ITEM)S_GLO_OrphicHammer_9013ef0d-c6ee-4137-b17a-c1934079e10d, (TRIGGER)S_LOW_HouseOfHope_MainTreasureTrigger_75627ad8-37b7-4aa9-bc63-92b1f05a40ba,
(ITEM)S_LOW_HouseOfHope_TreasureBlocker_40c7e0ff-b89e-4141-a1bd-7993de1a7fcf);
DB_LOW_HouseOfHope_Treasures((ITEM)S_LOW_HouseOfHope_PlayerContract_69119dc3-2c26-4e50-8430-ef427d05ef7f, (TRIGGER)S_LOW_HouseOfHope_MainTreasureTrigger_75627ad8-37b7-4aa9-bc63-92b1f05a40ba,
(ITEM)S_LOW_HouseOfHope_TreasureBlocker_40c7e0ff-b89e-4141-a1bd-7993de1a7fcf);


DB_LOW_HouseOfHope_TrappedTreasures(S_LOW_HouseOfHope_PressurePlate_Treasure01_1e1c7ec3-1c83-424d-aaac-6a37bb807745, 
"LOW_HouseOfHope_Treasure01PlateOff", 
"LOW_HouseOfHope_Treasure01PlateOn");
DB_LOW_HouseOfHope_TrappedTreasures(S_LOW_HouseOfHope_PressurePlate_Treasure05_32f458fd-2342-428c-8a82-1dfb8c3f8dc8, 
"LOW_HouseOfHope_Treasure05PlateOff", 
"LOW_HouseOfHope_Treasure05PlateOn");


DB_HasItemEvent((ITEM)S_LOW_HouseOfHope_Treasures_Gauntlets_HillGiantStrength_1cb8450d-016f-43d4-bb44-79688170f073, (FLAG)LOW_HouseOfHope_State_HasGauntlets_a0f47ec1-1981-d22e-61ef-8ce8425d9287);

DB_LOW_HouseOfHope_ArchiveTreasures((ITEM)S_LOW_HouseOfHope_Treasures_Gauntlets_HillGiantStrength_1cb8450d-016f-43d4-bb44-79688170f073);
DB_LOW_HouseOfHope_ArchiveTreasures((ITEM)S_LOW_HouseOfHope_Treasures_Amulet_50c4fc37-881c-4ced-9940-7f3757943475);

DB_LOW_HouseOfHope_ArchivistCustomWarningCrime("UseForbiddenItem");
DB_LOW_HouseOfHope_ArchivistCustomWarningCrime("Steal");
DB_LOW_HouseOfHope_ArchivistCustomWarningCrime("Vandalise");
DB_LOW_HouseOfHope_ArchivistCustomWarningCrime("MoveForbiddenItem");
DB_LOW_HouseOfHope_ArchivistCustomWarningCrime("SneakUseForbiddenItem");

DB_LOW_HouseOfHope_ArchivistCallAlarmCrime("VandaliseNoOwner");
DB_LOW_HouseOfHope_ArchivistCallAlarmCrime("Assault");
DB_LOW_HouseOfHope_ArchivistCallAlarmCrime("PickPocketFailed");

//DB_ItemOwnerShipTriggers("CTY_Main_A", (TRIGGER)S_LOW_HouseOfHope_ArchiveArea_82f690d2-ecd3-4f25-a46b-8d445a06210c, (CHARACTER)S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306);

//END_REGION

//REGION Alarm

DB_LOW_HouseOfHope_InfernoTriggers((TRIGGER)S_LOW_HouseOfHope_InfernoTriggerA_f56ae705-de76-44c0-8d10-45777ba78378, 1);
DB_LOW_HouseOfHope_InfernoTriggers((TRIGGER)S_LOW_HouseOfHope_InfernoTriggerB_4a3fc9c7-980a-4042-b610-522cfe521126, 1);
DB_LOW_HouseOfHope_InfernoTriggers((TRIGGER)S_LOW_HouseOfHope_InfernoTriggerC_7dc4476e-0494-44c2-b26a-777406779bf5, 1);
DB_LOW_HouseOfHope_InfernoTriggers((TRIGGER)S_LOW_HouseOfHope_InfernoTriggerCenter_d30a59cb-c8b4-452b-894c-2a868390197d, 1);
DB_LOW_HouseOfHope_InfernoTriggers((TRIGGER)S_LOW_HouseOfHope_InfernoTriggerD_57e38c52-1692-41cc-b8af-90ad53f326c7, 2);
DB_LOW_HouseOfHope_InfernoTriggers((TRIGGER)S_LOW_HouseOfHope_InfernoTriggerE_954d6c41-c67a-456d-a067-84b4131abea4, 2);
DB_LOW_HouseOfHope_InfernoTriggers((TRIGGER)S_LOW_HouseOfHope_InfernoTriggerF_11f45c8a-176c-436e-80ba-0eaead4b31a0, 2);

DB_LOW_HouseOfHope_FlamingSpheres((CHARACTER)S_LOW_HouseOfHope_FlamingSphere01_4cc8ad72-d4f4-434b-8474-b22256c6949e, 1);
DB_LOW_HouseOfHope_FlamingSpheres((CHARACTER)S_LOW_HouseOfHope_FlamingSphere03_17d05a29-c4fe-4260-bf28-7d8f53cc0e0c, 2);

//END_REGION

//REGION Portal Room

DB_Dialogs((CHARACTER)S_LOW_HouseOfHope_RatDebtor_446b2e93-b6d8-4218-95f7-1ab64ac63646, (DIALOGRESOURCE)LOW_HouseOfHope_RatDebtor_ffc4c488-b6c9-b70b-eee0-562f305b30d1);

DB_Dialogs((CHARACTER)S_LOW_HouseOfHope_Nubaldin_046f67d9-d477-42d5-8b70-fd0a7911caf4, (DIALOGRESOURCE)LOW_HouseOfHope_Nubaldin_b887213d-d27b-dd87-56c2-b9e55c8b87d7);


//END_REGION

//REGION Boudoir
TriggerRegisterForItems((TRIGGER)S_LOW_HouseOfHope_PortraitTrapTrigger_8df7081d-834b-40e3-8016-2c4a299fda24);

SetHasDialog(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, 1);

DB_Dialogs(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, (DIALOGRESOURCE)LOW_HouseOfHope_Incubus_8cfa157e-33c6-28d9-96fc-e1aaed1d8006);
DB_DialogBlockAttackButton((DIALOGRESOURCE)LOW_HouseOfHope_Incubus_8cfa157e-33c6-28d9-96fc-e1aaed1d8006);

DB_SpotPlayers((CHARACTER)S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, "HoH_Incubus", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotTrigger((CHARACTER)S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, "HoH_Incubus", (TRIGGER)S_LOW_HouseOfHope_IncubusTrigger_fcf4e5c9-6404-410e-ba64-a81b0726f62a);
PROC_TriggerRegisterForParty((TRIGGER)S_LOW_HouseOfHope_IncubusTrigger_Room_1797390e-7d4b-4e16-862e-d3eed5162549);

DB_HasItemEvent((ITEM)S_LOW_HouseOfHope_SoulVesselKey_0519bffd-55d0-47be-a39f-d24f10260b56, (FLAG)LOW_HouseOfHope_State_HasSoulVesselKey_b1fddcec-e7b8-edd9-89b2-1c996a1546f1); 
DB_GiveItemToEvent((ITEM)S_LOW_HouseOfHope_SoulVesselKey_0519bffd-55d0-47be-a39f-d24f10260b56, (FLAG)LOW_HouseOfHope_State_GiveSoulVesselKey_fc97e054-58e6-de9b-51d7-b5c4f3f02984);

DB_LOW_HouseOfHope_BoudoirImps((CHARACTER)S_LOW_HouseOfHope_BoudoirImp01_4a793e6c-572c-4541-a10e-ce75b1e62255, (TRIGGER)S_LOW_HouseOfHope_BoudoirImp01Entrance_e6d7ec0d-a7b5-44ff-9090-b5b64e1954f3,
(TRIGGER)S_LOW_HouseOfHope_BoudoirImp01Place_9a21a54a-2d2a-4f0e-ba01-ad7706a6c609, (TRIGGER)S_LOW_HouseOfHope_ImpExit01_423b9446-f7e0-48fe-baf4-42eda252c3ad);
DB_LOW_HouseOfHope_BoudoirImps((CHARACTER)S_LOW_HouseOfHope_BoudoirImp02_5849cd14-4f4a-4742-bb0c-056c3ef7f90e, (TRIGGER)S_LOW_HouseOfHope_BoudoirImp02Entrance_7a6ea1a8-8302-4edb-ab44-84c3587cdf18,
(TRIGGER)S_LOW_HouseOfHope_BoudoirImp02Place_2bee974d-9ae6-4f26-9e03-7b7c1488ed44, (TRIGGER)S_LOW_HouseOfHope_ImpExit01_423b9446-f7e0-48fe-baf4-42eda252c3ad);
DB_LOW_HouseOfHope_BoudoirImps((CHARACTER)S_LOW_HouseOfHope_BoudoirImp03_4adcf56c-e1cc-4441-8e3f-0761172407d4, (TRIGGER)S_LOW_HouseOfHope_BoudoirImp03Entrance_5cde5ac2-2b48-4056-ae8b-e2240bbfca3d,
(TRIGGER)S_LOW_HouseOfHope_BoudoirImp03Place_1cbbabc4-bffb-4c39-8742-1591fb4722ce, (TRIGGER)S_LOW_HouseOfHope_ImpExit02_7ca9d750-810e-4950-906a-1c17fc95d03c);
DB_LOW_HouseOfHope_BoudoirImps((CHARACTER)S_LOW_HouseOfHope_BoudoirImp04_55c88dba-6d2d-4082-b5dc-be1590c0e326, (TRIGGER)S_LOW_HouseOfHope_BoudoirImp04Entrance_687029b8-247a-478a-a89f-ad8a1db89486,
(TRIGGER)S_LOW_HouseOfHope_BoudoirImp04Place_100b57d0-76db-44ec-bc1a-fb1fbdab7bbf, (TRIGGER)S_LOW_HouseOfHope_ImpExit02_7ca9d750-810e-4950-906a-1c17fc95d03c);
DB_LOW_HouseOfHope_BoudoirImps((CHARACTER)S_LOW_HouseOfHope_BoudoirImp05_5ceed225-db6e-4652-bd4b-88c250550193, (TRIGGER)S_LOW_HouseOfHope_BoudoirImp05Entrance_e8fdc496-16ed-426a-be50-c9a3041f86fe,
(TRIGGER)S_LOW_HouseOfHope_BoudoirImp05Place_8fc0f671-4761-46b0-ab8a-491205668d1e, (TRIGGER)S_LOW_HouseOfHope_ImpExit02_7ca9d750-810e-4950-906a-1c17fc95d03c);
DB_LOW_HouseOfHope_BoudoirImps((CHARACTER)S_LOW_HouseOfHope_BoudoirImp06_3a9e98f5-fe4c-46b2-a129-1e67fe92512b, (TRIGGER)S_LOW_HouseOfHope_BoudoirImp06Entrance_7d190d9a-a130-42f4-a984-4a22f775caed,
(TRIGGER)S_LOW_HouseOfHope_BoudoirImp06Place_f94c1273-1a42-4f28-8d17-4255b450c8ce, (TRIGGER)S_LOW_HouseOfHope_ImpExit01_423b9446-f7e0-48fe-baf4-42eda252c3ad);

DB_GLO_CharacterCorpseDialog((CHARACTER)S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, (DIALOGRESOURCE)LOW_HouseOfHope_Incubus_SpeakWithDead_b0f1db1d-b5f5-3013-d615-fd151db853b5);

RemoveTransforms(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26);

SetCombatGroupID((CHARACTER)S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, "LOW_HouseOfHope_BoudoirGroup");

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_HouseOfHope_Event_IncubusLeft_aa307994-517c-f21a-e85c-37b6c4ef3062, (DIALOGRESOURCE)LOW_HouseOfHope_Incubus_8cfa157e-33c6-28d9-96fc-e1aaed1d8006);
DB_FlagReactionAfterDialog((FLAG)LOW_HouseOfHope_Event_IncubusTakesMind_5ead8df3-e706-7997-64cd-7cd059466490, (DIALOGRESOURCE)LOW_HouseOfHope_Incubus_8cfa157e-33c6-28d9-96fc-e1aaed1d8006);

DB_HasItemEvent((ITEM)S_LOW_HouseOfHope_BoudoirKey_b54922ae-91cd-4cc4-b9bf-4de932ee5b8c, (FLAG)LOW_HouseOfHope_State_HasBoudoirKey_7ae2dc78-5a8e-8ce3-8047-5b4180004c70); 
DB_GiveItemToEvent((ITEM)S_LOW_HouseOfHope_BoudoirKey_b54922ae-91cd-4cc4-b9bf-4de932ee5b8c, (FLAG)LOW_HouseOfHope_State_GiveBoudoirKey_d50501cb-c202-cfe2-77db-679f1912c60b);

DB_OneShot_ADTrigger((TRIGGER)S_LOW_HouseOfHope_BoudoirInvitationAnnouncement_3cf51e0b-de34-433f-a1f5-6c4f503ff938, (DIALOGRESOURCE)LOW_HouseOfHope_AD_BoudoirField_34259422-3379-7b05-dba3-c3dca075ad7e, (ITEM)S_LOW_HouseOfHope_MagicFieldSpeaker_c4618af3-7712-42c1-9126-8a77f4f29d9d);

PROC_SetOnStage(S_LOW_HouseOfHope_SoulVesselSafe_adb5581e-b1cf-4d3e-9ace-5c75adfa2f47, 0);
PROC_SetOnStage((ITEM)S_LOW_HouseOfHope_RaphaelVaultPortrait_Untrapped_bff88066-6679-4d1b-b908-2d57d4062ba9, 0);

DB_LOW_HouseOfHope_MasterKeywordNotes((ITEM)S_LOW_HouseOfHope_MasterKeyword_dcd74338-b779-4387-9748-8f8a2b29230e);
DB_LOW_HouseOfHope_MasterKeywordNotes((ITEM)S_LOW_HouseOfHope_MasterKeyword_AfterDeal_8057c70c-21b8-4cb7-8926-c92a2c40df3c);

PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_HouseOfHope_BoudoirDebtorWarning_0072d2ef-4a19-4d63-880d-518818148110);

DB_LOW_HouseOfHope_BoudoirImpsAfterAlarm((CHARACTER)S_LOW_HouseOfHope_BoudoirImp01_4a793e6c-572c-4541-a10e-ce75b1e62255, (TRIGGER)S_LOW_HouseOfHope_BoudoirImp01Entrance_e6d7ec0d-a7b5-44ff-9090-b5b64e1954f3,
(TRIGGER)S_LOW_HouseOfHope_BoudoirImp01Alarm_74077a46-a1cf-487a-8c81-2b6b39ebfa55);
DB_LOW_HouseOfHope_BoudoirImpsAfterAlarm((CHARACTER)S_LOW_HouseOfHope_BoudoirImp02_5849cd14-4f4a-4742-bb0c-056c3ef7f90e, (TRIGGER)S_LOW_HouseOfHope_BoudoirImp02Entrance_7a6ea1a8-8302-4edb-ab44-84c3587cdf18,
(TRIGGER)S_LOW_HouseOfHope_BoudoirImp02Alarm_62892758-7313-481a-90cf-dc5794a08f43);
DB_LOW_HouseOfHope_BoudoirImpsAfterAlarm((CHARACTER)S_LOW_HouseOfHope_BoudoirImp03_4adcf56c-e1cc-4441-8e3f-0761172407d4, (TRIGGER)S_LOW_HouseOfHope_BoudoirImp03Entrance_5cde5ac2-2b48-4056-ae8b-e2240bbfca3d,
(TRIGGER)S_LOW_HouseOfHope_BoudoirImp03Alarm_d03f20fb-e02e-4bac-bba9-9ba1e994f6b0);
DB_LOW_HouseOfHope_BoudoirImpsAfterAlarm((CHARACTER)S_LOW_HouseOfHope_BoudoirImp04_55c88dba-6d2d-4082-b5dc-be1590c0e326, (TRIGGER)S_LOW_HouseOfHope_BoudoirImp04Entrance_687029b8-247a-478a-a89f-ad8a1db89486,
(TRIGGER)S_LOW_HouseOfHope_BoudoirImp04Alarm_2ba1401e-d9ca-442e-a894-31696e6d984a);
DB_LOW_HouseOfHope_BoudoirImpsAfterAlarm((CHARACTER)S_LOW_HouseOfHope_BoudoirImp05_5ceed225-db6e-4652-bd4b-88c250550193, (TRIGGER)S_LOW_HouseOfHope_BoudoirImp05Entrance_e8fdc496-16ed-426a-be50-c9a3041f86fe,
(TRIGGER)S_LOW_HouseOfHope_BoudoirImp05Alarm_bea84acf-261d-4142-877c-6757d93d89e8);
DB_LOW_HouseOfHope_BoudoirImpsAfterAlarm((CHARACTER)S_LOW_HouseOfHope_BoudoirImp06_3a9e98f5-fe4c-46b2-a129-1e67fe92512b, (TRIGGER)S_LOW_HouseOfHope_BoudoirImp06Entrance_7d190d9a-a130-42f4-a984-4a22f775caed,
(TRIGGER)S_LOW_HouseOfHope_BoudoirImp06Alarm_66db3bad-0546-4e09-a26c-4342cfbd7634);

// Master Keyword shielding

DB_LOW_HouseOfHope_PlayerContainers((ROOT)CONT_PlayerCampChest_A_96eab9d1-74b1-42f7-b1ad-061a9fcea8c4);
DB_LOW_HouseOfHope_PlayerContainers((ROOT)CONT_PlayerCampChest_B_f68b5862-887c-4adf-b9f8-bb29e4d73b0f);
DB_LOW_HouseOfHope_PlayerContainers((ROOT)CONT_PlayerCampChest_C_b5de2260-8e6b-4c2f-91eb-6f3133682a2f);
DB_LOW_HouseOfHope_PlayerContainers((ROOT)CONT_PlayerCampChest_D_9b293d36-29f0-460c-bc81-2bdd4610a478);

//END_REGION

//REGION Prison

DB_GLO_DefeatCounter((CHARACTER)S_LOW_HouseOfHope_PrisonSpectator01_d92a207c-874a-4409-9cad-4abcec33efa1, "LOW_HouseOfHope_PrisonCombat");
DB_GLO_DefeatCounter((CHARACTER)S_LOW_HouseOfHope_PrisonSpectator02_9089024f-e275-43a9-adec-f0923fab2f0c, "LOW_HouseOfHope_PrisonCombat");
DB_GLO_DefeatCounter((CHARACTER)S_LOW_HouseOfHope_Prison_Imp_000_7f9717a3-16c6-4323-9976-a31d27e36495, "LOW_HouseOfHope_PrisonCombat");
DB_GLO_DefeatCounter((CHARACTER)S_LOW_HouseOfHope_Prison_Imp_001_74282535-2053-4a8d-98ff-6413ea2136dd, "LOW_HouseOfHope_PrisonCombat");
DB_GLO_DefeatCounter((CHARACTER)S_LOW_HouseOfHope_Prison_Imp_002_095fbaa2-51c3-47fe-8626-22f28f1bece8, "LOW_HouseOfHope_PrisonCombat");
DB_GLO_DefeatCounter((CHARACTER)S_LOW_HouseOfHope_Prison_Imp_003_b5d6b288-45d1-497b-8339-cead5e16133d, "LOW_HouseOfHope_PrisonCombat");
DB_GLO_DefeatCounter((CHARACTER)S_LOW_HouseOfHope_Prison_Imp_004_401761d3-a021-4a8a-968f-85c7e7e8675c, "LOW_HouseOfHope_PrisonCombat");


DB_LOW_HouseOfHope_HopeChains(LOW_HouseOfHope_HopeChain01_72fe50a0-0e3d-44f5-ab1b-b1789984a0ff);
DB_LOW_HouseOfHope_HopeChains(LOW_HouseOfHope_HopeChain02_9961735c-df6f-4146-bbae-7d778f8e96c5);
PROC_CharacterDisableAllCrimes((CHARACTER)S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce);

DB_AD_Dialog(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, (DIALOGRESOURCE)LOW_HouseOfHope_AD_RescueHope_ea00162c-9e0a-fea2-cc97-f969eae279b8);

DB_LOW_HouseOfHope_PrisonButtons((ITEM)S_LOW_HouseOfHope_PrisonDoorButton_74f9b2b5-204c-4f8c-9fef-499c67ab3ac0);
DB_LOW_HouseOfHope_PrisonButtons((ITEM)S_LOW_HouseOfHope_PrisonDoorButton02_4c8ad2ce-685a-4afc-9de2-e2f259f9b214);

//END_REGION

//REGION Raphael's arrival
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)LOW_HouseOfHope_RaphaelAppearance_d48628c9-ac3a-6fe8-2312-a856f1a1f9fa, (TRIGGER)S_LOW_HouseOfHope_RaphaelDialogArea_3a225d44-7df9-4f80-baa9-9de20e204e94, 1);
DB_DialogBlockAttackButton((DIALOGRESOURCE)LOW_HouseOfHope_RaphaelAppearance_d48628c9-ac3a-6fe8-2312-a856f1a1f9fa);

PROC_SetOnStage(S_LOW_HouseOfHope_RaphaelCambion01_4535facb-487c-4ab8-82e2-0f28558a7d16, 0);
PROC_SetOnStage(S_LOW_HouseOfHope_RaphaelCambion02_3164499e-24cd-4417-baca-5f057b4d9518, 0);
PROC_SetOnStage(S_LOW_HouseOfHope_RaphaelCambion03_abc96d0e-846e-4986-ae72-39befabb128b, 0);
PROC_SetOnStage(S_LOW_HouseOfHope_RaphaelCambion04_25c6573c-acb8-437f-9fcf-81a80c56f540, 0);
PROC_SetOnStage(S_LOW_HouseOfHope_RaphaelCambion05_f7b77fc8-d732-4cf7-a541-34d16ad01dc6, 0);
PROC_SetOnStage(S_LOW_HouseOfHope_RaphaelCambion06_c9c4475f-a2e7-43d6-8df9-de081fef3f89, 0);

SetFaction(S_LOW_HouseOfHope_RaphaelCambion01_4535facb-487c-4ab8-82e2-0f28558a7d16, (FACTION)Act3_LOW_HouseOfHope_Raphael_65b207f5-756f-4980-ace1-b418ed8f477b);
SetFaction(S_LOW_HouseOfHope_RaphaelCambion02_3164499e-24cd-4417-baca-5f057b4d9518, (FACTION)Act3_LOW_HouseOfHope_Raphael_65b207f5-756f-4980-ace1-b418ed8f477b);
SetFaction(S_LOW_HouseOfHope_RaphaelCambion03_abc96d0e-846e-4986-ae72-39befabb128b, (FACTION)Act3_LOW_HouseOfHope_Raphael_65b207f5-756f-4980-ace1-b418ed8f477b);
SetFaction(S_LOW_HouseOfHope_RaphaelCambion04_25c6573c-acb8-437f-9fcf-81a80c56f540, (FACTION)Act3_LOW_HouseOfHope_Raphael_65b207f5-756f-4980-ace1-b418ed8f477b);
SetFaction(S_LOW_HouseOfHope_RaphaelCambion05_f7b77fc8-d732-4cf7-a541-34d16ad01dc6, (FACTION)Act3_LOW_HouseOfHope_Raphael_65b207f5-756f-4980-ace1-b418ed8f477b);
SetFaction(S_LOW_HouseOfHope_RaphaelCambion06_c9c4475f-a2e7-43d6-8df9-de081fef3f89, (FACTION)Act3_LOW_HouseOfHope_Raphael_65b207f5-756f-4980-ace1-b418ed8f477b);

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_HouseOfHope_Event_RaphaelTakesSouls_b6c5a114-61bf-4e20-a197-7cf328f1debc, (DIALOGRESOURCE)LOW_HouseOfHope_RaphaelAppearance_d48628c9-ac3a-6fe8-2312-a856f1a1f9fa);

//END_REGION

//REGION Raphael's Postmortem
DB_GLO_DefeatCounter(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "LOW_HouseOfHope_RaphaelCombat");
DB_GLO_DefeatCounter(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, "LOW_HouseOfHope_RaphaelCombat");
DB_GLO_DefeatCounter(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "LOW_HouseOfHope_RaphaelCombat");
DB_GLO_DefeatCounter(S_LOW_HouseOfHope_RaphaelCambion01_4535facb-487c-4ab8-82e2-0f28558a7d16, "LOW_HouseOfHope_RaphaelCombat");
DB_GLO_DefeatCounter(S_LOW_HouseOfHope_RaphaelCambion02_3164499e-24cd-4417-baca-5f057b4d9518, "LOW_HouseOfHope_RaphaelCombat");
DB_GLO_DefeatCounter(S_LOW_HouseOfHope_RaphaelCambion03_abc96d0e-846e-4986-ae72-39befabb128b, "LOW_HouseOfHope_RaphaelCombat");
DB_GLO_DefeatCounter(S_LOW_HouseOfHope_RaphaelCambion04_25c6573c-acb8-437f-9fcf-81a80c56f540, "LOW_HouseOfHope_RaphaelCombat");
DB_GLO_DefeatCounter(S_LOW_HouseOfHope_RaphaelCambion05_f7b77fc8-d732-4cf7-a541-34d16ad01dc6, "LOW_HouseOfHope_RaphaelCombat");
DB_GLO_DefeatCounter(S_LOW_HouseOfHope_RaphaelCambion06_c9c4475f-a2e7-43d6-8df9-de081fef3f89, "LOW_HouseOfHope_RaphaelCombat");

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_HouseOfHope_Event_OrthonLeaves_21f49b19-2a45-72b1-fbb7-ce817ce8a1cc, (DIALOGRESOURCE)LOW_HouseOfHope_YurgirFarewell_039f4bc4-ad64-ef77-9172-eaca8b30bcfd);

NOT DB_ForceRemoveKnockedOutCharacterOnLongRest((CHARACTER)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c); // Clear from DB set in act 2.
RemoveStatus(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, "PEACEFUL_RESOLUTION_XP"); // Remove peaceful resolution status from act 2
//END_REGION

//REGION Raphael combat support

DB_LOW_HouseOfHope_SoulPillars((ITEM)S_LOW_HouseOfHope_SoulPillar01_0399eb55-9d1f-4f70-ba13-7e787ec1774e);
DB_LOW_HouseOfHope_SoulPillars((ITEM)S_LOW_HouseOfHope_SoulPillar02_2d9682b6-4f76-40f4-aa42-991b7cc39dbf);
DB_LOW_HouseOfHope_SoulPillars((ITEM)S_LOW_HouseOfHope_SoulPillar03_ed055224-c364-41ca-87ea-2a1a4f8ff575);
DB_LOW_HouseOfHope_SoulPillars((ITEM)S_LOW_HouseOfHope_SoulPillar04_470399e2-4ae4-471e-bb0f-c5e87b2e8b7e);

DB_LOW_HouseOfHope_RaphaelBeastStatuses(1, "LOW_RAPHAEL_PILLAR_STATUS_VISUAL_3");
DB_LOW_HouseOfHope_RaphaelBeastStatuses(2, "LOW_RAPHAEL_PILLAR_STATUS_VISUAL_2");
DB_LOW_HouseOfHope_RaphaelBeastStatuses(3, "LOW_RAPHAEL_PILLAR_STATUS_VISUAL_1");
DB_LOW_HouseOfHope_RaphaelBeastStatuses(4, "LOW_RAPHAEL_NO_PILLARS");

//END_REGION

//REGION Save Hope journal

// NO DEAL flow
DB_QuestDef_State_ConditionalFlag((FLAG)LOW_HouseOfHope_Event_AgreedToHelpHope_525e29e1-58c6-2320-aba9-832d0ca8ff33, "LOW_SaveHope", "MetHope_NoDeal", 0, (FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc);
DB_QuestDef_State((FLAG)LOW_HouseOfHope_State_HammerIsStolen_1b248e8d-fef1-4671-aa55-afd0e34c2682, "LOW_SaveHope", "StoleHammer");

// MADE DEAL flow
DB_QuestDef_State_ConditionalFlag((FLAG)LOW_HouseOfHope_Event_AgreedToHelpHope_525e29e1-58c6-2320-aba9-832d0ca8ff33, "LOW_SaveHope", "MetHope_MadeDeal", 1, (FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc);
DB_QuestDef_State_ConditionalFlag((FLAG)LOW_HouseOfHope_State_ContractIsDestroyed_1a51a77c-d549-4d50-95df-97ab9d1ef9f6, "LOW_SaveHope", "GotContract", 0, (FLAG)LOW_HouseOfHope_Event_HopeRescued_119342c6-2a7b-8c90-e96e-3f3a5930e91a);
DB_QuestDef_State_ConditionalFlag((FLAG)LOW_HouseOfHope_State_ContractIsDestroyed_1a51a77c-d549-4d50-95df-97ab9d1ef9f6, "LOW_SaveHope", "GotContract_HopeFreed", 1, (FLAG)LOW_HouseOfHope_Event_HopeRescued_119342c6-2a7b-8c90-e96e-3f3a5930e91a);

// Save Hope flow

DB_QuestDef_State((FLAG)LOW_HouseOfHope_Event_HopeRescued_119342c6-2a7b-8c90-e96e-3f3a5930e91a, "LOW_SaveHope", "SmashedChains");
DB_QuestDef_State_ConditionalFlag((FLAG)LOW_HouseOfHope_HasMet_SavedHope_4950dfa2-a3c8-0e84-393c-2f2d8f2c29a4, "LOW_SaveHope", "TalkedToHope_GetOut", 1, (FLAG)LOW_HouseOfHope_State_PlayersStoleMainTreasure_ffa3d3be-d30f-296f-d794-4c24d63eb25c);
DB_QuestDef_State((FLAG)LOW_HouseOfHope_Event_HopeInspirationPoints_0994faa0-e857-be17-0028-20702daa7cec, "LOW_SaveHope", "SaidGoodbye");

DB_GlobalFlagReactionAfterDialog((FLAG)LOW_HouseOfHope_PrisonHopeSpirit_MetHopeInPrison_8a9e613b-17c5-0e19-be92-3de3960fe365, (DIALOGRESOURCE)LOW_HouseOfHope_HopeSpirit_Prison_33f61440-9fb9-b8d3-270b-0dc0aa8a9792);
DB_GlobalFlagReactionAfterDialog((FLAG)LOW_HouseOfHope_Event_HopeInspirationPoints_0994faa0-e857-be17-0028-20702daa7cec, (DIALOGRESOURCE)LOW_HouseOfHope_Hope_789e111a-7402-9ea0-feca-7106a0889675);

DB_QuestDef_PermaDefeatedState("LOW_SaveHope", "HopeDefeated", S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce);

DB_QuestDef_LevelLoaded("LOW_SaveHope", "HopeLost", "END_Main");

DB_LOW_HouseOfHope_ShouldUpdatePrisonMarker(1);

//END_REGION

//REGION Topical greetings
DB_TopicalGreeting((FLAG)TG_LOW_InHouseOfHope_55d9e556-3466-41ec-83c5-bcbafa5efdc0);
DB_TopicalGreetingEndCondition_LeaveTriggerSet((FLAG)TG_LOW_InHouseOfHope_55d9e556-3466-41ec-83c5-bcbafa5efdc0, "LOW_HouseOfHope");

DB_TopicalGreeting((FLAG)TG_LOW_RaphaelDefeated_ae4475b6-f303-4187-844b-903bd40d616f);
DB_TopicalGreetingEndCondition_LongRest((FLAG)TG_LOW_RaphaelDefeated_ae4475b6-f303-4187-844b-903bd40d616f);

//END_REGION

//REGION Raphael combat ADs

DB_CombatReact_AD_OnTurn(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, (DIALOGRESOURCE)LOW_HouseOfHope_AD_Raphael_Combat_01_4eac94fe-9aca-5490-0647-aa5c4a6b7f76, 1);
DB_CombatReact_AD_OnTurn(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, (DIALOGRESOURCE)LOW_HouseOfHope_AD_Raphael_Combat_02_60c51b15-3a94-c936-d8d4-4b2d5473b8d0, 2);

DB_LOW_HouseOfHope_SetNextTurnAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_Raphael_Combat_03_622a9ba3-c499-7d53-951e-584bd2fce4ce);
DB_LOW_HouseOfHope_SetNextTurnAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_Raphael_Combat_04_0ea07bd7-37e0-db29-1eac-c208cf2b2279);
DB_LOW_HouseOfHope_SetNextTurnAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_Raphael_Combat_05_98bde6f7-9f53-3bba-bfe8-7ef42b5de416);

DB_CombatReact_AD_OnCast(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, (DIALOGRESOURCE)LOW_HouseOfHope_AD_Raphael_Combat_SoulWithdrawal_329b2d03-bc18-c410-d63d-9b302c3caa4e, "Target_LOW_Raphael_SoulWithdrawal");

DB_CombatReact_AD_StatusRemoved(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, (DIALOGRESOURCE)LOW_HouseOfHope_AD_Raphael_Combat_BackToCambion_68830383-3a1d-fb43-8ba0-984ef6515771, "LOW_RAPHAEL_MONSTER_FORM");

DB_CombatReact_AD_OnCast(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, (DIALOGRESOURCE)LOW_HouseOfHope_AD_Raphael_Combat_PermanentBeast_d25f2234-a9c0-589c-f4cd-f99ee2714a97, "Shout_LOW_Raphael_Transform_4");
DB_CombatReact_AD_OnCast(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, (DIALOGRESOURCE)LOW_HouseOfHope_AD_Raphael_Combat_RadiantReaction_81494b51-cd3b-7fea-fc8a-7957a0fafefc, "Target_LOW_Raphael_RepelDivinity_Spell");
DB_CombatReact_AD_OnCast(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, (DIALOGRESOURCE)LOW_HouseOfHope_AD_Raphael_Combat_HealthStolen_fd519fe8-ce34-e1b5-7c59-85a6ef3b27b8, "Target_LOW_Raphael_RepelDivinity_SoulDrain");

//END_REGION

//REGION Incubus followup

DB_LOW_HouseOfHope_IncubusFollowupTriggers((TRIGGER)S_LOW_Elfsong_IncubusFollowupTrigger_d2536e05-0a80-4243-84a5-7a79742e8099);
DB_LOW_HouseOfHope_IncubusFollowupTriggers((TRIGGER)S_LOW_BlushingMermaid_IncubusFollowupTrigger_e4562d69-5821-4d18-8734-372dd74ce214);
DB_LOW_HouseOfHope_IncubusFollowupTriggers((TRIGGER)S_LOW_BasiliskGate_IncubusFollowupTrigger_df574282-5e85-455d-8dbd-0e798ccbd6e2);
DB_LOW_HouseOfHope_IncubusFollowupTriggers((TRIGGER)S_LOW_SorcerousSundries_Square_IncubusFollowupTrigger_667cf524-3218-4163-91c2-1e5fc8e31737);

//END_REGION
KBSECTION
//REGION DEBUG

IF
TextEvent("LOW_HOH_KorrillaInArchive")
THEN
SetFlag((FLAG)GLO_Warlock_State_ShouldAppearInArchive_aaf145de-d32f-47f9-9334-49697509b561);

IF
TextEvent("LOW_HOH_RaphaelPostmortem")
THEN
Die((CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, DEATHTYPE.Incinerate, NULL_00000000-0000-0000-0000-000000000000, 0, 1);
PROC_LOW_HouseOfHope_Postmortem();

IF
TextEvent("LOW_HOH_TestCopy")
AND
GetHostCharacter(_Player)
THEN
Transform((CHARACTER)S_LOW_HouseOfHope_IncubusTransformedIntoPlayer_c416cf25-0538-48eb-a504-427b98aeaec8, _Player, (SHAPESHIFTRULE)DisguiseWithCustomLooksKeepNameAndIcon_b40d9ab4-57a7-4632-b8d7-188904b00606);
TeleportTo((CHARACTER)S_LOW_HouseOfHope_IncubusTransformedIntoPlayer_c416cf25-0538-48eb-a504-427b98aeaec8, _Player);

IF
TextEvent("LOW_HOH_TestSuccubus")
AND
GetHostCharacter(_Player)
THEN
TeleportTo(S_LOW_HouseOfHope_Succubus_6060f41a-0d78-471e-89a6-4ef41d46ce6d, _Player,"");
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_SuccubusCallsForHelp_cd5b00f6-9e1c-1c4a-ed7d-4763c6729c68, S_LOW_HouseOfHope_Succubus_6060f41a-0d78-471e-89a6-4ef41d46ce6d);

IF
TextEvent("LOW_HOH_TestIncubus")
AND
GetHostCharacter(_Player)
THEN
TeleportTo(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, _Player, "LOW_HOH_TestSuccubus");

IF
EntityEvent(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, "LOW_HOH_TestSuccubus")
THEN
Transform(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26,(CHARACTERROOT)QUEST_LOW_HouseOfHope_Incubus_FemaleForm_14ac9a0f-02ab-422f-b848-069c717d4203,
(SHAPESHIFTRULE)LOW_HoH_Incubus_eac6b9bf-e895-4675-887c-1acca6e3fcb9); 
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_SuccubusCallsForHelp_cd5b00f6-9e1c-1c4a-ed7d-4763c6729c68, S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26);

IF
TextEvent("LOW_HOH_TestDebtor")
AND
GetHostCharacter(_Player)
THEN
ToInventory((ITEM)S_LOW_HouseOfHope_TestClothes_d48eb109-f754-44f3-b298-3a5ecf04fd41, _Player, 1, 0, 1);
Equip(_Player, (ITEM)S_LOW_HouseOfHope_TestClothes_d48eb109-f754-44f3-b298-3a5ecf04fd41, 0, 0, 0);
PROC_SetArmourSet(_Player, ARMOURSET.Vanity);

IF
TextEvent("LOW_HOH_DisableInferno")
THEN
DB_LOW_HouseOfHope_DisableInferno(1);

IF
TextEvent("LOW_HOH_DisableInferno")
AND
DB_LOW_HouseOfHope_DebtorsIntoDemons(_Debtor, _)
THEN
PROC_SetOnStage(_Debtor, 0);

IF
TextEvent("LOW_HOH_TestInferno")
AND
GetHostCharacter(_Player)
THEN
TeleportTo(_Player, S_LOW_HouseOfHope_HopeAlarmTrigger_a74b17a0-2343-46c8-b992-0af963fb13a8, "LOW_HOH_TestInferno", 1, 1, 1, 1, 1);

IF 
EntityEvent(_Player, "LOW_HOH_TestInferno")
THEN
ToInventory((ITEM)S_GLO_OrphicHammer_9013ef0d-c6ee-4137-b17a-c1934079e10d,_Player,1,1,1);
SetFlag((FLAG)LOW_HouseOfHope_State_PlayersStoleMainTreasure_ffa3d3be-d30f-296f-d794-4c24d63eb25c);
SetFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe);

IF
TextEvent("LOW_HOH_CallRaphael")
AND
GetHostCharacter(_Player)
THEN
ToInventory((ITEM)S_GLO_OrphicHammer_9013ef0d-c6ee-4137-b17a-c1934079e10d,_Player,1,1,1);
SetFlag((FLAG)LOW_HouseOfHope_State_PlayersStoleMainTreasure_ffa3d3be-d30f-296f-d794-4c24d63eb25c);
SetFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe);

IF
TextEvent("LOW_HOH_EasyRaphael")
AND
GetHostCharacter(_Player)
THEN
LoadPartyPreset("Level12_Rogue_Fighter_Cleric_Wizard", _Player);
SetFlag(SHA_LastJusticiar_State_KilledJusticiar_95b1ac4a-c978-3288-a192-d294b70229c4);
SetFlag((FLAG)SHA_Orthon_State_ContractEnded_26c35edd-3617-82b3-b4d7-1b7bb6410485);
SetFlag((FLAG)SHA_OrthonLair_Knows_Orthon_84ce6c40-0906-afae-0b6a-1df4625fa9d3);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_HouseOfHope_Orthon_905611e9-4399-47e3-a576-aaa840ab1724, 100);
PROC_SetRelationMutual((FACTION)Act3_LOW_HouseOfHope_Orthon_905611e9-4399-47e3-a576-aaa840ab1724,(FACTION)Act3_LOW_HouseOfHope_Raphael_65b207f5-756f-4980-ace1-b418ed8f477b,50);
ClearFlag((FLAG)LOW_HouseOfHope_State_OrthonDiedInSHA_736831d7-1ab2-4f39-a5e2-cf2929e176fb);
SetFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe);
DB_LOW_HouseOfHope_HopeRescuer(_Player);
PROC_LOW_HouseOfHope_SetHopeFree();
TeleportTo(_Player, (TRIGGER)S_LOW_HouseOfHope_HopeLastHopeTrigger_992cda41-4d2f-49f5-b5ef-c42e6e5fa867, "", 1, 1, 1, 1, 1);


IF
TextEvent("LOW_HOH_HelpHope")
THEN
PROC_ItemUnlockAndOpen((ITEM)S_LOW_HouseOfHope_FoyerDoor_06e45a4e-409a-4cb0-84ab-487bbdaedbee);
SetFlag((FLAG)LOW_HouseOfHope_Event_AgreedToHelpHope_525e29e1-58c6-2320-aba9-832d0ca8ff33);
SetFlag((FLAG)LOW_HouseOfHope_Event_HopeGrantsDisguise_bb82e10f-9c0f-5c16-9f1d-e482d9074ca8);

IF
TextEvent("LOW_HOH_HelpHope")
THEN
NOT DB_LOW_HouseOfHope_AllowedHopeSpirits(S_LOW_HopeSpirit01_bd1a71ec-0cea-4caf-9ead-be7e1cc84ede);


IF
TextEvent("LOW_HOH_MadeDeal")
AND
GetHostCharacter(_Player)
THEN
SetFlag((FLAG)Debug_LOW_HouseOfHope_MadeDeal_9856bebb-6b94-47d4-b7ca-559398498a66,_Player);

IF
TextEvent("LOW_HOH_ActivatePortal")
THEN
SetFlag(LOW_DevilsFee_Event_OpeningPortal_4dfbe814-2457-40ae-bead-b997d0724af2);


IF
FlagSet((FLAG)Debug_LOW_HouseOfHope_StealMasterKeyword_0ef7bd28-56c7-4261-9f42-e67321fc2c58,_Player,_)
THEN
ToInventory((ITEM)S_LOW_HouseOfHope_MasterKeyword_dcd74338-b779-4387-9748-8f8a2b29230e, _Player,1,1,1);
ClearFlag((FLAG)Debug_LOW_HouseOfHope_StealMasterKeyword_0ef7bd28-56c7-4261-9f42-e67321fc2c58,_Player);

IF
FlagSet((FLAG)Debug_LOW_HouseOfHope_MadeDeal_9856bebb-6b94-47d4-b7ca-559398498a66,_Player,_)
THEN
SetFlag((FLAG)GLO_Raphael_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc);
ToInventory((ITEM)S_GLO_OrphicHammer_9013ef0d-c6ee-4137-b17a-c1934079e10d,_Player,1,1,1);
PROC_SetOnStage((ITEM)S_LOW_HouseOfHope_PlayerContract_69119dc3-2c26-4e50-8430-ef427d05ef7f, 1);
ToInventory((ITEM)S_LOW_HouseOfHope_MasterKeyword_AfterDeal_8057c70c-21b8-4cb7-8926-c92a2c40df3c, S_LOW_HouseOfHope_SoulVesselSafe_adb5581e-b1cf-4d3e-9ace-5c75adfa2f47);
ToInventory((ITEM)S_LOW_HouseOfHope_MasterKeyword_dcd74338-b779-4387-9748-8f8a2b29230e, S_LOW_HouseOfHope_MasterKeywordBackgroundStorage_448c2ea4-0b79-4b40-97c4-33afcf68aa70);

IF
FlagSet((FLAG)Debug_LOW_HouseOfHope_DisableInferno_661af7b9-5e84-43d3-94bb-e405f84aef8c, _Player, _)
THEN
DB_LOW_HouseOfHope_DisableInferno(1);
ClearFlag((FLAG)Debug_LOW_HouseOfHope_DisableInferno_661af7b9-5e84-43d3-94bb-e405f84aef8c,_Player);

// Stealing main treasure
IF
FlagSet((FLAG)Debug_LOW_HouseOfHope_MainTreasureStealing_8d6d5f80-dcf6-1429-b4c0-b17f3605de37,_Player,_)
AND
NOT DB_GlobalFlag((FLAG)GLO_Raphael_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
THEN
ToInventory((ITEM)S_GLO_OrphicHammer_9013ef0d-c6ee-4137-b17a-c1934079e10d,_Player,1,1,1);
SetFlag((FLAG)LOW_HouseOfHope_State_PlayersStoleMainTreasure_ffa3d3be-d30f-296f-d794-4c24d63eb25c);
SetFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe);
ClearFlag((FLAG)Debug_LOW_HouseOfHope_MainTreasureStealing_8d6d5f80-dcf6-1429-b4c0-b17f3605de37,_Player);

IF
FlagSet((FLAG)Debug_LOW_HouseOfHope_MainTreasureStealing_8d6d5f80-dcf6-1429-b4c0-b17f3605de37,_Player,_)
AND
DB_GlobalFlag((FLAG)GLO_Raphael_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
THEN
Die(S_LOW_HouseOfHope_PlayerContract_69119dc3-2c26-4e50-8430-ef427d05ef7f, DEATHTYPE.Incinerate, NULL_00000000-0000-0000-0000-000000000000, 0, 1);
SetFlag((FLAG)LOW_HouseOfHope_State_PlayersStoleMainTreasure_ffa3d3be-d30f-296f-d794-4c24d63eb25c);
SetFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe);
ClearFlag((FLAG)Debug_LOW_HouseOfHope_MainTreasureStealing_8d6d5f80-dcf6-1429-b4c0-b17f3605de37,_Player);

//Orthon relations

IF
FlagSet(Debug_LOW_HouseOfHope_Confrontation_OrthonHelpedInSHA_e7d8afb2-0a59-1580-1c73-3a2cf3057c05,_Player,_)
THEN
SetFlag(SHA_LastJusticiar_State_KilledJusticiar_95b1ac4a-c978-3288-a192-d294b70229c4);
SetFlag((FLAG)SHA_Orthon_State_ContractEnded_26c35edd-3617-82b3-b4d7-1b7bb6410485);
SetFlag((FLAG)SHA_OrthonLair_Knows_Orthon_84ce6c40-0906-afae-0b6a-1df4625fa9d3);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_HouseOfHope_Orthon_905611e9-4399-47e3-a576-aaa840ab1724, 100);
PROC_SetRelationMutual((FACTION)Act3_LOW_HouseOfHope_Orthon_905611e9-4399-47e3-a576-aaa840ab1724,(FACTION)Act3_LOW_HouseOfHope_Raphael_65b207f5-756f-4980-ace1-b418ed8f477b,50);
ClearFlag((FLAG)LOW_HouseOfHope_State_OrthonDiedInSHA_736831d7-1ab2-4f39-a5e2-cf2929e176fb);
ClearFlag(Debug_LOW_HouseOfHope_Confrontation_OrthonHelpedInSHA_e7d8afb2-0a59-1580-1c73-3a2cf3057c05,_Player);

IF
FlagSet(Debug_LOW_HouseOfHope_Confrontation_OrthonKilledInSHA_348d7fa5-7a85-cb9d-1a1c-4c9796e44265,_Player,_)
THEN
ClearFlag(SHA_LastJusticiar_State_KilledJusticiar_95b1ac4a-c978-3288-a192-d294b70229c4);
ClearFlag((FLAG)SHA_Orthon_State_ContractEnded_26c35edd-3617-82b3-b4d7-1b7bb6410485);
SetFlag((FLAG)SHA_OrthonLair_Knows_Orthon_84ce6c40-0906-afae-0b6a-1df4625fa9d3);
SetFlag((FLAG)LOW_HouseOfHope_State_OrthonDiedInSHA_736831d7-1ab2-4f39-a5e2-cf2929e176fb);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_HouseOfHope_Orthon_905611e9-4399-47e3-a576-aaa840ab1724, 50);
PROC_SetRelationMutual((FACTION)Act3_LOW_HouseOfHope_Orthon_905611e9-4399-47e3-a576-aaa840ab1724,(FACTION)Act3_LOW_HouseOfHope_Raphael_65b207f5-756f-4980-ace1-b418ed8f477b,50);
ClearFlag(Debug_LOW_HouseOfHope_Confrontation_OrthonKilledInSHA_348d7fa5-7a85-cb9d-1a1c-4c9796e44265,_Player);

IF
FlagSet((FLAG)Debug_LOW_HouseOfHope_FreeHope_de132418-8a16-4264-a738-a9d8fc90e3c5,(CHARACTER)_Player,_)
AND
DB_LOW_HouseOfHope_HopeChains(_Chain)
THEN
PROC_LOW_HouseOfHope_BreakChain(_Chain, _Player);

IF
FlagSet((FLAG)Debug_LOW_HouseOfHope_FreeHope_de132418-8a16-4264-a738-a9d8fc90e3c5,(CHARACTER)_Player,_)
THEN
TeleportTo(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, _Player);

//END_REGION

//REGION House of Hope

IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_HouseOfHope_SUB_49462249-7f39-4b91-af1d-ba121c711213)
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_VisitedHouseOfHope_c8889a79-8277-48e9-afa0-e14f6359ea10)
THEN
SetFlag((FLAG)LOW_HouseOfHope_State_VisitedHouseOfHope_c8889a79-8277-48e9-afa0-e14f6359ea10);


// Checking if players can still get Orphic Hammer after getting the alarm or not

IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_HouseOfHope_SUB_49462249-7f39-4b91-af1d-ba121c711213)
AND
DB_GlobalFlag((FLAG)GLO_Raphael_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
AND
GetFlag((FLAG)GLO_Monitor_State_HasOrphicHammer_29842214-5482-dc25-fc89-02e474d7d96b, _Player, 0)
THEN
SetFlag((FLAG)LOW_HouseOfHope_State_NoHammerInHouse_29adfa78-2141-4599-a46a-53dd49acdb23);

IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_HouseOfHope_SUB_49462249-7f39-4b91-af1d-ba121c711213)
AND
DB_GlobalFlag((FLAG)GLO_Raphael_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
AND
DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_NoHammerInHouse_29adfa78-2141-4599-a46a-53dd49acdb23)
AND
GetFlag((FLAG)GLO_Monitor_State_HasOrphicHammer_29842214-5482-dc25-fc89-02e474d7d96b, _Player, 1)
THEN
ClearFlag((FLAG)LOW_HouseOfHope_State_NoHammerInHouse_29adfa78-2141-4599-a46a-53dd49acdb23);

IF
FlagSet((FLAG)LOW_HouseOfHope_State_VisitedHouseOfHope_c8889a79-8277-48e9-afa0-e14f6359ea10,_,_)
THEN
DB_GLO_LevelTraveler((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "CTY_Main_A", "DefaultCharacter");
NOT DB_GLO_LevelTraveler((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "CTY_Main_A", "WYR_RaphaelTango_Warlock");
PROC_LOW_HouseOfHope_SetUpTreasures();

//Setup Raphael and Korrilla
IF
FlagSet((FLAG)LOW_HouseOfHope_State_VisitedHouseOfHope_c8889a79-8277-48e9-afa0-e14f6359ea10,_,_)
AND 
QRY_State_IsBeforeState(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_HouseOfHope_Archive")
THEN
PROC_State_Progress(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297,"GLO_Warlock", "GLO_Warlock_HouseOfHope_Archive");


PROC
PROC_State_Changed(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297,"GLO_Warlock", "GLO_Warlock_HouseOfHope_Archive")
AND
DB_GlobalFlag((FLAG)GLO_Warlock_State_ShouldAppearInArchive_aaf145de-d32f-47f9-9334-49697509b561)
THEN
PROC_GLO_SetupForAct_Place(
	(CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297,
	(TRIGGER)S_LOW_HouseOfHope_KorrillaArchivePoint_1f50bfb4-46ed-44c0-9eda-b404a98dae9e, 
	(FACTION)Act3_LOW_HouseOfHope_Warlock_c5736f4b-26bd-4681-a467-7490617139df,
	(DIALOGRESOURCE)LOW_HouseOfHope_Korrilla_5f079fe8-02c0-e0ac-369f-68c1774cd175,
	"LOW_HouseOfHope_WarlockReady");
PROC_SetAnubisConfig((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "DefaultCharacter");
CharacterDisableAllCrimes(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297);
PROC_GLO_Warlock_ApplyStatus("GLO_KORRILLA_PROJECTEDIMAGE");
PROC_GLO_Warlock_RemoveStatus("GLO_KORRILLA_STEALTH");
PROC_GLO_Warlock_RemoveStatus("TWN_KORRILLATHESPY_PROXIMITYAURA");

PROC
PROC_State_Changed(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297,"GLO_Warlock", "GLO_Warlock_HouseOfHope_Archive")
AND
NOT DB_GlobalFlag((FLAG)GLO_Warlock_State_ShouldAppearInArchive_aaf145de-d32f-47f9-9334-49697509b561)
THEN
PROC_SetOnStage(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, 0);
SetFlag((FLAG)LOW_HouseOfHope_Event_KorrillaLeftArchive_513586ba-31d6-49f3-a688-0097416740b0);
PROC_GLO_Warlock_RemoveAllStatuses();
PROC_State_Progress(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297,"GLO_Warlock", "GLO_Warlock_HouseOfHope_OffStage");

IF
FlagSet((FLAG)LOW_HouseOfHope_State_VisitedHouseOfHope_c8889a79-8277-48e9-afa0-e14f6359ea10,_,_)
AND
QRY_State_IsBeforeState(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor","GLO_Monitor_HouseOfHope")
THEN
PROC_State_Progress(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", "GLO_Monitor_HouseOfHope");
PROC_GLO_SetupForAct_Place(
	(CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8,
	(TRIGGER)S_LOW_HouseOfHope_RaphaelPoint_38b385de-047f-4f5c-b214-cb219a00ea95, 
	(FACTION)Act3_LOW_HouseOfHope_Raphael_65b207f5-756f-4980-ace1-b418ed8f477b,
	(DIALOGRESOURCE)LOW_HouseOfHope_RaphaelAppearance_d48628c9-ac3a-6fe8-2312-a856f1a1f9fa,
	"LOW_HouseOfHope_RaphaelReady");
PROC_CharacterFullRestore((CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_HouseOfHope_Raphael_65b207f5-756f-4980-ace1-b418ed8f477b, 50);
PROC_SetOnStage(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, 0);
SetImmortal((CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8,0);
NOT DB_PreventPermaDefeated(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8);
PROC_GLO_SetupForAct_Place(
	(CHARACTER)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c,
	(TRIGGER)S_LOW_HouseOfHope_OrthonPoint_a29bb35d-c5f3-404f-9a27-d75c67322bcb, 
	(FACTION)Act3_LOW_HouseOfHope_Orthon_905611e9-4399-47e3-a576-aaa840ab1724);
PROC_CharacterFullRestore((CHARACTER)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c);
PROC_SetOnStage(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, 0);

IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
IsDead((CHARACTER)S_LOW_HouseOfHope_Nubaldin_046f67d9-d477-42d5-8b70-fd0a7911caf4, 0)
AND
IsOnStage((CHARACTER)S_LOW_HouseOfHope_Nubaldin_046f67d9-d477-42d5-8b70-fd0a7911caf4, 1)
THEN
PROC_GLO_Monitor_EntityPoof((CHARACTER)S_LOW_HouseOfHope_Nubaldin_046f67d9-d477-42d5-8b70-fd0a7911caf4);

// Will happen only in Debug
IF
FlagSet((FLAG)LOW_HouseOfHope_State_VisitedHouseOfHope_c8889a79-8277-48e9-afa0-e14f6359ea10,_,_)
AND
NOT DB_GlobalFlag(LOW_DevilsFee_State_TraveledOnceToHouseOfHope_36950cf9-1642-a398-e116-0adb189d3b7d)
THEN
SetFlag(LOW_DevilsFee_Event_OpeningPortal_4dfbe814-2457-40ae-bead-b997d0724af2);
SetFlag((FLAG)LOW_DevilsFee_State_RitualAlreadyDone_3bc4c164-0e98-fbc7-0cef-f244e390b3b4); 
SetFlag((FLAG)LOW_DevilsFee_State_TraveledOnceToHouseOfHope_36950cf9-1642-a398-e116-0adb189d3b7d);

//END_REGION

//REGION Hope delivery system

PROC
PROC_LOW_HouseOfHope_PoofHope((GUIDSTRING)_Character)
AND
DB_LOW_HouseOfHope_HopeFoopPoofVFX(_VFXResource)
THEN
PROC_Poof(_Character,_VFXResource);

PROC
PROC_LOW_HouseOfHope_FoopHope((GUIDSTRING)_Character)
AND
DB_LOW_HouseOfHope_HopeFoopPoofVFX(_VFXResource)
THEN
PROC_Foop(_Character,_VFXResource);

IF
DB_LOW_HouseOfHope_HopeSpirits(_Hope)
THEN
PROC_SetOnStage(_Hope, 0);

IF
DB_LOW_HouseOfHope_HopeSpirits(_Hope)
THEN
PROC_CharacterDisableAllCrimes((CHARACTER)_Hope);

IF
DB_LOW_HouseOfHope_HopeTriggeredDialogues(_, _Hope, _Dialog, _, _, _)
THEN
DB_Dialogs(_Hope, _Dialog);

IF
DB_LOW_HouseOfHope_HopeTriggeredDialogues(_Trigger, _Hope, _, _, _, _)
AND
DB_LOW_HouseOfHope_AllowedHopeSpirits(_Hope)
AND
NOT DB_LOW_HouseOfHope_HopeIsFree(1)
AND
NOT DB_Defeated(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce)
THEN
PROC_TriggerRegisterForPlayers(_Trigger);

IF
DB_LOW_HouseOfHope_HopeTriggeredDialogues(_Trigger, _Hope, _, _, _, _)
AND
NOT DB_LOW_HouseOfHope_AllowedHopeSpirits(_Hope)
THEN
PROC_TriggerUnregisterForPlayers(_Trigger);

IF
DB_InRegion(_Player, _Trigger)
AND
DB_LOW_HouseOfHope_HopeTriggeredDialogues(_Trigger, _Hope, _, _, _OnlyOnceSpawn, _)
AND
IsInCombat(_Player, 0)
AND
QRY_OnlyOnce(_OnlyOnceSpawn)
THEN
PROC_LOW_HouseOfHope_FoopHope(_Hope);
DB_LOW_HouseOfHope_HopeAppeared(_Hope);

IF
DB_InRegion(_Player, _Trigger)
AND
DB_LOW_HouseOfHope_HopeTriggeredDialogues(_Trigger, _Hope, _Dialog, _AutomatedDialogStart, _, _OnlyOnceDialog)
AND
_AutomatedDialogStart == 1
AND
DB_LOW_HouseOfHope_HopeAppeared(_Hope)
AND
QRY_OnlyOnce(_OnlyOnceDialog)
AND
QRY_GetClosestAvailableCharacterTo(_Hope, 0)
AND
DB_ClosestAvailableCharacterTo(_PlayerSpeaker, _Hope, _)
AND
QRY_StartDialog(_Dialog, _Hope, _PlayerSpeaker)
THEN
DB_NOOP(1);

IF
DB_InRegion(_Player, _Trigger)
AND
DB_LOW_HouseOfHope_HopeTriggeredDialogues(_Trigger, _Hope, _Dialog, _AutomatedDialogStart, _, _)
AND
_AutomatedDialogStart == 0
AND
DB_LOW_HouseOfHope_HopeAppeared(_Hope)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_HopeCallsToTalk_a3a7588c-32a9-ab38-627a-15aa718cda3b, _Hope);

// All Hope spirits, other than the first one, will disappear after the dialogue
IF
DialogEnded(_Dialog, _)
AND
DB_LOW_HouseOfHope_HopeTriggeredDialogues(_, _Hope, _Dialog, _, _, _)
AND
_Hope != S_LOW_HopeSpirit01_bd1a71ec-0cea-4caf-9ead-be7e1cc84ede
THEN
NOT DB_LOW_HouseOfHope_AllowedHopeSpirits(_Hope);

IF
DB_LOW_HouseOfHope_HopeAppeared(_Hope)
AND
NOT DB_LOW_HouseOfHope_AllowedHopeSpirits(_Hope)
THEN
PROC_LOW_HouseOfHope_PoofHope(_Hope);
NOT DB_LOW_HouseOfHope_HopeAppeared(_Hope);

// If Hope is added to this DB, only once resets and allows to spawn Hope again.
IF
DB_LOW_HouseOfHope_AllowedHopeSpirits(_Hope)
AND
DB_LOW_HouseOfHope_HopeTriggeredDialogues(_, _Hope, _, _, _OnlyOnceSpawn, _OnlyOnceDialog)
THEN
NOT DB_OnlyOnce(_OnlyOnceSpawn);
NOT DB_OnlyOnce(_OnlyOnceDialog);

IF
FlagSet((FLAG)LOW_HouseOfHope_HopeSpirit01_State_HopeDisappearedEarly_401be2e5-556b-116f-caee-918dec4139e1,_,_)
THEN
DB_LOW_HouseOfHope_HelpfulHope(1);

IF
FlagSet((FLAG)LOW_HouseOfHope_Event_AgreedToHelpHope_525e29e1-58c6-2320-aba9-832d0ca8ff33,_,_)
THEN
DB_LOW_HouseOfHope_HelpfulHope(1);

IF
DB_LOW_HouseOfHope_HelpfulHope(1)
AND
NOT DB_LOW_HouseOfHope_AlarmIsReady(1)
THEN
DB_LOW_HouseOfHope_AllowedHopeSpirits((CHARACTER)S_LOW_HopeSpirit02_f269f979-fe67-40c7-b658-b554bb84d36d);
DB_LOW_HouseOfHope_AllowedHopeSpirits((CHARACTER)S_LOW_HopeSpirit03_addd16fc-118e-46c6-81d2-55d69fa919b5);
DB_LOW_HouseOfHope_AllowedHopeSpirits((CHARACTER)S_LOW_HopeSpirit04_e42e7bf6-93c5-42df-be4e-af993c6adc25);
DB_LOW_HouseOfHope_AllowedHopeSpirits((CHARACTER)S_LOW_HopeSpirit05_afce8d6b-24c5-4c00-903d-3ec20eb5d0e9);
DB_LOW_HouseOfHope_AllowedHopeSpirits((CHARACTER)S_LOW_HopeSpirit06_e126d40a-2e86-4736-90b9-aa290f47a4ed);

// Handling disguise

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_HouseOfHope_Event_HopeGrantsDisguise_bb82e10f-9c0f-5c16-9f1d-e482d9074ca8)
AND
NOT DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
DB_Players(_Player)
AND
DB_LOW_HouseOfHope_DebtorClothesCounter(_Counter)
AND
IntegerSum(_Counter, 1, _NewCounter)
AND
DB_LOW_HouseOfHope_DebtorClothes(_Counter, _Item)
THEN
NOT DB_LOW_HouseOfHope_DebtorClothesCounter(_Counter);
DB_LOW_HouseOfHope_DebtorClothesCounter(_NewCounter);
ToInventory(_Item, _Player, 1, 0, 1);
Equip(_Player, _Item, 0, 0, 0);

IF
TemplateEquipped(_Template, _Player)
AND
NOT DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
DB_LOW_HouseOfHope_DebtorTemplates(_Template)
THEN
PROC_SetArmourSet(_Player, ARMOURSET.Vanity);
PlayEffect(_Player,  (EFFECTRESOURCE)VFX_Script_Raphael_Poof_TeleportIn_01_f7880749-91d9-68dd-9675-ec33dbbc7936);

IF
TemplateUnequipped(_Template, _Player)
AND
NOT DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
GetEquippedItem(_Player, "VanityBody", _Item)
AND
GetTemplate(_Item, _NewTemplate)
AND
DB_LOW_HouseOfHope_DebtorTemplates(_Template)
AND
NOT DB_LOW_HouseOfHope_DebtorTemplates(_NewTemplate)
THEN
PROC_SetArmourSet(_Player, ARMOURSET.Normal);
PlayEffect(_Player,  (EFFECTRESOURCE)VFX_Script_Raphael_Poof_TeleportIn_01_f7880749-91d9-68dd-9675-ec33dbbc7936);

IF
StatusApplied(_Player, "LOW_HOH_DEBTOR", _, _)
AND
NOT DB_LOW_HouseOfHope_UsedDisguiseAtLeastOnce(_Player)
THEN
DB_LOW_HouseOfHope_UsedDisguiseAtLeastOnce(_Player);

PROC
PROC_LOW_HouseOfHope_SetAlarm()
AND
DB_Players(_Player)
AND
GetEquippedItem(_Player, "VanityBody", _Item)
AND
GetTemplate(_Item, _Template)
AND
DB_LOW_HouseOfHope_DebtorTemplates(_Template)
THEN
PROC_LOW_HouseOfHope_DestroyDebtorsAttire(_Player, _Item);

IF
TemplateEquipped(_Template, _Player)
AND
DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
DB_LOW_HouseOfHope_DebtorTemplates(_Template)
AND
GetEquippedItem(_Player, "VanityBody", _Item)
THEN
PROC_LOW_HouseOfHope_DestroyDebtorsAttire(_Player, _Item);
PlayEffect(_Player,  (EFFECTRESOURCE)VFX_Script_Raphael_Poof_TeleportIn_01_f7880749-91d9-68dd-9675-ec33dbbc7936);

PROC
PROC_LOW_HouseOfHope_DestroyDebtorsAttire((CHARACTER)_Player, (GUIDSTRING)_Item)
THEN
PlayEffect(_Player,  (EFFECTRESOURCE)VFX_Script_Raphael_Poof_TeleportIn_01_f7880749-91d9-68dd-9675-ec33dbbc7936);
PROC_SetArmourSet(_Player, ARMOURSET.Normal);
Die(_Item, DEATHTYPE.Incinerate, NULL_00000000-0000-0000-0000-000000000000,0,0);

PROC
PROC_LOW_HouseOfHope_DestroyDebtorsAttire((CHARACTER)_Player, (GUIDSTRING)_Item)
AND
HasAppliedStatus(_Player, "LOW_HOH_DEBTOR", 1)
THEN
RemoveStatus(_Player, "LOW_HOH_DEBTOR", NULL_00000000-0000-0000-0000-000000000000);

// Moving between HoH and BG should switch the armourset

IF
LeftTrigger(_Player, _Trigger)
AND
DB_TriggerEvents_TriggerSet("LOW_HouseOfHope", _Trigger)
AND
HasAppliedStatus(_Player, "LOW_HOH_DEBTOR", 1)
AND
QRY_GetArmourSet(_Player)
AND
DB_QRYRTN_GetArmourSet(ARMOURSET.Vanity)
AND
NOT QRY_TriggerEvents_InTriggerSet(_Player, "LOW_HouseOfHope")
THEN
PROC_SetArmourSet(_Player, ARMOURSET.Normal);

IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_HouseOfHope_SUB_49462249-7f39-4b91-af1d-ba121c711213)
AND
HasAppliedStatus(_Player, "LOW_HOH_DEBTOR", 1)
AND
QRY_GetArmourSet(_Player)
AND
DB_QRYRTN_GetArmourSet(ARMOURSET.Normal)
THEN
PROC_SetArmourSet(_Player, ARMOURSET.Vanity);


PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_HouseOfHope_Event_HopeGrantsDisguise_bb82e10f-9c0f-5c16-9f1d-e482d9074ca8)
THEN
NOT DB_LOW_HouseOfHope_AllowedHopeSpirits(S_LOW_HopeSpirit01_bd1a71ec-0cea-4caf-9ead-be7e1cc84ede);
PROC_ItemUnlockAndOpen((ITEM)S_LOW_HouseOfHope_FoyerDoor_06e45a4e-409a-4cb0-84ab-487bbdaedbee);

// Warning in Archive
IF 
DB_LOW_HouseOfHope_AlarmIsReady(1)
THEN
DB_LOW_HouseOfHope_AllowedHopeSpirits((CHARACTER)S_LOW_HopeSpirit_Alarm_8b0c3442-b9b9-4efa-aa05-2c1ea1240dae);


// Remove spirits
IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
THEN
NOT DB_LOW_HouseOfHope_AllowedHopeSpirits((CHARACTER)S_LOW_HopeSpirit01_bd1a71ec-0cea-4caf-9ead-be7e1cc84ede);
NOT DB_LOW_HouseOfHope_AllowedHopeSpirits((CHARACTER)S_LOW_HopeSpirit02_f269f979-fe67-40c7-b658-b554bb84d36d);
NOT DB_LOW_HouseOfHope_AllowedHopeSpirits((CHARACTER)S_LOW_HopeSpirit03_addd16fc-118e-46c6-81d2-55d69fa919b5);
NOT DB_LOW_HouseOfHope_AllowedHopeSpirits((CHARACTER)S_LOW_HopeSpirit04_e42e7bf6-93c5-42df-be4e-af993c6adc25);

IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
THEN
PROC_ForceStopDialog((CHARACTER)S_LOW_HopeSpirit01_bd1a71ec-0cea-4caf-9ead-be7e1cc84ede);
PROC_ForceStopDialog((CHARACTER)S_LOW_HopeSpirit02_f269f979-fe67-40c7-b658-b554bb84d36d);
PROC_ForceStopDialog((CHARACTER)S_LOW_HopeSpirit03_addd16fc-118e-46c6-81d2-55d69fa919b5);
PROC_ForceStopDialog((CHARACTER)S_LOW_HopeSpirit04_e42e7bf6-93c5-42df-be4e-af993c6adc25);

IF
FlagSet((FLAG)LOW_HouseOfHope_State_PlayersStoleMainTreasure_ffa3d3be-d30f-296f-d794-4c24d63eb25c,_,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_NoHammerInHouse_29adfa78-2141-4599-a46a-53dd49acdb23)
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_PrisonHopeSpirit_TalkedBeforeTreasure_579ee85f-1079-0ee5-8f52-caea6b3d7f84)
THEN
DB_LOW_HouseOfHope_AllowedHopeSpirits((CHARACTER)S_LOW_HopeSpirit05_afce8d6b-24c5-4c00-903d-3ec20eb5d0e9);
DB_LOW_HouseOfHope_AllowedHopeSpirits((CHARACTER)S_LOW_HopeSpirit06_e126d40a-2e86-4736-90b9-aa290f47a4ed);

IF
DB_InRegion(_Player, (TRIGGER)S_LOW_HouseOfHope_ArchiveADTrigger_f066cc2f-5289-492d-862f-69aebf1eff34)
THEN
NOT DB_LOW_HouseOfHope_AllowedHopeSpirits((CHARACTER)S_LOW_HopeSpirit02_f269f979-fe67-40c7-b658-b554bb84d36d);

IF 
DB_InRegion(_Player,(TRIGGER)S_LOW_HouseOfHope_IncubusTrigger_Room_1797390e-7d4b-4e16-862e-d3eed5162549)
THEN
NOT DB_LOW_HouseOfHope_AllowedHopeSpirits((CHARACTER)S_LOW_HopeSpirit03_addd16fc-118e-46c6-81d2-55d69fa919b5);

IF
DialogEnded((DIALOGRESOURCE)LOW_HouseOfHope_HopeSpirit_Prison_33f61440-9fb9-b8d3-270b-0dc0aa8a9792, _)
THEN
NOT DB_LOW_HouseOfHope_AllowedHopeSpirits((CHARACTER)S_LOW_HopeSpirit05_afce8d6b-24c5-4c00-903d-3ec20eb5d0e9);
NOT DB_LOW_HouseOfHope_AllowedHopeSpirits((CHARACTER)S_LOW_HopeSpirit06_e126d40a-2e86-4736-90b9-aa290f47a4ed);

// Hope guidance to prison

IF
FlagSet((FLAG)LOW_HouseOfHope_State_PlayersStoleMainTreasure_ffa3d3be-d30f-296f-d794-4c24d63eb25c,_,_)
AND
NOT DB_GlobalFlag((FLAG)GLO_Raphael_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
THEN
DB_LOW_HouseOfHope_CanSaveHope(1);

IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
DB_GlobalFlag((FLAG)GLO_Raphael_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_NoHammerInHouse_29adfa78-2141-4599-a46a-53dd49acdb23)
THEN
DB_LOW_HouseOfHope_CanSaveHope(1);

IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
DB_LOW_HouseOfHope_HelpfulHope(1)
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_Event_HopeRescued_119342c6-2a7b-8c90-e96e-3f3a5930e91a)
AND
DB_LOW_HouseOfHope_CanSaveHope(1)
THEN
DB_OneShot_ADTrigger((TRIGGER)S_LOW_HouseOfHope_HopeSpirit_Start_35457c2f-aaf7-4540-a35b-b0afcda04ad1, (DIALOGRESOURCE)LOW_HouseOfHope_AD_HopeCallsToTalk_a3a7588c-32a9-ab38-627a-15aa718cda3b, S_LOW_HopeSpirit_Guide_51baa5f6-1248-499b-acf3-79b6bdd0f6bd);
PROC_SetOnStage(S_LOW_HopeSpirit_Guide_51baa5f6-1248-499b-acf3-79b6bdd0f6bd, 1);

IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
DB_LOW_HouseOfHope_HelpfulHope(1)
AND
DB_LOW_HouseOfHope_CanSaveHope(1)
THEN
PROC_LOW_HouseOfHope_ActivateHopeGuidance(1);

IF
DB_InRegion(_Player, _Trigger)
AND
DB_LOW_HouseOfHope_HopeGuidance(_Trigger, _Target, _MoveEvent, _Step)
AND
IsOnStage(S_LOW_HopeSpirit_Guide_51baa5f6-1248-499b-acf3-79b6bdd0f6bd, 1)
AND
IntegerSum(_Step, 1, _NewStep)
THEN
PROC_TriggerUnregisterForPlayers(_Trigger);
PROC_LOW_HouseOfHope_ActivateHopeGuidance(_NewStep);
PROC_CharacterMoveTo((CHARACTER)S_LOW_HopeSpirit_Guide_51baa5f6-1248-499b-acf3-79b6bdd0f6bd, _Target, "Run", _MoveEvent);
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_HopeGuide_02e3204c-d5c8-4d17-7ad3-8f8481fabcd6, S_LOW_HopeSpirit_Guide_51baa5f6-1248-499b-acf3-79b6bdd0f6bd);

PROC
PROC_LOW_HouseOfHope_ActivateHopeGuidance((INTEGER)_Step)
AND
DB_LOW_HouseOfHope_HopeGuidance(_Trigger, _, _, _Step)
THEN
PROC_TriggerRegisterForPlayers(_Trigger);

IF
EntityEvent(S_LOW_HopeSpirit_Guide_51baa5f6-1248-499b-acf3-79b6bdd0f6bd, _MoveEvent)
AND
DB_LOW_HouseOfHope_HopeGuidance(_, _Target, _MoveEvent,_)
THEN
LookFromTrigger(S_LOW_HopeSpirit_Guide_51baa5f6-1248-499b-acf3-79b6bdd0f6bd, _Target, 0);

IF
FlagSet((FLAG)LOW_HouseOfHope_Event_RefusedToHelpInArchive_79ef0a9f-eb1e-bfc4-0071-c8edf8466609, _, _)
AND
DB_LOW_HouseOfHope_AlarmIsReady(1)
THEN
PROC_RemoveOneShotAD((TRIGGER)S_LOW_HouseOfHope_HopeSpirit_Start_8fda7d3c-de63-4732-85d4-d4ba5c216fe1);
PROC_SetOnStage(S_LOW_HopeSpirit_Guide_51baa5f6-1248-499b-acf3-79b6bdd0f6bd, 0);

// Disabling all the spirits

IF
FlagSet((FLAG)LOW_HouseOfHope_Event_HopeRescued_119342c6-2a7b-8c90-e96e-3f3a5930e91a,_,_)
AND
DB_LOW_HouseOfHope_AllowedHopeSpirits(_Hope)
THEN
NOT DB_LOW_HouseOfHope_AllowedHopeSpirits(_Hope);


PROC
PROC_StateSet_PermaDefeated(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce)
AND
DB_LOW_HouseOfHope_AllowedHopeSpirits(_Hope)
THEN
NOT DB_LOW_HouseOfHope_AllowedHopeSpirits(_Hope);

IF
FlagSet((FLAG)LOW_HouseOfHope_Event_HopeRescued_119342c6-2a7b-8c90-e96e-3f3a5930e91a,_,_)
THEN
PROC_SetOnStage(S_LOW_HopeSpirit_Guide_51baa5f6-1248-499b-acf3-79b6bdd0f6bd, 0);

PROC
PROC_StateSet_PermaDefeated(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce)
THEN
PROC_SetOnStage(S_LOW_HopeSpirit_Guide_51baa5f6-1248-499b-acf3-79b6bdd0f6bd, 0);

// Dummy for HopeSpirit01

PROC
PROC_StartDialog_AddExtraSpeakers((DIALOGRESOURCE)LOW_HouseOfHope_HopeSpirit01_32a22a1a-6052-0556-509b-a30105e5f4dc, _Id)
AND
DialogGetInvolvedPlayer(_ID, 1, _Player)
THEN
Transform((CHARACTER)S_LOW_HouseOfHope_PlayerDummyForHope_e7b247ee-91f1-432f-b790-e351d3c4991d, _Player, (SHAPESHIFTRULE)DisguiseWithCustomLooksKeepNameAndIcon_b40d9ab4-57a7-4632-b8d7-188904b00606);
AppendShapeshiftStates((CHARACTER)S_LOW_HouseOfHope_PlayerDummyForHope_e7b247ee-91f1-432f-b790-e351d3c4991d, (CHARACTER)_Player);
Equip((CHARACTER)S_LOW_HouseOfHope_PlayerDummyForHope_e7b247ee-91f1-432f-b790-e351d3c4991d, S_LOW_HouseOfHope_DebtorClothes00_2c6b7756-d343-484b-b5fc-eb4adcce977b);
PROC_DialogAddSpeakingActor(_Id, (CHARACTER)S_LOW_HouseOfHope_PlayerDummyForHope_e7b247ee-91f1-432f-b790-e351d3c4991d);


//END_REGION

//REGION Foyer

IF
DB_LOW_HouseOfHope_SoulPillarTriggers(_Trigger)
THEN
DB_KnowledgeCheckTrigger_AD("LOW_HouseOfHope_SoulPillar", _Trigger, "Arcana", (DIFFICULTYCLASS)Act3_Medium_77cee1c4-384a-4217-b670-67db3c7add57, 
(DIALOGRESOURCE)LOW_HouseOfHope_PAD_SoulPillar_71a7b45d-751b-460d-bc34-590013b2f877, (FLAG)LOW_HouseOfHope_State_SoulPillarArcanaCheckPassed_7fdafb09-86d8-f9a5-1e30-66bdb8c43c32);

IF
FlagSet((FLAG)LOW_HouseOfHope_State_SoulPillarArcanaCheckPassed_7fdafb09-86d8-f9a5-1e30-66bdb8c43c32,_,_)
AND
DB_LOW_HouseOfHope_SoulPillarTriggers(_Trigger)
THEN
PROC_TriggerUnregisterForPlayers(_Trigger);
NOT DB_KnowledgeCheckTrigger_AD("LOW_HouseOfHope_SoulPillar", _Trigger, "Arcana", (DIFFICULTYCLASS)Act3_Medium_77cee1c4-384a-4217-b670-67db3c7add57, 
(DIALOGRESOURCE)LOW_HouseOfHope_PAD_SoulPillar_71a7b45d-751b-460d-bc34-590013b2f877, (FLAG)LOW_HouseOfHope_State_SoulPillarArcanaCheckPassed_7fdafb09-86d8-f9a5-1e30-66bdb8c43c32);

IF
FlagSet((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe,_,_)
AND
DB_LOW_HouseOfHope_SoulPillarTriggers(_Trigger)
THEN
PROC_TriggerUnregisterForPlayers(_Trigger);
NOT DB_KnowledgeCheckTrigger_AD("LOW_HouseOfHope_SoulPillar", _Trigger, "Arcana", (DIFFICULTYCLASS)Act3_Medium_77cee1c4-384a-4217-b670-67db3c7add57, 
(DIALOGRESOURCE)LOW_HouseOfHope_PAD_SoulPillar_71a7b45d-751b-460d-bc34-590013b2f877, (FLAG)LOW_HouseOfHope_State_SoulPillarArcanaCheckPassed_7fdafb09-86d8-f9a5-1e30-66bdb8c43c32);

IF
LeftTrigger(_Player, (TRIGGER)S_LOW_HouseOfHope_EmperorBlockedPADTrigger_5699e9e8-59f5-43ae-ba8c-ed368708276c)
AND
IsTagged(_Player, (TAG)ILLITHID_1eec74e8-3673-4500-abec-57b7ed8469ed, 1)
AND
QRY_OnlyOnce("LOW_HouseOfHope_EmperorBlocked")
THEN
StartVoiceBark((VOICEBARKRESOURCE)LOW_HouseOfHope_VB_EmperorBlocked_cfa335f9-5d52-47bb-23a8-874ba594605b, _Player);
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_HouseOfHope_EmperorBlockedPADTrigger_5699e9e8-59f5-43ae-ba8c-ed368708276c);


IF
UseFinished(_, (ITEM)S_LOW_HouseOfHope_FoyerDoor_06e45a4e-409a-4cb0-84ab-487bbdaedbee, _)
AND
IsLocked((ITEM)S_LOW_HouseOfHope_FoyerDoor_06e45a4e-409a-4cb0-84ab-487bbdaedbee, 1)
AND
NOT DB_LOW_HouseOfHope_AlarmIsReady(1)
THEN
SetFlag((FLAG)LOW_HouseOfHope_Knows_FoyerDoorLocked_98bb27ec-5aac-401a-2fb6-8b94614ef361);

IF
StoppedLockpicking(_, (ITEM)S_LOW_HouseOfHope_FoyerDoor_06e45a4e-409a-4cb0-84ab-487bbdaedbee)
AND
IsLocked((ITEM)S_LOW_HouseOfHope_FoyerDoor_06e45a4e-409a-4cb0-84ab-487bbdaedbee, 1)
AND
NOT DB_LOW_HouseOfHope_AlarmIsReady(1)
THEN
SetFlag((FLAG)LOW_HouseOfHope_Knows_FoyerDoorLocked_98bb27ec-5aac-401a-2fb6-8b94614ef361);

//END_REGION

//REGION Feast Hall

// Players are trying to get away without saving Hope.
IF
DB_InRegion(_Player, (TRIGGER)S_LOW_HouseOfHope_HopeLastHopeTrigger_992cda41-4d2f-49f5-b5ef-c42e6e5fa867)
AND
NOT DB_Defeated(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce)
AND
NOT QRY_AnyCharacterInTrigger((TRIGGER)S_LOW_HouseOfHope_FoyerRoom_de540d6b-f846-4c74-9f9e-56f49eb36cee)
AND
QRY_OnlyOnce("LOW_HouseOfHope_LastHope")
THEN
PROC_LOW_HouseOfHope_FoopHope(S_LOW_HopeSpirit_LastHope_86a1ce5d-410f-42fc-a4d3-4b604bbc24b2);
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_HopePleads_0ecc9c06-c8a8-a131-59dd-a9a5b314bee4, S_LOW_HopeSpirit_LastHope_86a1ce5d-410f-42fc-a4d3-4b604bbc24b2);

IF
AutomatedDialogEnded((DIALOGRESOURCE)LOW_HouseOfHope_AD_HopePleads_0ecc9c06-c8a8-a131-59dd-a9a5b314bee4, _)
THEN
PROC_LOW_HouseOfHope_PoofHope(S_LOW_HopeSpirit_LastHope_86a1ce5d-410f-42fc-a4d3-4b604bbc24b2);

IF
FlagSet((FLAG)LOW_HouseOfHope_Event_LockFoyerDoor_3bdee1fc-a71c-3b2d-0a38-57dd9e5d48ff,_,_)
THEN
PROC_ItemCloseAndLock((ITEM)S_LOW_HouseOfHope_FoyerDoor_06e45a4e-409a-4cb0-84ab-487bbdaedbee, "LOW_HouseOfHope_FoyerDoor");

IF
DB_InRegion((CHARACTER)S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, (TRIGGER)S_LOW_HouseOfHope_HopePreparesForRaphael_3f1e62fd-6b86-4cfa-b3bc-2e806ecd3297)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_HopePreparesForRaphael_e48c469d-fd66-d2bb-99dd-46e3d5a89661, S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce);
TriggerUnregisterForCharacter(S_LOW_HouseOfHope_HopePreparesForRaphael_3f1e62fd-6b86-4cfa-b3bc-2e806ecd3297, S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce);

IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
IsDead((CHARACTER)S_LOW_HouseOfHope_Debtor_Mason_7fa2834b-e31e-476a-bb3f-83b935b898e1, 0)
AND
IsOnStage(S_LOW_HouseOfHope_Debtor_Mason_7fa2834b-e31e-476a-bb3f-83b935b898e1, 1)
THEN
PROC_GLO_Monitor_EntityPoof(S_LOW_HouseOfHope_Debtor_Mason_7fa2834b-e31e-476a-bb3f-83b935b898e1);

IF
DualEntityEvent(_, _, "LOW_HouseOfHope_FeastDoor")
AND
IsLocked((ITEM)S_DOOR_HoH_DoubleBig_Metal_A_001_b73323bb-0045-4d39-b8dd-42b7d0c057d1, 1)
THEN
PROC_ItemUnlockAndOpen((ITEM)S_DOOR_HoH_DoubleBig_Metal_A_001_b73323bb-0045-4d39-b8dd-42b7d0c057d1);

IF
DualEntityEvent(_, _, "LOW_HouseOfHope_FeastDoor")
AND
IsLocked((ITEM)S_DOOR_HoH_DoubleBig_Metal_A_001_b73323bb-0045-4d39-b8dd-42b7d0c057d1, 0)
THEN
PROC_TryStartAD(LOW_HouseOfHope_AD_PrisonDoorButtonCantUse_ad0b3797-c95d-a975-2fbf-b8e82bd2c378, (ITEM)S_LOW_HouseOfHope_FeastHallDoorLever_63bca10f-30c8-4bda-a147-11e76da96107);

IF
DestroyedBy(_Chair, _,_,_)
AND
DB_LOW_HouseOfHope_DeadSkeletons(_Chair, _Skeleton)
THEN
Die(_Skeleton, DEATHTYPE.Incinerate, 1);

//END_REGION

//REGION Archive

IF
DB_InRegion(_Player, (TRIGGER)S_LOW_HouseOfHope_ArchiveADTrigger_f066cc2f-5289-492d-862f-69aebf1eff34)
AND
DB_Players(_Player)
AND
DB_State_Current(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297,"GLO_Warlock", "GLO_Warlock_HouseOfHope_Archive")
AND
QRY_OnlyOnce("LOW_HouseOfHope_ArchivistChat")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_KorrillaInArchive_145e7710-3a2a-8af0-6019-e332bf3e9ede, 
S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306, S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297);

IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_HouseOfHope_InterruptKorrillaTrigger_1923d441-01dc-4e6e-9533-8de96fce6a7d)
AND
NOT DB_LOW_HouseOfHope_KorrillaReadyToTalk(1)
AND
DB_State_Current(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297,"GLO_Warlock", "GLO_Warlock_HouseOfHope_Archive")
AND
DB_Sees((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, _Player)
AND
QRY_OnlyOnce("LOW_HouseOfHope_KorrillaCalls")
THEN
SetFlag((FLAG)LOW_HouseOfHope_Event_KorrillaSawPlayers_227facda-fad3-4d8e-8342-1604c038c0ee);
PROC_ForceStopDialog(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297);
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_KorrillaIsWaiting_74a18337-0a7f-6b93-1400-1a2fdbb22fc9, S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297);


IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_HouseOfHope_InterruptKorrillaTrigger_1923d441-01dc-4e6e-9533-8de96fce6a7d)
THEN
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_HouseOfHope_InterruptKorrillaTrigger_1923d441-01dc-4e6e-9533-8de96fce6a7d);

IF
AutomatedDialogEnded((DIALOGRESOURCE)LOW_HouseOfHope_AD_KorrillaInArchive_145e7710-3a2a-8af0-6019-e332bf3e9ede, _)
THEN
DB_LOW_HouseOfHope_KorrillaReadyToTalk(1);

IF
DB_InRegion(_Player, (TRIGGER)S_LOW_HouseOfHope_ArchiveADTrigger_f066cc2f-5289-492d-862f-69aebf1eff34)
AND
DB_LOW_HouseOfHope_KorrillaReadyToTalk(1)
AND
DB_State_Current(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297,"GLO_Warlock", "GLO_Warlock_HouseOfHope_Archive")
AND
NOT DB_DialogNPCs(_, S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, _)
AND
DB_Sees((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, _Player)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("LOW_HouseOfHope_KorrillaCalls")
THEN
SetFlag((FLAG)LOW_HouseOfHope_Event_KorrillaSawPlayers_227facda-fad3-4d8e-8342-1604c038c0ee);
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_KorrillaIsWaiting_74a18337-0a7f-6b93-1400-1a2fdbb22fc9, S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297);

IF
DialogStarted((DIALOGRESOURCE)LOW_HouseOfHope_Archivist_144d4b6a-428c-b650-21a8-cb49dff74aff, _)
THEN
SetFlag((FLAG)LOW_HouseOfHope_Event_TalkedToArchivistFirst_2abf7ee0-879f-705b-abec-b39c7acb94d3);

IF
DialogEnded((DIALOGRESOURCE)LOW_HouseOfHope_Archivist_144d4b6a-428c-b650-21a8-cb49dff74aff, _)
AND
DB_Sees((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, _Player)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("LOW_HouseOfHope_KorrillaCallsAgain")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_KorrillaIsWaiting_74a18337-0a7f-6b93-1400-1a2fdbb22fc9, S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297);

IF
DialogStarted((DIALOGRESOURCE)LOW_HouseOfHope_Korrilla_5f079fe8-02c0-e0ac-369f-68c1774cd175, _)
THEN
DB_OnlyOnce("LOW_HouseOfHope_KorrillaCalls");
DB_OnlyOnce("LOW_HouseOfHope_KorrillaCallsAgain");

IF
DialogEnded((DIALOGRESOURCE)LOW_HouseOfHope_Korrilla_5f079fe8-02c0-e0ac-369f-68c1774cd175, _)
THEN
PROC_LOW_HouseOfHope_KorrillaLeavesForGood();

IF
DB_LOW_HouseOfHope_ArchivistIgnoreCrimes(_IgnoreCharacter)
THEN
PROC_CharacterDisableAllCrimes(_IgnoreCharacter);

// Archivist should ignore any crime against certain characters
PROC
PROC_CharacterRegisterCrimeHandleIgnoresAfter(_ID, _Player, _, _, _IgnoreCharacter)
AND
DB_LOW_HouseOfHope_ArchivistIgnoreCrimes(_IgnoreCharacter)
THEN
CrimeIgnoreCrime(_ID, S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306);

// Archivist should call alarm after one warning

IF
DialogEnded((DIALOGRESOURCE)LOW_HouseOfHope_AD_ArchivistTrappedComment_250bd5c6-a55a-bb32-22c5-5e80814960be,_)
AND
NOT DB_LOW_HouseOfHope_ArchivistWarning(1)
THEN
DB_LOW_HouseOfHope_ArchivistWarning(1);

IF
DB_LOW_HouseOfHope_ArchivistWarning(1)
AND
DB_LOW_HouseOfHope_ArchivistCustomWarningCrime(_CrimeType)
THEN
NOT DB_CrimeType_CustomWarning((CHARACTER)S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306, _CrimeType,(DIALOGRESOURCE)LOW_HouseOfHope_AD_ArchivistTrappedComment_250bd5c6-a55a-bb32-22c5-5e80814960be);

IF
DB_LOW_HouseOfHope_ArchivistCustomWarningCrime(_CrimeType)
THEN
DB_CrimeType_CustomWarning((CHARACTER)S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306, _CrimeType,(DIALOGRESOURCE)LOW_HouseOfHope_AD_ArchivistTrappedComment_250bd5c6-a55a-bb32-22c5-5e80814960be);

IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
THEN
PROC_CharacterDisableAllCrimes(S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306);

PROC
PROC_CharacterRegisterCrimeHandleIgnoresAfter(_ID, _Player, _CrimeType, _, _)
AND
DB_LOW_HouseOfHope_ArchivistWarning(1)
AND
NOT DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
DB_LOW_HouseOfHope_ArchivistCustomWarningCrime(_CrimeType)
AND
DB_Sees((CHARACTER)S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306, _Player)
THEN
SetFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe);
CrimeIgnoreCrime(_ID, S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306);

PROC
PROC_CharacterRegisterCrimeHandleIgnoresAfter(_ID, _Player, _, _, _IgnoreCharacter)
AND
DB_LOW_HouseOfHope_ArchivistIgnoreCrimes(_IgnoreCharacter)
THEN
CrimeIgnoreCrime(_ID, S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306);

// Custom handling for archivist crimes

PROC
PROC_CharacterRegisterCrimeHandleIgnoresAfter(_ID, _, "EmptyPocketNoticed", _, (CHARACTER)S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306)
THEN
CrimeIgnoreCrime(_ID, S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306);

PROC
PROC_CharacterRegisterCrimeHandleIgnoresAfter(_ID, _, _Crime, _, (CHARACTER)S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306)
AND
DB_LOW_HouseOfHope_ArchivistCallAlarmCrime(_Crime)
THEN
CrimeIgnoreCrime(_ID, S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306);
SetFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe);

// Archivist should call the alarm if gets hostile

IF
EnteredCombat(S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306, _)
AND
NOT DB_LOW_HouseOfHope_AlarmIsReady(1)
THEN
SetFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe);


// Archivist will comment on skeletons' death

IF
DB_PermaDefeated(_Skeleton)
AND
DB_LOW_HouseOfHope_ArchiveSkeletons(_Skeleton,_)
AND
NOT DB_DialogNPCs(_, S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306, _)
AND
DB_Sees((CHARACTER)S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306, _Player)
AND
QRY_OnlyOnce("LOW_HouseOfHope_ArchivistReactionOnKillingSkeletons")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_ArchivistReactionOnKillingSkeletons_cbe36138-0c05-721b-d1df-8a3970553942, S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306);



// Korrilla will leave Archive if she'll notice that players did something "bad"

IF
AttackedBy(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, (CHARACTER)_Player, _, _, _, _, _)
AND
NOT DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
DB_Sees((CHARACTER)S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306, _Player)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_ArchivistReactionOnHittingKorrilla_26af1ee8-26aa-f3a0-1f6f-32c6a2606c1a, (CHARACTER)S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306);

PROC
PROC_CharacterRegisterCrimeHandleIgnoresAfter(_CrimeID, _Player, _, _, _)
AND
QRY_State_IsBeforeState(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_HouseOfHope_WithRaphael")
AND
DB_InRegion(_Player, (TRIGGER)S_LOW_HouseOfHope_ArchiveArea_82f690d2-ecd3-4f25-a46b-8d445a06210c)
AND
DB_Sees((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, _Player)
THEN
CrimeIgnoreCrime(_CrimeID, S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297);

PROC
PROC_CharacterRegisterCrimeHandleIgnoresAfter(_CrimeID, _Player, _, _, _)
AND
QRY_State_IsBeforeState(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_HouseOfHope_WithRaphael")
AND
DB_InRegion(_Player, (TRIGGER)S_LOW_HouseOfHope_ArchiveArea_82f690d2-ecd3-4f25-a46b-8d445a06210c)
AND
CrimeGetTension(_CrimeID, _Tension)
AND
_Tension > 9
AND
DB_Sees((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, _Player)
AND
QRY_OnlyOnce("LOW_HouseOfHope_KorrillaReactedOnCrime")
THEN
PROC_LOW_HouseOfHope_KorrillaLeavesAfterAD();

PROC
PROC_LOW_HouseOfHope_KorrillaLeavesForGood()
AND
QRY_State_IsBeforeState(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_HouseOfHope_OffStage")
THEN
SetFlag((FLAG)LOW_HouseOfHope_Event_KorrillaLeftArchive_513586ba-31d6-49f3-a688-0097416740b0);
PROC_State_Progress(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297,"GLO_Warlock", "GLO_Warlock_HouseOfHope_OffStage");
PROC_GLO_Warlock_TeleportOut();

PROC
PROC_LOW_HouseOfHope_KorrillaLeavesAfterAD()
AND
QRY_State_IsBeforeState(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_HouseOfHope_OffStage")
AND
QRY_OnlyOnce("LOW_HouseOfHope_KorrillaLeaves")
AND
QRY_State_IsBeforeState(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_HouseOfHope_OffStage")
THEN
PROC_ForceStopDialog((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297);
PROC_RemoveDialog(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297);
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_KorrillaLeaves_cca41b3e-2f5e-99f4-b281-caba7bf44d72, S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297);

IF
AutomatedDialogEnded((DIALOGRESOURCE)LOW_HouseOfHope_AD_KorrillaLeaves_cca41b3e-2f5e-99f4-b281-caba7bf44d72, _)
THEN
PROC_LOW_HouseOfHope_KorrillaLeavesForGood();


// Korrilla gets out after players learn the keyword and are ready to get the treasure
IF
FlagSet((FLAG)LOW_HouseOfHope_Knows_MasterKeyword_e18062be-03c7-7249-bca2-e7a71159020a,_,_)
AND
NOT DB_DialogNPCs(_, S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, _)
THEN
PROC_LOW_HouseOfHope_KorrillaLeavesAfterAD();

// Teleporting Korrilla right away as she is being set up for a Raphael's battle
IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
THEN
PROC_LOW_HouseOfHope_KorrillaLeavesForGood();


// Killing the Archivist will alert the House of Hope
IF
DB_PermaDefeated(S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306)
THEN
SetFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe);

// Archivist comments on Hope's appearance

IF
DB_InRegion((CHARACTER)S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, (TRIGGER)S_LOW_HouseOfHope_ArchiveADTrigger_f066cc2f-5289-492d-862f-69aebf1eff34)
AND
DB_Sees((CHARACTER)S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306, (CHARACTER)S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce)
AND
QRY_OnlyOnce("LOW_HouseOfHope_ArchivistNoticesHope")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_ArchivistNoticesHope_22f6f19f-6fda-637e-4743-43f1ee33bf2a, 
S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306);


// Archivist and skeletons react on the alarm

IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
DB_Sees((CHARACTER)S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306, _Player)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("LOW_HouseOfHope_ArchivistAlarmComment")
THEN
DB_OnlyOnce("LOW_HouseOfHope_ArchivistCommentsOnMainTreasures");
PROC_ForceStopDialog(S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306);
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_ArchivistAlarmComment_358f6bac-746d-c10d-34c2-db32c1c968f9, S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306);

IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
NOT DB_OnlyOnce("LOW_HouseOfHope_ArchivistAlarmComment")
THEN
PROC_GLO_Monitor_EntityPoof(S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306);

IF
AutomatedDialogEnded((DIALOGRESOURCE)LOW_HouseOfHope_AD_ArchivistAlarmComment_358f6bac-746d-c10d-34c2-db32c1c968f9,_)
THEN
DB_LOW_HouseOfHope_ArchivistWantsToSayGoodbye(1);

IF
DB_LOW_HouseOfHope_ArchivistWantsToSayGoodbye(1)
AND
DB_Sees((CHARACTER)S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306, _Player)
AND
DB_Players(_Player)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306, _Player)
AND
QRY_StartDialog((DIALOGRESOURCE)LOW_HouseOfHope_Archivist_144d4b6a-428c-b650-21a8-cb49dff74aff, S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306, _Player)
THEN
DB_LOW_HouseOfHope_ArchivistSaysGoodbye(1);

IF
DB_LOW_HouseOfHope_ArchivistWantsToSayGoodbye(1)
AND
NOT DB_LOW_HouseOfHope_ArchivistSaysGoodbye(1)
THEN
PROC_GLO_Monitor_EntityPoof(S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306);

IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
DB_LOW_HouseOfHope_ArchiveSkeletons(_Skeleton, _AD)
AND
_AD != NULL_00000000-0000-0000-0000-000000000000
THEN
PROC_ForceStopDialog(_Skeleton);
PROC_TryStartAD(_AD, _Skeleton);

IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
DB_LOW_HouseOfHope_ArchiveSkeletons(_Skeleton, _AD)
AND
_AD == NULL_00000000-0000-0000-0000-000000000000
THEN
PROC_ForceStopDialog(_Skeleton);
PROC_GLO_Monitor_EntityPoof(_Skeleton);

IF
AutomatedDialogEnded(_AD, _)
AND
DB_LOW_HouseOfHope_ArchiveSkeletons(_Skeleton, _AD)
THEN
PROC_GLO_Monitor_EntityPoof(_Skeleton);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_HouseOfHope_Event_ArchivistLeft_605964ba-fcd5-a9e5-999d-a08ff5e46c19)
THEN
PROC_GLO_Monitor_EntityPoof(S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306);

IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
THEN
Close((ITEM)S_LOW_HouseOfHope_ArchiveDoor_1edae04a-ce23-47cd-aeaa-24e1fc83f2f2);

//END_REGION

//REGION Guards

IF
DB_LOW_HouseOfHope_DebtorsIntoDemons(_, _Demon)
THEN
PROC_SetOnStage(_Demon, 0);
SetCombatGroupID(_Demon, "LOW_HouseOfHope_AlarmGuards");

/*
IF
AttackedBy(_Debtor, _Player, _, _, _, _, _)
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe)
AND
DB_LOW_HouseOfHope_DebtorsIntoDemons(_Debtor, _)
AND
DB_Players((CHARACTER)_Player)
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_HouseOfHope_Debtors_d7db90e1-e131-4c76-8787-7d5a881dbec7, 0);
*/

/*
QRY
QRY_CrimeGetCustomWarning(_Debtor, _Crime, _Dialog, _CrimeID)
AND
DB_LOW_HouseOfHope_DebtorsIntoDemons(_Debtor,_)
AND
CrimeGetCriminal(_CrimeID, 1, _Player)
THEN
DB_CrimeWarning_CustomDialog(_Debtor, _CrimeID, (DIALOGRESOURCE)LOW_HouseOfHope_Debtors_CrimeReaction_0cd083b3-ac0d-1863-e33c-e76b70462296);
*/

IF
DB_LOW_HouseOfHope_DebtorsIntoDemons(_Debtor,_)
THEN
DB_LOW_HouseOfHope_OverrideArrestDialogue((CHARACTER)_Debtor);

QRY
QRY_CrimeGetCustomArrestDialogCustom(_Debtor, _CrimeID, _Dialog, _, _, _, _)
AND
DB_LOW_HouseOfHope_OverrideArrestDialogue(_Debtor)
AND
CrimeGetType(_CrimeID, _Type)
AND
CrimeGetCriminal(_CrimeID, 1, _Player)
THEN
DB_CrimeArrest_CustomDialog(_Debtor, _CrimeID, (DIALOGRESOURCE)LOW_HouseOfHope_Debtors_CrimeReaction_0cd083b3-ac0d-1863-e33c-e76b70462296);

IF
DB_LOW_HouseOfHope_OverrideArrestDialogue(_Debtor)
THEN
PROC_CharacterDisableCrime(_Debtor,"DangerousMonsterReaction");
PROC_CharacterDisableCrime(_Debtor,"DangerousMonsterReactionFallback");

/*
IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
THEN
PROC_RemoveDBTrespassTrigger(S_LOW_HouseOfHope_CrimeTrigger_e5576bab-d1e9-4b26-b5bf-e2f35af5f01b);


IF
DB_PlayerTrespassing(_Player,_CrimeID,(TRIGGER)S_LOW_HouseOfHope_CrimeTrigger_e5576bab-d1e9-4b26-b5bf-e2f35af5f01b)
AND
DB_LOW_HouseOfHope_DebtorDisguised(_Player)
AND
CrimeIgnoreCriminal(_CrimeID,_Player,_Ignored)
THEN
DB_LOW_HouseOfHope_DebtorIgnored(_Player,_CrimeID);

IF
DB_LOW_HouseOfHope_DebtorIgnored(_Player,_CrimeID)
AND
DB_PlayerTrespassing(_Player,_CrimeID,(TRIGGER)S_LOW_HouseOfHope_CrimeTrigger_e5576bab-d1e9-4b26-b5bf-e2f35af5f01b)
THEN
NOT DB_PlayerTrespassing(_Player,_CrimeID,(TRIGGER)S_LOW_HouseOfHope_CrimeTrigger_e5576bab-d1e9-4b26-b5bf-e2f35af5f01b);

IF
DB_LOW_HouseOfHope_DebtorIgnored(_Player,_CrimeID)
AND
NOT DB_LOW_HouseOfHope_DebtorDisguised(_Player)
AND
CrimeStopIgnoringCriminal(_CrimeID,_Player,1)
THEN
NOT DB_LOW_HouseOfHope_DebtorIgnored(_Player,_CrimeID);
*/

IF
DB_Sees(_Debtor, _Player)
AND
DB_LOW_HouseOfHope_DebtorsIntoDemons(_Debtor,_)
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe)
AND
DB_Players(_Player)
AND
NOT DB_LOW_HouseOfHope_DebtorDisguised(_Player)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_HouseOfHope_Debtors_CrimeReaction_0cd083b3-ac0d-1863-e33c-e76b70462296, _Debtor, _Player)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_HouseOfHope_Event_PlayerNoticedWithoutDisguise_22552e14-248b-40ac-806d-2e26d2b800ef);


IF
StatusApplied((CHARACTER)_Player, "LOW_HOH_DEBTOR", _,_)
AND
NOT DB_LOW_HouseOfHope_DebtorDisguised(_Player)
THEN
DB_LOW_HouseOfHope_DebtorDisguised(_Player);
ObjectTimerCancel(_Player, "LOW_HOH_RemoveDisguise");

IF
StatusRemoved((CHARACTER)_Player, "LOW_HOH_DEBTOR", _,_)
AND
DB_LOW_HouseOfHope_DebtorDisguised(_Player)
AND
HasAppliedStatus(_Player, "LOW_HOH_DEBTOR", 0)
THEN
ObjectTimerLaunch(_Player, "LOW_HOH_RemoveDisguise", 500);

IF
ObjectTimerFinished((CHARACTER)_Player, "LOW_HOH_RemoveDisguise")
THEN
NOT DB_LOW_HouseOfHope_DebtorDisguised(_Player);

PROC
PROC_LOW_HouseOfHope_DisableDebtorCrimes()
AND
DB_LOW_HouseOfHope_DebtorsIntoDemons(_Debtor, _)
THEN
PROC_CharacterDisableCrime((CHARACTER)_Debtor, "Murder");
PROC_CharacterDisableCrime((CHARACTER)_Debtor, "KeepAnEyeOnMe");

// Actions for House of Hope guards will be changed by combat design: this is Whitebox implementation

PROC
PROC_StateSet_Defeated(_Debtor)
AND
DB_LOW_HouseOfHope_DebtorsIntoDemons(_Debtor, _Demon)
AND
IsOnStage(_Debtor, 1)
THEN
PROC_LOW_HouseOfHope_TurnIntoDemon(_Debtor);

PROC
PROC_LOW_HouseOfHope_TurnIntoDemon((GUIDSTRING)_Debtor)
AND
DB_LOW_HouseOfHope_DebtorsIntoDemons(_Debtor, _Demon)
THEN
NOT DB_LOW_HouseOfHope_DebtorsIntoDemons(_Debtor, _Demon);
DB_LOW_HouseOfHope_DebtorTransformed(_Debtor, _Demon);
TeleportTo(_Demon, _Debtor);
CreateExplosion(_Debtor, "Projectile_LOW_HouseOfHope_DebtorExplode", 4, _Debtor);
SetOnStage(_Debtor,0);
PROC_SetOnStage(_Demon, 1);


PROC
PROC_LOW_HouseOfHope_TurnIntoDemon((GUIDSTRING)_Debtor)
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe);

PROC
PROC_LOW_HouseOfHope_TurnIntoDemon((GUIDSTRING)_Debtor)
AND
QRY_OnlyOnce("LOW_HouseOfHope_DisableCrimesForDebtors")
THEN
PROC_LOW_HouseOfHope_DisableDebtorCrimes();


// Prepare for "ambush" if alarm started in Archive or in Prison

// Except the debtors who are in the combat - they will move only if they survive the combat


IF
EnteredCombat(_Guard,_)
AND
DB_LOW_HouseOfHope_DebtorsIntoDemons(_Guard, _)
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe)
THEN
SetFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe);

IF
EnteredCombat(_Guard,_)
AND
DB_LOW_HouseOfHope_DebtorsIntoDemons(_Guard, _)
AND
NOT DB_LOW_HouseOfHope_InAmbush(_Guard)
AND
NOT DB_LOW_HouseOfHope_CorridorGuards(_Guard)
THEN
DB_LOW_HouseOfHope_DelayTheAmbush(_Guard);
//UseSpell(_Guard, "Shout_LOW_HoH_Debtor_FlameBlade", _Guard);

IF
DB_LOW_HouseOfHope_DebtorTransformed(_Debtor, _Demon)
AND
DB_LOW_HouseOfHope_DelayTheAmbush(_Debtor)
THEN
NOT DB_LOW_HouseOfHope_DelayTheAmbush(_Debtor);
DB_LOW_HouseOfHope_DelayTheAmbush(_Demon);

IF
LeftCombat(_Debtor, _)
AND
IsOnStage(_Debtor, 1)
AND
DB_LOW_HouseOfHope_DelayTheAmbush(_Debtor)
AND
DB_LOW_HouseOfHope_DebtorsIntoDemons(_Debtor,_)
AND
DB_LOW_HouseOfHope_SetUpAmbush(_Debtor, _Point)
THEN
NOT DB_LOW_HouseOfHope_DelayTheAmbush(_Debtor);
PROC_GLO_Monitor_EntityPoof(_Debtor);
TeleportTo(_Debtor, _Point, "LOW_HouseOfHope_AmbushSetup");

IF
LeftCombat(_Demon, _)
AND
IsOnStage(_Demon, 1)
AND
DB_LOW_HouseOfHope_DelayTheAmbush(_Demon)
AND
DB_LOW_HouseOfHope_DebtorTransformed(_Debtor, _Demon)
AND
DB_LOW_HouseOfHope_SetUpAmbush(_Debtor, _Point)
THEN
NOT DB_LOW_HouseOfHope_DelayTheAmbush(_Demon);
PROC_GLO_Monitor_EntityPoof(_Demon);
TeleportTo(_Demon, _Point, "LOW_HouseOfHope_AmbushSetup");

PROC
PROC_StateSet_Defeated(_Guard)
AND
DB_LOW_HouseOfHope_DelayTheAmbush(_Guard)
THEN
NOT DB_LOW_HouseOfHope_DelayTheAmbush(_Guard);

PROC
PROC_LOW_HouseOfHope_SetAmbush()
AND
DB_LOW_HouseOfHope_DebtorsIntoDemons(_Debtor, _)
AND
DB_DialogNPCs(_Id,_Debtor,_)
AND
DialogGetInvolvedPlayer(_Id, 1, _Player)
THEN
DB_LOW_HouseOfHope_DelayTheAmbush(_Debtor);
PROC_ForceStopDialog(_Debtor);

PROC
PROC_LOW_HouseOfHope_SetAmbush()
AND
DB_LOW_HouseOfHope_SetUpAmbush(_Guard, _Point)
AND
NOT DB_LOW_HouseOfHope_CorridorGuards(_Guard)
AND
NOT DB_Defeated(_Guard)
AND
NOT DB_LOW_HouseOfHope_DelayTheAmbush(_Guard)
THEN
PROC_GLO_Monitor_EntityPoof(_Guard);
TeleportTo(_Guard, _Point, "LOW_HouseOfHope_AmbushSetup");

PROC
PROC_LOW_HouseOfHope_SetAmbush()
AND
DB_LOW_HouseOfHope_CorridorGuards(_Guard)
AND
DB_LOW_HouseOfHope_SetUpAmbush(_Guard, _Point)
AND
NOT DB_Defeated(_Guard)
THEN
PROC_CharacterMoveTo((CHARACTER)_Guard, _Point, "Run", "LOW_HouseOfHope_CorridorAmbushSetup");

IF
EntityEvent((CHARACTER)_Guard, "LOW_HouseOfHope_AmbushSetup")
AND
DB_LOW_HouseOfHope_SetUpAmbush(_Guard, _Point)
THEN
DB_LOW_HouseOfHope_InAmbush(_Guard);
LookFromTrigger(_Guard, _Point, 0);
PROC_GLO_Monitor_EntityFoop(_Guard);

IF
EntityEvent(_Demon, "LOW_HouseOfHope_AmbushSetup")
AND
DB_LOW_HouseOfHope_DebtorTransformed(_Debtor, _Demon)
AND
DB_LOW_HouseOfHope_SetUpAmbush(_Debtor, _Point)
THEN
DB_LOW_HouseOfHope_InAmbush(_Demon);
LookFromTrigger((CHARACTER)_Demon, _Point, 0);
PROC_GLO_Monitor_EntityFoop(_Demon);

IF
EntityEvent((CHARACTER)_Guard, "LOW_HouseOfHope_CorridorAmbushSetup")
AND
DB_LOW_HouseOfHope_SetUpAmbush(_Guard, _Point)
THEN
LookFromTrigger(_Guard, _Point, 0);

IF
EntityEvent((CHARACTER)_Guard, "LOW_HouseOfHope_AmbushSetup")
THEN
SetCombatGroupID(_Guard, "LOW_HouseOfHope_Debtors");

// Cast blade spells
/*
IF
EntityEvent((CHARACTER)_Guard, "LOW_HouseOfHope_CorridorAmbushSetup")
THEN
UseSpell(_Guard, "Shout_LOW_HoH_Debtor_FlameBlade", _Guard);

IF
EntityEvent((CHARACTER)_Guard, "LOW_HouseOfHope_AmbushSetup")
THEN
UseSpell(_Guard, "Shout_LOW_HoH_Debtor_FlameBlade", _Guard);
*/

//END_REGION

//REGION Alarm

// Pre-alarm state (blowing the horn)
IF
FlagSet((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe,_,_)
THEN
DB_LOW_HouseOfHope_AlarmIsReady(1);
PROC_MusicPlayGeneral("RaphaelsFinalAct");

/*
IF
FlagSet((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe,_,_)
AND
DB_InRegion(_Player, (TRIGGER)S_LOW_HouseOfHope_ArchiveArea_82f690d2-ecd3-4f25-a46b-8d445a06210c)
AND
DB_Players(_Player)
THEN
DB_LOW_HouseOfHope_HopeArchiveWarning(1);
*/

// Will redo that into alarm objects in House of Hope (no I'm not)
IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
QRY_OnlyOnce("LOW_HouseOfHope_AlarmSound")
AND
DB_PartyMembers(_Player)
AND
DB_InRegion(_Player, (TRIGGER)S_LOW_HouseOfHope_SUB_49462249-7f39-4b91-af1d-ba121c711213)
THEN
PlayHUDSound(_Player,"SE_CTY_HouseOfHope_AlarmSound_Start");
PROC_CameraShakeAroundObject(_Player,1000,5.0);
//PROC_ShakeCameraForTime(_Player, 2000, VFX_Script_Brainquake_01_07202ba2-fe9c-fc79-46e3-cc421fafc0e8, 1);

IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
DB_LOW_HouseOfHope_DebtorsIntoDemons(_Debtor, _)
AND
HasAppliedStatus(_Debtor, "LOW_HOH_ALARMED", 0)
THEN
ApplyStatus(_Debtor, "LOW_HOH_ALARMED", -1.0);

IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
DB_LOW_HouseOfHope_DebtorsIntoDemons(_, _Demon)
AND
HasAppliedStatus(_Demon, "LOW_HOH_ALARMEDDEMON", 0)
THEN
ApplyStatus(_Demon, "LOW_HOH_ALARMEDDEMON", -1.0);

IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
DB_LOW_HouseOfHope_DebtorTransformed(_, _Demon)
AND
HasAppliedStatus(_Demon, "LOW_HOH_ALARMEDDEMON", 0)
THEN
ApplyStatus(_Demon, "LOW_HOH_ALARMEDDEMON", -1.0);


IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
NOT DB_LOW_HouseOfHope_HopeIsFree(1)
THEN
PROC_TriggerRegisterForPlayers((TRIGGER)S_LOW_HouseOfHope_HopeLastHopeTrigger_992cda41-4d2f-49f5-b5ef-c42e6e5fa867);

IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
THEN
PROC_LOW_HouseOfHope_SetAmbush();

IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
THEN
PROC_LOW_HouseOfHope_SetAlarm();

/*
// Full Alarm Trigger

IF
DB_InRegion(_Player, _Trigger)
AND
DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
DB_LOW_HouseOfHope_InfernoTriggers(_Trigger,_)
AND 
DB_Players(_Player)
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_AlarmWentOff_c59585f1-8ece-4a97-9838-5b402a98eb85)
THEN
PROC_LOW_HouseOfHope_SetAlarm();

IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
DB_LOW_HouseOfHope_InfernoTriggers(_Trigger,_)
THEN
PROC_TriggerRegisterForPlayers(_Trigger);
*/

// Alarm state

PROC
PROC_LOW_HouseOfHope_SetAlarm()
THEN
SetFlag((FLAG)LOW_HouseOfHope_State_AlarmWentOff_c59585f1-8ece-4a97-9838-5b402a98eb85);

PROC
PROC_LOW_HouseOfHope_SetAlarm()
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_HouseOfHope_Debtors_d7db90e1-e131-4c76-8787-7d5a881dbec7, 0);


//END_REGION

//REGION Inferno

// Inferno start 
IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
NOT DB_LOW_HouseOfHope_DisableInferno(1)
AND
DB_LOW_HouseOfHope_InfernoTriggers(_Trigger,_)
THEN
PROC_TriggerRegisterForPlayers(_Trigger);

IF
DB_LOW_HouseOfHope_DisableInferno(1)
AND
DB_LOW_HouseOfHope_InfernoTriggers(_Trigger,_)
THEN
PROC_TriggerUnregisterForPlayers(_Trigger);


IF
EnteredTrigger(_Player, _Trigger)
AND
DB_LOW_HouseOfHope_InfernoTriggers(_Trigger, _ID)
THEN
PROC_LOW_HouseOfHope_LaunchInferno(_ID);

IF
DB_LOW_HouseOfHope_FlamingSpheres(_Sphere,_)
THEN
PROC_SetOnStage(_Sphere, 0);

PROC
PROC_LOW_HouseOfHope_LaunchInferno((INTEGER)_ID)
AND
DB_LOW_HouseOfHope_FlamingSpheres(_Sphere,_ID)
THEN
CreateExplosion(_Sphere, "Projectile_LOW_HouseOfHope_DebtorExplode", 4, _Sphere);
//PROC_GLO_Monitor_EntityFoop(_Sphere);
PROC_Appear(_Sphere);

PROC
PROC_LOW_HouseOfHope_LaunchInferno((INTEGER)_ID)
AND
DB_LOW_HouseOfHope_FlamingSpheres(_Sphere,_ID)
THEN
DB_LOW_HouseOfHope_SpheresActivated(1);
SetForceUpdate(_Sphere, 1);

PROC
PROC_LOW_HouseOfHope_LaunchInferno((INTEGER)_ID)
AND
DB_LOW_HouseOfHope_InfernoTriggers(_Trigger, _ID)
THEN
PROC_TriggerUnregisterForPlayers(_Trigger);

IF
LeftTrigger(_Player,(TRIGGER)S_LOW_HouseOfHope_SUB_49462249-7f39-4b91-af1d-ba121c711213)
AND
DB_LOW_HouseOfHope_InfernoInProgress(1)
AND
NOT QRY_TriggerEvents_AnyPlayerInTriggerSet("LOW_HouseOfHope")
AND
DB_LOW_HouseOfHope_SpheresActivated(1)
AND
DB_LOW_HouseOfHope_FlamingSpheres(_Sphere,_)
THEN
NOT DB_LOW_HouseOfHope_SpheresActivated(1);
SetForceUpdate(_Sphere, 0);

IF
EnteredTrigger(_Player,(TRIGGER)S_LOW_HouseOfHope_SUB_49462249-7f39-4b91-af1d-ba121c711213)
AND
DB_LOW_HouseOfHope_InfernoInProgress(1)
AND
NOT DB_LOW_HouseOfHope_SpheresActivated(1)
AND
DB_LOW_HouseOfHope_FlamingSpheres(_Sphere,_)
AND
IsOnStage(_Sphere, 1)
THEN
DB_LOW_HouseOfHope_SpheresActivated(1);
SetForceUpdate(_Sphere, 1);


// Launch Inferno

PROC
PROC_LOW_HouseOfHope_LaunchInferno()
AND
NOT DB_LOW_HouseOfHope_DisableInferno(1)
THEN
DB_LOW_HouseOfHope_InfernoInProgress(1);


// Disable inferno for good

IF
DB_LOW_HouseOfHope_DisableInferno(1)
THEN
NOT DB_LOW_HouseOfHope_InfernoInProgress(1);

IF
DB_LOW_HouseOfHope_DisableInferno(1)
AND
DB_LOW_HouseOfHope_FlamingSpheres(_Sphere,_)
AND
IsOnStage(_Sphere, 1)
THEN
SetForceUpdate(_Sphere, 0);
PROC_GLO_Monitor_EntityPoof(_Sphere);

PROC
PROC_StateSet_PermaDefeated(_Sphere)
AND
DB_LOW_HouseOfHope_FlamingSpheres((CHARACTER)_Sphere,_ID)
THEN
NOT DB_LOW_HouseOfHope_FlamingSpheres(_Sphere,_ID);
//PlayEffect(_Sphere, (EFFECTRESOURCE)VFX_Spells_Cast_Intent_Summon_TargetSummon_FlamingSphere_Spawn_01_92215af0-6989-58e9-0d34-70777962119b);
//PROC_GLO_Monitor_EntityPoof(_Sphere);
SetForceUpdate(_Sphere, 0);

//END_REGION

//REGION Boudoir

IF
FlagSet((FLAG)LOW_HouseOfHope_State_VisitedHouseOfHope_c8889a79-8277-48e9-afa0-e14f6359ea10,_,_)
THEN
Use((CHARACTER)S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, (ITEM)S_LOW_HouseOfHope_IncubusBed_5061d998-bd03-4f2d-9543-b6dfc7e3f7c2, "");


IF
DB_LOW_HouseOfHope_BoudoirImps(_Imp, _, _, _)
THEN
PROC_SetOnStage(_Imp, 0);


IF
DB_LOW_HouseOfHope_BoudoirImps(_Imp, _, _, _)
THEN
SetCombatGroupID(_Imp, "LOW_HouseOfHope_BoudoirGroup");

PROC
PROC_SpotPlayers_Spotted((CHARACTER)S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, "HoH_Incubus", _Player)
AND
QRY_GetClosestAvailableCharacterTo(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, 0, 0, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 1, 0, 0)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_PreferredPlayer,S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26,_,_)
AND
DB_InRegion(_PreferredPlayer, (TRIGGER)S_LOW_HouseOfHope_IncubusTrigger_Room_1797390e-7d4b-4e16-862e-d3eed5162549)
THEN
DB_LOW_HouseOfHope_PlayerInIncubusDialogue(_PreferredPlayer);

PROC
PROC_SpotPlayers_Spotted((CHARACTER)S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, "HoH_Incubus", _Player)
AND
NOT DB_LOW_HouseOfHope_PlayerInIncubusDialogue(_)
THEN
DB_LOW_HouseOfHope_PlayerInIncubusDialogue(_Player);

QRY
QRY_SelectCustomDialog((CHARACTER)S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, (CHARACTER)_Player)
AND
QRY_SpeakerIsAvailable(_Player)
THEN
DB_LOW_HouseOfHope_PlayerInIncubusDialogue(_Player);

IF
DB_LOW_HouseOfHope_PlayerInIncubusDialogue(_Player)
THEN
Transform((CHARACTER)S_LOW_HouseOfHope_IncubusTransformedIntoPlayer_c416cf25-0538-48eb-a504-427b98aeaec8, _Player, (SHAPESHIFTRULE)DisguiseWithCustomLooksKeepNameAndIcon_b40d9ab4-57a7-4632-b8d7-188904b00606);


IF
DB_LOW_HouseOfHope_PlayerInIncubusDialogue(_PreferredPlayer)
AND
QRY_SpeakerIsAvailable(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_HouseOfHope_Incubus_8cfa157e-33c6-28d9-96fc-e1aaed1d8006, S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, 
(CHARACTER)S_LOW_HouseOfHope_Succubus_6060f41a-0d78-471e-89a6-4ef41d46ce6d, (CHARACTER)S_LOW_HouseOfHope_IncubusTransformedIntoPlayer_c416cf25-0538-48eb-a504-427b98aeaec8, _PreferredPlayer)
AND
QRY_OnlyOnce("LOW_HouseOfHope_IncubusDialogue")
THEN
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)LOW_HouseOfHope_Incubus_8cfa157e-33c6-28d9-96fc-e1aaed1d8006, (TRIGGER)S_LOW_HouseOfHope_IncubusTrigger_Room_1797390e-7d4b-4e16-862e-d3eed5162549, 1);

// Restarting the dialogue with Succubus speaker
IF
DialogEnded((DIALOGRESOURCE)LOW_HouseOfHope_Incubus_8cfa157e-33c6-28d9-96fc-e1aaed1d8006, _)
AND
DB_GlobalFlag((FLAG)LOW_HouseOfHope_Event_IncubusRestartDialogue_88005815-ff73-ac9c-1a12-9bb108de43ea)
AND
DB_LOW_HouseOfHope_PlayerInIncubusDialogue(_PreferredPlayer)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_HouseOfHope_Incubus_8cfa157e-33c6-28d9-96fc-e1aaed1d8006, S_LOW_HouseOfHope_Succubus_6060f41a-0d78-471e-89a6-4ef41d46ce6d, 
NULL_00000000-0000-0000-0000-000000000000, (CHARACTER)S_LOW_HouseOfHope_IncubusTransformedIntoPlayer_c416cf25-0538-48eb-a504-427b98aeaec8, _PreferredPlayer)
THEN
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)LOW_HouseOfHope_Incubus_8cfa157e-33c6-28d9-96fc-e1aaed1d8006, (TRIGGER)S_LOW_HouseOfHope_IncubusTrigger_Room_1797390e-7d4b-4e16-862e-d3eed5162549, 1);
ClearFlag((FLAG)LOW_HouseOfHope_Event_IncubusRestartDialogue_88005815-ff73-ac9c-1a12-9bb108de43ea);
DB_LOW_HouseOfHope_DialogWithSuccubus(1);

IF
DialogStarted((DIALOGRESOURCE)LOW_HouseOfHope_Incubus_8cfa157e-33c6-28d9-96fc-e1aaed1d8006, _ID)
AND
DB_LOW_HouseOfHope_DialogWithSuccubus(1)
THEN
PROC_DialogAddListeningActor(_ID, (CHARACTER)S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26);


// If for some reason Incubus is not available for a dialogue, then start the combat 
IF
DB_LOW_HouseOfHope_PlayerInIncubusDialogue(_Player)
AND
NOT DB_OnlyOnce("LOW_HouseOfHope_IncubusDialogue")
AND
NOT QRY_SpeakerIsAvailable(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26)
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_HouseOfHope_Incubus_c379b3f1-9f7b-411a-897c-228b7db333ff, 0);

QRY
QRY_ShouldNotAddCharacterInTriggerToDialog(_Char,(DIALOGRESOURCE)LOW_HouseOfHope_Incubus_8cfa157e-33c6-28d9-96fc-e1aaed1d8006,(TRIGGER)S_LOW_HouseOfHope_IncubusTrigger_Room_1797390e-7d4b-4e16-862e-d3eed5162549)
AND
DB_HiddenCharacters(_Char,_)
THEN
DB_LOW_HouseOfHope_HiddenBoudoirCharacters(_Char);

IF
DB_LOW_HouseOfHope_HiddenBoudoirCharacters(_Player)
AND
NOT DB_HiddenCharacters(_Player,_)
AND
DB_InRegion(_Player,(TRIGGER)S_LOW_HouseOfHope_IncubusTrigger_Room_1797390e-7d4b-4e16-862e-d3eed5162549)
AND
DB_DialogName((DIALOGRESOURCE)LOW_HouseOfHope_Incubus_8cfa157e-33c6-28d9-96fc-e1aaed1d8006, _DialogID)
THEN
PROC_DialogAddListeningActor(_DialogID,_Player);

IF
FlagSet((FLAG)LOW_HouseOfHope_Event_GetNaked_e71e9de1-2efd-eb6d-203f-bac5e4657dec, _, _ID)
AND
DB_LOW_HouseOfHope_PlayerInIncubusDialogue(_Player)
THEN
ApplyStatus(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, "LOW_INCUBUS_GETNAKED_USED", -1.0);
PROC_LOW_HouseOfHope_GetNaked((CHARACTER)_Player);
//TeleportTo(_Player, S_LOW_HouseOfHope_GetNakedSpot_db9294f3-0c2f-4b89-b3c2-0b05d88ab095, "", 0, 1, 1);

PROC
PROC_LOW_HouseOfHope_GetNaked((CHARACTER)_Player)
AND
DB_EquippedItemSlots(_Slot)
AND
GetEquippedItem(_Player, _Slot, _Item)
AND
_Slot != "Underwear"
THEN
Unequip(_Player, _Item);
DB_LOW_HouseOfHope_Naked(_Player);

IF
FlagSet((FLAG)LOW_HouseOfHope_Event_TimeForBed_218d22ac-2711-1405-a04e-5aab2514c5cb, _Player, _)
THEN
Use((CHARACTER)_Player, (ITEM)S_LOW_HouseOfHope_IncubusBed_5061d998-bd03-4f2d-9543-b6dfc7e3f7c2, "");

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_HouseOfHope_Event_IncubusLeft_aa307994-517c-f21a-e85c-37b6c4ef3062)
THEN
PROC_LOW_HouseOfHope_ChangePortrait();
PROC_GLO_Monitor_EntityPoof(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26);

// Incubus takes the mind

PROC
PROC_FlagReactionAfterDialog((CHARACTER)_Character, (FLAG)LOW_HouseOfHope_Event_IncubusTakesSoul_5ead8df3-e706-7997-64cd-7cd059466490)
AND
DB_Avatars(_Character)
THEN
Die(_Character, DEATHTYPE.Psychic, S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, 0, 1, 0.0);
MusicPlayGeneral("Music_Game_Over");
ShowGameOverMenu("");

PROC
PROC_FlagReactionAfterDialog((CHARACTER)_Character, (FLAG)LOW_HouseOfHope_Event_IncubusTakesSoul_5ead8df3-e706-7997-64cd-7cd059466490)
AND
NOT DB_Avatars(_Character)
THEN
PROC_LOW_HouseOfHope_BoudoirKeyLeftover();
Die(_Character, DEATHTYPE.Psychic, S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, 0, 1, 0.0);
PROC_Origins_CompanionLeavePermanently(_Character, "Killed");
PROC_GLO_Monitor_EntityPoof(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26);

PROC
PROC_LOW_HouseOfHope_BoudoirKeyLeftover()
AND
GetFlag((FLAG)LOW_HouseOfHope_State_HasSoulVesselKey_b1fddcec-e7b8-edd9-89b2-1c996a1546f1, S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, 1)
THEN
TeleportTo(S_LOW_HouseOfHope_SoulVesselKey_0519bffd-55d0-47be-a39f-d24f10260b56, (TRIGGER)S_LOW_HouseOfHope_KeySpot_0495df64-e3c8-46b3-a6c3-f67884f6a163, "", 0, 0, 0, 0, 0);

// Shapeshifting

IF
FlagSet((FLAG)LOW_HouseOfHope_Event_SwitchIncubusIntoSuccubus_3250e89a-f9b4-6d87-a76e-8920d2c50d0c,_,_)
THEN
DB_LOW_HouseOfHope_IncubusIsSuccubus(1);
Transform(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26,(CHARACTERROOT)QUEST_LOW_HouseOfHope_Incubus_FemaleForm_14ac9a0f-02ab-422f-b848-069c717d4203,
(SHAPESHIFTRULE)LOW_HoH_Incubus_eac6b9bf-e895-4675-887c-1acca6e3fcb9); 
ClearFlag((FLAG)LOW_HouseOfHope_Event_SwitchIncubusIntoSuccubus_3250e89a-f9b4-6d87-a76e-8920d2c50d0c);

IF
FlagSet((FLAG)LOW_HouseOfHope_Event_SwitchSuccubusIntoIncubus_4d70c25a-1f77-445d-a735-4a2739f4d912,_,_)
THEN
NOT DB_LOW_HouseOfHope_IncubusIsSuccubus(1);
RemoveTransforms(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26);
ClearFlag((FLAG)LOW_HouseOfHope_Event_SwitchSuccubusIntoIncubus_4d70c25a-1f77-445d-a735-4a2739f4d912);


IF
DB_Dead(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26)
AND
DB_LOW_HouseOfHope_IncubusIsSuccubus(1)
THEN
RealtimeObjectTimerLaunch(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, "LOW_HouseOfHope_TransformDeadIncubus", 1000);


IF
ObjectTimerFinished(_, "LOW_HouseOfHope_TransformDeadIncubus")
THEN
Transform(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26,(CHARACTERROOT)QUEST_LOW_HouseOfHope_Incubus_MaleForm_25498064-744e-479c-809f-f36ecd5eb264,
(SHAPESHIFTRULE)LOW_HoH_Incubus_eac6b9bf-e895-4675-887c-1acca6e3fcb9); 


IF
FlagSet((FLAG)LOW_HouseOfHope_Event_TransferKeyToSuccubusIfRequired_75bc862e-00f1-e2c0-8419-018225738f03,_,_)
AND
DB_LOW_HouseOfHope_DialogWithSuccubus(1)
AND
GetFlag((FLAG)LOW_HouseOfHope_State_HasSoulVesselKey_b1fddcec-e7b8-edd9-89b2-1c996a1546f1, S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, 1)
THEN
ToInventory((ITEM)S_LOW_HouseOfHope_SoulVesselKey_0519bffd-55d0-47be-a39f-d24f10260b56, S_LOW_HouseOfHope_Succubus_6060f41a-0d78-471e-89a6-4ef41d46ce6d);

// Incubus will be very disappointed if players would try to damage the bed

IF
AttackedBy((ITEM)S_LOW_HouseOfHope_IncubusBed_5061d998-bd03-4f2d-9543-b6dfc7e3f7c2, (CHARACTER)_Player, _,_,_,_,_)
AND
DB_Sees((CHARACTER)S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, _Player)
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_HouseOfHope_Incubus_c379b3f1-9f7b-411a-897c-228b7db333ff, 0);

IF
DB_PermaDefeated(S_LOW_HouseOfHope_IncubusBed_5061d998-bd03-4f2d-9543-b6dfc7e3f7c2)
THEN
PROC_LOW_HouseOfHope_SetIncubusHostile();


// Incubus will call imps if he's in combat
// Using the end of the turn, because there's a chance that Incubus is on another plane on the start of the turn

IF
TurnStarted((CHARACTER)S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26)
THEN
PROC_LOW_HouseOfHope_IncubusCallingForHelp();

IF
TurnEnded((CHARACTER)S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26)
THEN
PROC_LOW_HouseOfHope_IncubusCallingForHelp();


// Imps behaviour

PROC
PROC_LOW_HouseOfHope_BoudoirImpAppear((CHARACTER)_Imp, (GUIDSTRING)_Entrance, (GUIDSTRING)_Target, (STRING)_MoveEvent)
THEN
PROC_SetOnStage(_Imp, 1);
AppearAt(_Imp, _Entrance, 1, (ANIMATION)CUST_ImpDrop_01_0bf529ab-710a-46cc-9c4b-f3b54c47f25f, "LOW_HouseOfHope_BoudoirImpAppeared");
DB_LOW_HouseOfHope_BoudoirMoveEvent(_Imp, _Target, _MoveEvent);

IF
EntityEvent((CHARACTER)_Imp, "LOW_HouseOfHope_BoudoirImpAppeared")
AND
DB_LOW_HouseOfHope_BoudoirMoveEvent(_Imp, _Target, _MoveEvent)
THEN
NOT DB_LOW_HouseOfHope_BoudoirMoveEvent(_Imp, _Target, _MoveEvent);
PROC_CharacterMoveTo(_Imp, _Target, "Run", _MoveEvent);

IF
EntityEvent(_Imp, "LOW_HouseOfHope_ImpReadyToWatch")
THEN
LookAtEntity((CHARACTER)_Imp, S_LOW_HouseOfHope_IncubusBed_5061d998-bd03-4f2d-9543-b6dfc7e3f7c2, 5.0);

IF
FlagSet((FLAG)LOW_HouseOfHope_Event_IncubusSentAwayImps_54a5b82d-e972-4878-ecb4-8614070ccfb3,_,_)
AND
DB_LOW_HouseOfHope_BoudoirImps(_Imp, _, _, _Exit)
THEN
PROC_CharacterMoveTo(_Imp, _Exit, "Run", "LOW_HouseOfHope_ImpReadyToLeave");

IF
EntityEvent(_Imp, "LOW_HouseOfHope_ImpReadyToLeave")
THEN
PROC_Poof(_Imp);

PROC
PROC_LOW_HouseOfHope_SetIncubusHostile()
AND
IsInCombat(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, 0)
AND
IsOnStage(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, 1)
THEN
PROC_LOW_HouseOfHope_IncubusCallingForHelp();

PROC
PROC_LOW_HouseOfHope_SetIncubusHostile()
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_HouseOfHope_Incubus_c379b3f1-9f7b-411a-897c-228b7db333ff, 0);


// Setup for Hostile Haarlep


IF 
FlagSet((FLAG)LOW_HouseOfHope_Event_IncubusCallsForHelp_c2b33188-206f-2967-a972-89472ce67e5f, _,_)
AND
DB_LOW_HouseOfHope_BoudoirImps(_Imp, _Entrance, _Place, _)
AND
IsOnStage(_Imp, 0)
THEN
PROC_LOW_HouseOfHope_BoudoirImpAppear(_Imp, _Entrance, _Place, "");

QRY
QRY_LOW_HouseOfHope_BoudoirImpsNotOnStage()
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_Event_IncubusCallsForHelp_c2b33188-206f-2967-a972-89472ce67e5f)
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_Event_ImpAlarmed_3c7fffc9-d2a4-e6b4-592e-0f97c14f4e7b)
THEN
DB_NOOP(1);


PROC
PROC_LOW_HouseOfHope_IncubusCallingForHelp()
AND
HasActiveStatus(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, "SURPRISED", 0)
AND
QRY_LOW_HouseOfHope_BoudoirImpsNotOnStage()
AND
DB_LOW_HouseOfHope_IncubusIsSuccubus(1)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_SuccubusCallsForHelp_cd5b00f6-9e1c-1c4a-ed7d-4763c6729c68, (CHARACTER)S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26);

PROC
PROC_LOW_HouseOfHope_IncubusCallingForHelp()
AND
HasActiveStatus(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, "SURPRISED", 0)
AND
QRY_LOW_HouseOfHope_BoudoirImpsNotOnStage()
AND
NOT DB_LOW_HouseOfHope_IncubusIsSuccubus(1)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_IncubusCallsForHelp_2eca98a4-2dae-b1de-23ca-cbef681267d5, (CHARACTER)S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26);

// Incubus Naked spell behaviour

IF
StatusApplied((CHARACTER)_Char,"DISARM_INCUBUS",_,_)
THEN
PROC_LOW_HouseOfHope_GetNaked(_Char);

// Combat Wait when the incubus returns from the ethereal plane to give them time to calculate their actions
IF
StatusRemoved(_Incubus,"ETHEREALNESS_INCUBUS",_,_)
THEN
SetEntityEventReal(_Incubus,"GLO_CombatWait",1.0);

// Raphael's notes

PROC
PROC_LOW_HouseOfHope_SetUpTreasures()
AND
DB_GlobalFlag((FLAG)GLO_Raphael_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
THEN
ToInventory((ITEM)S_LOW_HouseOfHope_MasterKeyword_AfterDeal_8057c70c-21b8-4cb7-8926-c92a2c40df3c, S_LOW_HouseOfHope_SoulVesselSafe_adb5581e-b1cf-4d3e-9ace-5c75adfa2f47);

PROC
PROC_LOW_HouseOfHope_SetUpTreasures()
AND
NOT DB_GlobalFlag((FLAG)GLO_Raphael_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
THEN
ToInventory((ITEM)S_LOW_HouseOfHope_MasterKeyword_dcd74338-b779-4387-9748-8f8a2b29230e, S_LOW_HouseOfHope_SoulVesselSafe_adb5581e-b1cf-4d3e-9ace-5c75adfa2f47);

IF
UseFinished(_Player, (ITEM)_Item, 1)
AND
DB_LOW_HouseOfHope_MasterKeywordNotes(_Item)
AND
QRY_OnlyOnce("LOW_HouseOfHope_KeywordVBPlayed")
THEN
PROC_GlobalSetFlagAndCache((FLAG)GLO_Orpheus_Knows_OrphicHammerIsTheKey_980541fb-1483-ea1a-3387-64405eace9a2);
SetFlag((FLAG)LOW_HouseOfHope_Knows_MasterKeyword_e18062be-03c7-7249-bca2-e7a71159020a);
SetFlag((FLAG)LOW_HouseOfHope_Knows_TreasureInArchive_b213dfe2-6afb-9772-d748-9ba9430a6aae);
StartVoiceBark((VOICEBARKRESOURCE)LOW_HouseOfHope_VB_MagicKeyword_bded5d97-9145-988f-1f67-84024843fc6f, _Player);

// Handling a magic door for Boudoir

IF
UseFinished(_Player, (ITEM)S_LOW_HouseOfHope_BoudoirMagicField_938fd73b-e975-4907-8cd8-3755daa5dddc, 1)
AND
GetFlag((FLAG)LOW_HouseOfHope_State_HasBoudoirKey_7ae2dc78-5a8e-8ce3-8047-5b4180004c70, _Player, 0)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_BoudoirField_34259422-3379-7b05-dba3-c3dca075ad7e, (ITEM)S_LOW_HouseOfHope_MagicFieldSpeaker_c4618af3-7712-42c1-9126-8a77f4f29d9d);

IF
UseFinished(_Player, (ITEM)S_LOW_HouseOfHope_BoudoirMagicField_938fd73b-e975-4907-8cd8-3755daa5dddc, 1)
AND
GetFlag((FLAG)LOW_HouseOfHope_State_HasBoudoirKey_7ae2dc78-5a8e-8ce3-8047-5b4180004c70, _Player, 1)
THEN
PROC_LOW_HouseOfHope_RemoveBoudoirField();


IF
DualEntityEvent(_, _, "LOW_HouseOfHope_OpenBoudoir")
THEN
PROC_LOW_HouseOfHope_RemoveBoudoirField();

PROC
PROC_LOW_HouseOfHope_RemoveBoudoirField()
AND
QRY_OnlyOnce("LOW_HouseOfHope_OpenBoudoir")
THEN
//Die(S_LOW_HouseOfHope_BoudoirMagicField_938fd73b-e975-4907-8cd8-3755daa5dddc);
SetPortalIsOpen(S_LOW_HouseOfHope_BoudoirMagicField_938fd73b-e975-4907-8cd8-3755daa5dddc, 1);
RemoveStatus(S_LOW_HouseOfHope_BoudoirMagicField_938fd73b-e975-4907-8cd8-3755daa5dddc, "LOW_HOH_BOUDOIRMAGICFIELD",NULL_00000000-0000-0000-0000-000000000000);
RealtimeObjectTimerLaunch((ITEM)S_LOW_HouseOfHope_BoudoirMagicField_938fd73b-e975-4907-8cd8-3755daa5dddc, "LOW_HouseOfHope_RemoveField", 1000);

IF
ObjectTimerFinished((ITEM)S_LOW_HouseOfHope_BoudoirMagicField_938fd73b-e975-4907-8cd8-3755daa5dddc, "LOW_HouseOfHope_RemoveField")
THEN
PROC_SetOnStage(S_LOW_HouseOfHope_BoudoirMagicField_938fd73b-e975-4907-8cd8-3755daa5dddc, 0);

/*
IF 
StatusRemoved(S_LOW_HouseOfHope_BoudoirMagicField_938fd73b-e975-4907-8cd8-3755daa5dddc, "LOW_HOH_BOUDOIRMAGICFIELD",_,_)
THEN

PROC_GLO_Monitor_EntityPoof(S_LOW_HouseOfHope_BoudoirMagicField_938fd73b-e975-4907-8cd8-3755daa5dddc);
*/

// Picture is trapped, and it will create an explosion and call the imps if the Incubus scene wasn't resolved

IF
UseFinished(_Player,(ITEM)S_LOW_HouseOfHope_PortraitButton_71a0ee93-bbbd-4fff-89ff-b7bb11c14e67,1)
AND
IsTrapArmed((ITEM)S_LOW_HouseOfHope_RaphaelVaultPortrait_1fae37f9-0ac6-4ebd-9378-702bb1946002, 1)
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_Event_IncubusLeft_aa307994-517c-f21a-e85c-37b6c4ef3062)
AND
QRY_OnlyOnce("LOW_HouseOfHope_BoudoirTrapTriggered")
THEN
PROC_LOW_HouseOfHope_ChangePortrait();
UseSpell((ITEM)S_LOW_HouseOfHope_PortraitFireballSender_e1896084-223b-414c-9559-5d62a69dcd71, "Projectile_Fireball_Trap_Hard", (TRIGGER)S_LOW_HouseOfHope_PortraitTrapFireball_efbeb651-df8c-481f-8ff6-c20e5e124739);
//CreateExplosion((S_LOW_HouseOfHope_PortraitTrapFireball_, "Projectile_Fireball_Trap_Hard", 4);
PROC_ForceStopDialog((CHARACTER)S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26);
PROC_GlobalSetFlagAndCache((FLAG)LOW_HouseOfHope_Event_IncubusCallsForHelp_c2b33188-206f-2967-a972-89472ce67e5f);
PROC_LOW_HouseOfHope_SetIncubusHostile();


PROC
PROC_LOW_HouseOfHope_ChangePortrait()
THEN
SetTrapArmed((ITEM)S_LOW_HouseOfHope_RaphaelVaultPortrait_1fae37f9-0ac6-4ebd-9378-702bb1946002, 0);
PROC_SetOnStage((ITEM)S_LOW_HouseOfHope_RaphaelVaultPortrait_1fae37f9-0ac6-4ebd-9378-702bb1946002, 0);
PROC_SetOnStage((ITEM)S_LOW_HouseOfHope_RaphaelVaultPortrait_Untrapped_bff88066-6679-4d1b-b908-2d57d4062ba9, 1);

// Button/portrait logic

IF
UseFinished(_,(ITEM)S_LOW_HouseOfHope_PortraitButton_71a0ee93-bbbd-4fff-89ff-b7bb11c14e67,1)
AND
QRY_OnlyOnce("LOW_HouseOfHope_PortraitMoved")
THEN
PROC_SetOnStage(S_LOW_HouseOfHope_SoulVesselSafe_adb5581e-b1cf-4d3e-9ace-5c75adfa2f47, 1);
ItemMoveTo((ITEM)S_LOW_HouseOfHope_RaphaelVaultPortrait_Untrapped_bff88066-6679-4d1b-b908-2d57d4062ba9, (TRIGGER)S_LOW_HouseOfHope_RaphaelVaultPortrait_UpState_00ee1521-1a44-4429-bddb-aeda94001e2c, 1.0, 0.0, 0, "");
ItemMoveTo((ITEM)S_LOW_HouseOfHope_RaphaelVaultPortrait_1fae37f9-0ac6-4ebd-9378-702bb1946002, (TRIGGER)S_LOW_HouseOfHope_RaphaelVaultPortrait_UpState_00ee1521-1a44-4429-bddb-aeda94001e2c, 1.0, 0.0, 0, "");

// Surprise Haarlep logic

IF
FlagSet((FLAG)LOW_HouseOfHope_Event_RemovedIncubusCharm_3a253cbc-dff8-94e7-a75d-0e655f8ffb03, _,_)
THEN
PROC_MakeSurprised((CHARACTER)S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26);

// Warning about debtor clothes

IF
StatusApplied((CHARACTER)_Player, "LOW_HOH_DEBTOR", _, _)
AND
DB_LOW_HouseOfHope_UsedDisguiseAtLeastOnce(_Player)
AND
DB_LOW_HouseOfHope_Naked(_Player)
AND
NOT DB_LOW_HouseOfHope_WearedClothesBack(_Player)
THEN
DB_LOW_HouseOfHope_WearedClothesBack(_Player);

IF
EnteredTrigger(_Player,(TRIGGER)S_LOW_HouseOfHope_BoudoirDebtorWarning_0072d2ef-4a19-4d63-880d-518818148110)
AND
DB_LOW_HouseOfHope_UsedDisguiseAtLeastOnce(_Player)
AND
DB_LOW_HouseOfHope_Naked(_Player)
AND
NOT DB_LOW_HouseOfHope_WearedClothesBack(_Player)
THEN
PROC_LOW_HouseOfHope_EquipDebtorClothesBack(_Player);

PROC
PROC_LOW_HouseOfHope_EquipDebtorClothesBack((CHARACTER)_Player)
THEN
PROC_NotifyWhenReadyToTalk(_Player, "LOW_HouseOfHope_WearClothesBack");

PROC
PROC_ReadyToTalk(_Player, "LOW_HouseOfHope_WearClothesBack")
AND
NOT DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
NOT DB_LOW_HouseOfHope_WearedClothesBack(_Player)
AND
DB_InRegion(_Player, (TRIGGER)S_LOW_HouseOfHope_BoudoirDebtorWarning_0072d2ef-4a19-4d63-880d-518818148110)
THEN
DB_LOW_HouseOfHope_WearedClothesBack(_Player);
PROC_LOW_HouseOfHope_PlayDisguiseWarning(_Player);

PROC
PROC_LOW_HouseOfHope_PlayDisguiseWarning((CHARACTER)_Player)
AND
QRY_OnlyOnce("LOW_HouseOfHope_DisguiseWarningPlayed")
THEN
PROC_TryStartAD(LOW_HouseOfHope_PAD_BoudoirDisguiseWarning_8c45a8ea-55a8-4c7f-511c-396ea144cf53, _Player);

IF
DB_LOW_HouseOfHope_WearedClothesBack(_Player)
AND
NOT DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
DB_LOW_HouseOfHope_DebtorTemplates(_Template)
AND
GetItemByTemplateInInventory((ITEMROOT)_Template, _Player, _Item)
THEN
Equip(_Player, _Item);

IF
LeftTrigger(_Player, S_LOW_HouseOfHope_IncubusTrigger_Room_1797390e-7d4b-4e16-862e-d3eed5162549)
AND
DB_NotifyWhenReadyToTalk(_Player, "LOW_HouseOfHope_WearClothesBack", _)
THEN
PROC_NotifyWhenReadyToTalk_Cancel(_Player, "LOW_HouseOfHope_WearClothesBack");

IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
THEN
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_HouseOfHope_BoudoirDebtorWarning_0072d2ef-4a19-4d63-880d-518818148110);

IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
DB_LOW_HouseOfHope_Naked(_Player)
AND
NOT DB_LOW_HouseOfHope_WearedClothesBack(_Player)
THEN
DB_LOW_HouseOfHope_WearedClothesBack(_Player);

// Alarm logic

IF 
DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_Event_IncubusLeft_aa307994-517c-f21a-e85c-37b6c4ef3062)
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_PlayersStoleMainTreasure_ffa3d3be-d30f-296f-d794-4c24d63eb25c)
THEN
PROC_LOW_HouseOfHope_SetIncubusAlarm();

PROC
PROC_LOW_HouseOfHope_SetIncubusAlarm()
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_HouseOfHope_Incubus_c379b3f1-9f7b-411a-897c-228b7db333ff, 0);
PROC_LOW_HouseOfHope_RemoveBoudoirField();
PROC_GlobalSetFlagAndCache((FLAG)LOW_HouseOfHope_Event_ImpAlarmed_3c7fffc9-d2a4-e6b4-592e-0f97c14f4e7b);

PROC
PROC_LOW_HouseOfHope_SetIncubusAlarm()
THEN
PROC_CharacterMoveTo((CHARACTER)S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, S_LOW_HouseOfHope_IncubusAlarmPlace_455af35d-9724-492d-a172-3d4112ad3197, "Run", "");

PROC
PROC_LOW_HouseOfHope_SetIncubusAlarm()
THEN
ApplyStatus(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, "LOW_INCUBUS_GETNAKED_USED", -1.0);

PROC
PROC_LOW_HouseOfHope_SetIncubusAlarm()
AND
DB_LOW_HouseOfHope_BoudoirImpsAfterAlarm(_Imp, _Entrance, _AlarmSpot)
THEN
PROC_SetOnStage(_Imp, 1);
AppearAt(_Imp, _Entrance, 1, (ANIMATION)CUST_ImpDrop_01_0bf529ab-710a-46cc-9c4b-f3b54c47f25f, "LOW_HouseOfHope_BoudoirImpAlarmAppeared");

IF
EntityEvent((CHARACTER)_Imp, "LOW_HouseOfHope_BoudoirImpAlarmAppeared")
AND
DB_LOW_HouseOfHope_BoudoirImpsAfterAlarm(_Imp, _Entrance, _AlarmSpot)
THEN
PROC_CharacterMoveTo(_Imp, _AlarmSpot, "Run", "");

IF
FlagSet((FLAG)LOW_HouseOfHope_State_PlayersStoleMainTreasure_ffa3d3be-d30f-296f-d794-4c24d63eb25c,_,_)
AND
NOT DB_PermaDefeated(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26)
AND
IsOnStage(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, 1)
AND
NOT DB_Is_InCombat(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26,_)
THEN
PROC_GLO_Monitor_EntityPoof(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26);

// Master Keyword shielding

IF
MovedFromTo((ITEM)_RaphaelNote, _, _CampChest, 0)
AND
DB_LOW_HouseOfHope_MasterKeywordNotes(_RaphaelNote)
AND
GetTemplate(_CampChest, (ROOT)_Root)
AND
DB_LOW_HouseOfHope_PlayerContainers(_Root)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("LOW_HouseOfHope_KeywordVBPlayed")
THEN
PROC_GlobalSetFlagAndCache((FLAG)GLO_Orpheus_Knows_OrphicHammerIsTheKey_980541fb-1483-ea1a-3387-64405eace9a2);
SetFlag((FLAG)LOW_HouseOfHope_Knows_MasterKeyword_e18062be-03c7-7249-bca2-e7a71159020a);
SetFlag((FLAG)LOW_HouseOfHope_Knows_TreasureInArchive_b213dfe2-6afb-9772-d748-9ba9430a6aae);
StartVoiceBark((VOICEBARKRESOURCE)LOW_HouseOfHope_VB_MagicKeyword_bded5d97-9145-988f-1f67-84024843fc6f, _Player);

// Crime bits

IF
FlagSet((FLAG)LOW_HouseOfHope_Event_IncubusLeft_aa307994-517c-f21a-e85c-37b6c4ef3062,_,_)
THEN
ClearOwnership((ITEM)S_LOW_HouseOfHope_PortraitButton_71a0ee93-bbbd-4fff-89ff-b7bb11c14e67);
ClearOwnership((ITEM)S_LOW_HouseOfHope_SoulVesselSafe_adb5581e-b1cf-4d3e-9ace-5c75adfa2f47);

IF
DialogForceStopping((DIALOGRESOURCE)LOW_HouseOfHope_Incubus_8cfa157e-33c6-28d9-96fc-e1aaed1d8006, _)
THEN
PROC_LOW_HouseOfHope_SetIncubusHostile();

//END_REGION

//REGION Treasures

PROC
PROC_LOW_HouseOfHope_SetUpTreasures()
AND
NOT DB_GlobalFlag((FLAG)GLO_Raphael_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
THEN
PROC_SetOnStage((ITEM)S_LOW_HouseOfHope_PlayerContract_69119dc3-2c26-4e50-8430-ef427d05ef7f, 0);


// WHITEBOX IMPLEMENTATION (?)
PROC
PROC_BlockPickupOfItem(_Player, _Treasure)
AND
NOT DB_LOW_HouseOfHope_UnlockTreasures(1)
AND
DB_LOW_HouseOfHope_Treasures(_Treasure, _Trigger, _Blocker)
AND
IsInTrigger(_Treasure, _Trigger, 1)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_HouseOfHope_TreasureBlocker_935fb111-b7a6-4751-07cd-2d3c16799207, _Blocker, _Player)
THEN
DB_NOOP(1);

PROC
PROC_BlockPickupOfItem(_Player, _Treasure)
AND
NOT DB_LOW_HouseOfHope_UnlockTreasures(1)
AND
DB_LOW_HouseOfHope_Treasures(_Treasure, _Trigger, _Blocker)
AND
IsInTrigger(_Treasure, _Trigger, 1)
THEN
DB_CustomPickupItemResponse(_Player, _Treasure, 0);

PROC
PROC_BlockMoveOfItem(_Player, _Treasure)
AND
NOT DB_LOW_HouseOfHope_UnlockTreasures(1)
AND
DB_LOW_HouseOfHope_Treasures(_Treasure, _Trigger, _Blocker)
AND
IsInTrigger(_Treasure, _Trigger, 1)
THEN
DB_CustomMoveItemResponse(_Player, _Treasure, 0);

IF
DB_LOW_HouseOfHope_UnlockTreasures(1)
AND
DB_LOW_HouseOfHope_Treasures(_, _, _Blocker)
THEN
PROC_GLO_Monitor_EntityPoof(_Blocker);

IF
DialogEnded((DIALOGRESOURCE)LOW_HouseOfHope_TreasureBlocker_935fb111-b7a6-4751-07cd-2d3c16799207, _)
AND
DB_LOW_HouseOfHope_UnlockTreasures(1)
THEN
AutoSave();

IF
DB_LOW_HouseOfHope_Treasures(_Treasure, _Trigger, _)
THEN
TriggerRegisterForItems(_Trigger);

IF
DB_LOW_HouseOfHope_Treasures(_, _, _Blocker)
THEN
DB_Dialogs(_Blocker, (DIALOGRESOURCE)LOW_HouseOfHope_TreasureBlocker_935fb111-b7a6-4751-07cd-2d3c16799207);

IF
FlagSet((FLAG)LOW_HouseOfHope_State_TreasureBlockerRemoved_e6b12fcb-de35-47c1-cd3a-427680bbc32c,_,_)
THEN
DB_LOW_HouseOfHope_UnlockTreasures(1);

IF
ItemLeftTrigger((ITEM)S_GLO_OrphicHammer_9013ef0d-c6ee-4137-b17a-c1934079e10d, (TRIGGER)S_LOW_HouseOfHope_MainTreasureTrigger_75627ad8-37b7-4aa9-bc63-92b1f05a40ba, _)
AND
NOT DB_GlobalFlag((FLAG)GLO_Raphael_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
THEN
SetFlag((FLAG)LOW_HouseOfHope_State_PlayersStoleMainTreasure_ffa3d3be-d30f-296f-d794-4c24d63eb25c);
SetFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe);
SetFlag((FLAG)ORI_Laezel_State_GotHammerFromHoH_8a8dd999-aa9e-42b2-9c84-e63b5eb6bc5e);

IF
ItemLeftTrigger((ITEM)S_LOW_HouseOfHope_PlayerContract_69119dc3-2c26-4e50-8430-ef427d05ef7f, (TRIGGER)S_LOW_HouseOfHope_MainTreasureTrigger_75627ad8-37b7-4aa9-bc63-92b1f05a40ba, _)
AND 
DB_GlobalFlag((FLAG)GLO_Raphael_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
THEN
SetFlag((FLAG)LOW_HouseOfHope_State_PlayersStoleMainTreasure_ffa3d3be-d30f-296f-d794-4c24d63eb25c);
SetFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe);

IF 
FlagSet((FLAG)LOW_HouseOfHope_State_PlayersStoleMainTreasure_ffa3d3be-d30f-296f-d794-4c24d63eb25c,_,_)
AND
DB_GlobalFlag((FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
THEN
SetFlag((FLAG)LOW_HouseOfHope_State_ContractIsDestroyed_1a51a77c-d549-4d50-95df-97ab9d1ef9f6);

IF 
FlagSet((FLAG)LOW_HouseOfHope_State_PlayersStoleMainTreasure_ffa3d3be-d30f-296f-d794-4c24d63eb25c,_,_)
AND
NOT DB_GlobalFlag((FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
THEN
SetFlag((FLAG)LOW_HouseOfHope_State_HammerIsStolen_1b248e8d-fef1-4671-aa55-afd0e34c2682);

// Interacting with Player Contract
IF
UseFinished(_Player, (ITEM)S_LOW_HouseOfHope_PlayerContract_69119dc3-2c26-4e50-8430-ef427d05ef7f, 1)
AND
DB_Players(_Player)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_HouseOfHope_DealWithContract_44b40928-57dd-bea2-922a-923358cdcfce, S_LOW_HouseOfHope_PlayerContract_69119dc3-2c26-4e50-8430-ef427d05ef7f, _Player)
THEN
DB_NOOP(1);

// Blocking picking up the contract (and allowing it only to players)

PROC
PROC_BlockPickupOfItem(_Player, (ITEM)S_LOW_HouseOfHope_PlayerContract_69119dc3-2c26-4e50-8430-ef427d05ef7f)
AND
DB_Players(_Player)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_HouseOfHope_DealWithContract_44b40928-57dd-bea2-922a-923358cdcfce, S_LOW_HouseOfHope_PlayerContract_69119dc3-2c26-4e50-8430-ef427d05ef7f, _Player)
THEN
DB_NOOP(1);

PROC
PROC_BlockPickupOfItem(_Player, (ITEM)S_LOW_HouseOfHope_PlayerContract_69119dc3-2c26-4e50-8430-ef427d05ef7f)
THEN
DB_CustomPickupItemResponse(_Player, (ITEM)S_LOW_HouseOfHope_PlayerContract_69119dc3-2c26-4e50-8430-ef427d05ef7f, 0);

PROC
PROC_BlockMoveOfItem(_Player, (ITEM)S_LOW_HouseOfHope_PlayerContract_69119dc3-2c26-4e50-8430-ef427d05ef7f)
THEN
DB_CustomMoveItemResponse(_Player, (ITEM)S_LOW_HouseOfHope_PlayerContract_69119dc3-2c26-4e50-8430-ef427d05ef7f, 0);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_HouseOfHope_Event_BurnPlayersContract_bc2878ee-2cf0-b095-3325-53ec41ec023b)
THEN
Die(S_LOW_HouseOfHope_PlayerContract_69119dc3-2c26-4e50-8430-ef427d05ef7f, DEATHTYPE.Incinerate, NULL_00000000-0000-0000-0000-000000000000, 0, 1);

PROC
PROC_StateSet_Defeated((ITEM)S_LOW_HouseOfHope_PlayerContract_69119dc3-2c26-4e50-8430-ef427d05ef7f)
THEN
SetFlag((FLAG)LOW_HouseOfHope_State_PlayersStoleMainTreasure_ffa3d3be-d30f-296f-d794-4c24d63eb25c);
SetFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe);

// Pressure plates trap
/*
IF
DualEntityEvent(_, _Item, _OffEvent)
AND
NOT DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
DB_LOW_HouseOfHope_TrappedTreasures(_Item, _OffEvent, _)
AND
GetClosestAlivePlayer(_Item, _Player, _)
THEN
//ForceTurnBasedMode(_Player, 1);
PROC_LOW_HouseOfHope_KorrillaLeavesAfterAD();
DB_LOW_HouseOfHope_TreasureAlarmTriggered(_Player, _Item);
ObjectTimerLaunch(_Player, "LOW_HouseOfHope_AlarmWarning", 6000);

IF
DualEntityEvent(_, _Item, _OnEvent)
AND
NOT DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
DB_LOW_HouseOfHope_TrappedTreasures(_Item, _, _OnEvent)
AND
DB_LOW_HouseOfHope_TreasureAlarmTriggered(_InitialCausee, _Item) 
THEN
ObjectTimerCancel(_InitialCausee, "LOW_HouseOfHope_AlarmWarning");
//ForceTurnBasedMode(_InitialCausee, 0);

IF
ObjectTimerFinished((CHARACTER)_Player, "LOW_HouseOfHope_AlarmWarning")
AND
NOT DB_LOW_HouseOfHope_AlarmIsReady(1)
THEN
SetFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe);
*/

IF
DualEntityEvent(_, _Item, _OffEvent)
AND
NOT DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
DB_LOW_HouseOfHope_TrappedTreasures(_Item, _OffEvent, _)
THEN
SetFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe);

IF
AttemptedDisarm(_Item, _, _, 0)
AND
NOT DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
DB_LOW_HouseOfHope_TrappedTreasures(_Item, _, _)
THEN
SetFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe);

// Disarm pedestals on raphael's death

IF
FlagSet((FLAG)LOW_HouseOfHope_State_RaphaelIsDead_655d7d21-99a2-4138-9a7a-af1850932e75,_,_)
AND
DB_LOW_HouseOfHope_TrappedTreasures(_Item, _, _)
THEN
SetTrapArmed((ITEM)_Item, 0);

// Archivist should comment on players seeing the treasures

IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_HouseOfHope_CheckMainTreasuresTrigger_78ff4130-3f04-4b61-900c-d28195a758cf)
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe)
AND
NOT DB_DialogNPCs(_, S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306, _)
AND
DB_Sees((CHARACTER)S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306, _Player)
THEN
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_HouseOfHope_CheckMainTreasuresTrigger_78ff4130-3f04-4b61-900c-d28195a758cf);
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_ArchivistMainComment_e7ea7838-d43c-9426-03ed-c649aada1013, S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306);

// Blocking picking up raphael treasures to give the warning
PROC
PROC_BlockPickupOfItem(_Player, _Treasure)
AND
DB_LOW_HouseOfHope_ArchiveTreasures(_Treasure)
AND
NOT DB_LOW_HouseOfHope_ArchivistWarning(1)
AND
DB_Sees((CHARACTER)S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306, _Player)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_HouseOfHope_AD_ArchivistTrappedComment_250bd5c6-a55a-bb32-22c5-5e80814960be, S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306, _Player)
THEN
DB_CustomPickupItemResponse(_Player, _Treasure, 0);

// Players should know that the treasure in the archive if they've saw the treasures

IF
FlagSet((FLAG)LOW_HouseOfHope_Event_SawMainTreasures_3a0552ac-db09-4f61-93d6-2c6f3be90d46,_,_)
THEN
SetFlag((FLAG)LOW_HouseOfHope_Knows_TreasureInArchive_b213dfe2-6afb-9772-d748-9ba9430a6aae);

//END_REGION

//REGION Portal Room

IF
EnteredCombat(S_LOW_HouseOfHope_Nubaldin_046f67d9-d477-42d5-8b70-fd0a7911caf4, _)
AND
NOT DB_LOW_HouseOfHope_AlarmIsReady(1)
THEN
SetFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe);

IF
DB_PermaDefeated(S_LOW_HouseOfHope_Nubaldin_046f67d9-d477-42d5-8b70-fd0a7911caf4)
AND
NOT DB_LOW_HouseOfHope_AlarmIsReady(1)
THEN
SetFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe);

//END_REGION

//REGION Prison

// Hope's chains

IF
FlagSet((FLAG)LOW_HouseOfHope_State_VisitedHouseOfHope_c8889a79-8277-48e9-afa0-e14f6359ea10,_,_)
AND
HasAppliedStatus(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, "INT_INFERNALCHAINS_LEFT", 0)
THEN
ApplyStatus((CHARACTER)S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce,"INT_INFERNALCHAINS_LEFT",-1.0,0,(ITEM)S_LOW_HouseOfHope_HopeChain01_72fe50a0-0e3d-44f5-ab1b-b1789984a0ff);

IF
FlagSet((FLAG)LOW_HouseOfHope_State_VisitedHouseOfHope_c8889a79-8277-48e9-afa0-e14f6359ea10,_,_)
AND
HasAppliedStatus(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, "INT_INFERNALCHAINS_RIGHT", 0)
THEN
ApplyStatus((CHARACTER)S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce,"INT_INFERNALCHAINS_RIGHT",-1.0,0,(ITEM)S_LOW_HouseOfHope_HopeChain02_9961735c-df6f-4146-bbae-7d778f8e96c5);


// Orphic Hammer will apply status on any item with ACT3_END_ORPHEUS_SHACKLES tag
IF
StatusApplied(_Chain, "END_ORPHICHAMMER_BREAKSHACKLES", _Causee, _)
AND
DB_LOW_HouseOfHope_HopeChains(_Chain)
THEN
PROC_LOW_HouseOfHope_BreakChain(_Chain, _Causee);

IF
UsingSpellOnTarget(_Causee, _Chain, "Target_MAG_OrphicHammer_ChainBreaker", _,_,_)
AND
DB_LOW_HouseOfHope_HopeChains(_Chain)
THEN
DB_LOW_HouseOfHope_DestroyingChain(_Causee);
RealtimeObjectTimerLaunch(_Chain, "LOW_HouseOfHope_ChainBreaker", 1500);

IF
ObjectTimerFinished(_Chain, "LOW_HouseOfHope_ChainBreaker")
AND
DB_LOW_HouseOfHope_HopeChains(_Chain)
AND
DB_LOW_HouseOfHope_DestroyingChain(_Causee)
THEN
PROC_LOW_HouseOfHope_BreakChain(_Chain, _Causee);
NOT DB_LOW_HouseOfHope_DestroyingChain(_Causee);

PROC
PROC_LOW_HouseOfHope_BreakChain((GUIDSTRING)_Chain, (GUIDSTRING)_Causee)
THEN
Die(_Chain, DEATHTYPE.Explode, _Causee, 0, 1, 1.0);

PROC
PROC_LOW_HouseOfHope_BreakChain(_Chain, (CHARACTER)_Causee)
AND
NOT DB_PermaDefeated(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce)
AND
DB_LOW_HouseOfHope_HopeRescuer(_FirstCausee)
AND
_Causee != _FirstCausee
THEN
NOT DB_LOW_HouseOfHope_HopeRescuer(_FirstCausee);
DB_LOW_HouseOfHope_HopeRescuer(_Causee);

PROC
PROC_LOW_HouseOfHope_BreakChain(_Chain, _Causee)
AND
NOT DB_PermaDefeated(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce)
AND
NOT DB_LOW_HouseOfHope_HopeRescuer(_)
THEN
DB_LOW_HouseOfHope_HopeRescuer((CHARACTER)_Causee);

PROC
PROC_StateSet_Defeated(_Chain)
AND
DB_LOW_HouseOfHope_HopeChains(_Chain)
THEN
NOT DB_LOW_HouseOfHope_HopeChains(_Chain);

PROC
PROC_StateSet_Defeated(_Chain)
AND
NOT DB_LOW_HouseOfHope_HopeChains(_)
AND
QRY_OnlyOnce("LOW_HouseOfHope_ChainsDestroyed")
AND
NOT DB_PermaDefeated(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce)
THEN
PROC_LOW_HouseOfHope_SetHopeFree();

PROC
PROC_LOW_HouseOfHope_SetHopeFree()
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_HouseOfHope_Hope_1dfaf4ca-187c-4a62-8978-af235ca6ce9f, 100);
RemoveStatus(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, "LOW_HOH_HOPE_INFERNALPROTECTION", NULL_00000000-0000-0000-0000-000000000000);
NOT DB_AD_Dialog(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, (DIALOGRESOURCE)LOW_HouseOfHope_AD_RescueHope_ea00162c-9e0a-fea2-cc97-f969eae279b8);
DB_Dialogs((CHARACTER)S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, (DIALOGRESOURCE)LOW_HouseOfHope_Hope_789e111a-7402-9ea0-feca-7106a0889675);
SetFlag((FLAG)LOW_HouseOfHope_Event_AgreedToHelpHope_525e29e1-58c6-2320-aba9-832d0ca8ff33);
SetFlag((FLAG)LOW_HouseOfHope_Event_HopeRescued_119342c6-2a7b-8c90-e96e-3f3a5930e91a);
SetCanFight(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, 1);
SetCanJoinCombat(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, 1);
DB_LOW_HouseOfHope_HopeIsFree(1);

PROC
PROC_LOW_HouseOfHope_SetHopeFree()
AND
NOT DB_LOW_HouseOfHope_HopeRescuer(_)
AND
DB_Avatars(_AvatarPlayer)
AND
QRY_OnlyOnce("LOW_HouseOfHope_FindAvatarForHope")
THEN
DB_LOW_HouseOfHope_HopeRescuer(_AvatarPlayer);

PROC
PROC_LOW_HouseOfHope_SetHopeFree()
AND
DB_LOW_HouseOfHope_HopeRescuer(_Rescuer)
AND
IsInCombat(_Rescuer, 1)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_HouseOfHope_State_InCombatAfterRescuingHope_6c6e3118-0c3c-99c9-7495-93615ca213a7);
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_HopeSaved_b5541523-f696-bcb4-f23e-a42d5118a0d2, S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce);

PROC
PROC_LOW_HouseOfHope_SetHopeFree()
AND
DB_LOW_HouseOfHope_HopeRescuer(_Rescuer)
THEN
AddPartyFollower((CHARACTER)S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, _Rescuer);

PROC
PROC_LOW_HouseOfHope_SetHopeFree()
THEN
PROC_LOW_HouseOfHope_StartHopeDialogue();

PROC
PROC_LOW_HouseOfHope_StartHopeDialogue()
AND
IsInCombat(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, 0)
AND
QRY_GetClosestAvailableCharacterTo(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, 0, 0, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_Player, S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce,_Dist,_)
AND
_Dist < 25.0
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_HouseOfHope_Hope_789e111a-7402-9ea0-feca-7106a0889675, S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, _Player)
AND
QRY_OnlyOnce("LOW_HouseOfHope_HopePrisonDialogue")
THEN
DB_NOOP(1);

PROC
PROC_LOW_HouseOfHope_StartHopeDialogue()
AND
QRY_OnlyOnce("LOW_HouseOfHope_HopePrisonDialogue")
AND
IsInCombat(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, 0)
AND
QRY_GetClosestAvailableCharacterTo(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, 0, 0, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
DB_ClosestAvailableCharacterTo(_Player, S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce,_Dist)
AND
_Dist < 20.0
AND
NOT QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_HouseOfHope_Hope_789e111a-7402-9ea0-feca-7106a0889675, S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, _Player)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_HopeSaved_b5541523-f696-bcb4-f23e-a42d5118a0d2, S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce);

PROC
PROC_LOW_HouseOfHope_SetHopeFree()
AND
IsInCombat(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, 0)
AND
NOT QRY_GetClosestAvailableCharacterTo(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, 0, 0, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 1)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_HopeSaved_b5541523-f696-bcb4-f23e-a42d5118a0d2, S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce);

PROC
PROC_LOW_HouseOfHope_SetHopeFree()
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe)
THEN
SetFlag((FLAG)LOW_HouseOfHope_State_RaphaelAlerted_f83c3d6b-d6cf-41a1-a03d-c31df5ea44fe);
PROC_LOW_HouseOfHope_SetAmbush();

PROC
PROC_LOW_HouseOfHope_SetHopeFree()
THEN
CharacterGiveEquipmentSet((CHARACTER)S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, "EQP_LOW_HouseOfHope_Hope");

PROC
PROC_GLO_DefeatCounter_AllPermaDefeated("LOW_HouseOfHope_PrisonCombat")
AND
DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_InCombatAfterRescuingHope_6c6e3118-0c3c-99c9-7495-93615ca213a7)
THEN
PROC_LOW_HouseOfHope_StartHopeDialogue();

IF
FlagSet((FLAG)LOW_HouseOfHope_Event_HopeRescued_119342c6-2a7b-8c90-e96e-3f3a5930e91a,_,_)
THEN
PROC_TriggerUnregisterForPlayers((TRIGGER)S_LOW_HouseOfHope_HopeLastHopeTrigger_992cda41-4d2f-49f5-b5ef-c42e6e5fa867);


// Handle closing the door
PROC
PROC_StateSet_PermaDefeated(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce)
THEN
Close((ITEM)S_LOW_HouseOfHope_FoyerDoor_06e45a4e-409a-4cb0-84ab-487bbdaedbee);
Unlock((ITEM)S_LOW_HouseOfHope_FoyerDoor_06e45a4e-409a-4cb0-84ab-487bbdaedbee);

PROC
PROC_LOW_HouseOfHope_SetHopeFree()
THEN
Close((ITEM)S_LOW_HouseOfHope_FoyerDoor_06e45a4e-409a-4cb0-84ab-487bbdaedbee);
Unlock((ITEM)S_LOW_HouseOfHope_FoyerDoor_06e45a4e-409a-4cb0-84ab-487bbdaedbee);

// PAD for Hope's Death

IF
DB_LOW_HouseOfHope_RaphaelBurnedHope(1)
THEN
DB_OneShot_VoiceBarkTrigger((TRIGGER)S_LOW_HouseOfHope_HopeDeadTrigger_817812b3-b578-4e76-b878-e4907fb29c30, (VOICEBARKRESOURCE)LOW_HouseOfHope_VB_HopeBurned_8d2e74ea-e384-c4b7-cba0-27a64d800d4c);

// Hope follower death handling
PROC
PROC_StateSet_PermaDefeated(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce)
AND
DB_LOW_HouseOfHope_HopeRescuer(_Rescuer)
THEN
PROC_RemovePartyFollower((CHARACTER)S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce);

// AD when players enter combat in prison

IF
EnteredCombat((CHARACTER)_Player, _Combat)
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_Event_HopeRescued_119342c6-2a7b-8c90-e96e-3f3a5930e91a)
AND
DB_Players(_Player)
AND
DB_InRegion(_Player, (TRIGGER)S_LOW_HouseOfHope_Prison_SUB_829b3df1-01b1-4d31-b251-0495c7692bec)
AND
QRY_OnlyOnce("LOW_HouseOfHope_RescueHopeADPlayed")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_RescueHope_ea00162c-9e0a-fea2-cc97-f969eae279b8, S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce);

// Prison door opened

IF
UseFinished(_, _Button, 1)
AND
DB_LOW_HouseOfHope_PrisonButtons(_Button)
AND
DB_LOW_HouseOfHope_PrisonDoorUnlocked(1)
THEN
PROC_TryStartAD(LOW_HouseOfHope_AD_PrisonDoorButtonCantUse_ad0b3797-c95d-a975-2fbf-b8e82bd2c378, _Button);

IF
UseFinished(_, _Button, 1)
AND
DB_LOW_HouseOfHope_PrisonButtons(_Button)
AND
NOT DB_LOW_HouseOfHope_PrisonDoorUnlocked(1)
THEN
PROC_ItemUnlockAndOpen((ITEM)S_DOOR_HoH_Metal_Single_A_000_641d6a8a-1376-4232-a65f-71e06d3b48dd);
DB_LOW_HouseOfHope_PrisonDoorUnlocked(1);

//END_REGION

//REGION Hope's Banishment spell
IF
StatusApplied(_Target, "LOW_BANISHED_HOPE", _, _)
THEN
RealtimeObjectTimerLaunch(_Target,"LOW_Timer_HopeBanishment", 500);

IF
ObjectTimerFinished(_Target, "LOW_Timer_HopeBanishment")
THEN
PROC_SetOnStage(_Target, 0);
Die(_Target, DEATHTYPE.Incinerate, NULL_00000000-0000-0000-0000-000000000000, 0, 0, 1.0);
//END_REGION

//REGION Raphael's arrival

// Setting up Raphael, Orthon and Korrilla arrival

IF
DB_LOW_HouseOfHope_AlarmIsReady(1)
THEN
PROC_HouseOfHope_SetRaphaelArrival();

//Orthon relations
PROC
PROC_HouseOfHope_SetRaphaelArrival()
AND
QRY_LOW_HouseOfHope_HelpedOrthon()
THEN
PROC_LOW_HouseOfHope_OrthonDecidesToHelp();

IF
FlagSet((FLAG)LOW_HouseOfHope_OrthonDecidesToHelp_4d828648-cae6-ba5f-2274-5ad66ac920ac,_,_)
THEN
PROC_LOW_HouseOfHope_OrthonDecidesToHelp();

PROC
PROC_LOW_HouseOfHope_OrthonDecidesToHelp()
THEN
DB_LOW_HouseOfHope_OrthonIsAlly(1);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_HouseOfHope_Orthon_905611e9-4399-47e3-a576-aaa840ab1724, 100);
PROC_SetRelationMutual((FACTION)Act3_LOW_HouseOfHope_Orthon_905611e9-4399-47e3-a576-aaa840ab1724,(FACTION)Act3_LOW_HouseOfHope_Raphael_65b207f5-756f-4980-ace1-b418ed8f477b, 50);
PROC_SetRelationMutual((FACTION)Act3_LOW_HouseOfHope_Orthon_905611e9-4399-47e3-a576-aaa840ab1724, (FACTION)Act3_LOW_HouseOfHope_Hope_1dfaf4ca-187c-4a62-8978-af235ca6ce9f, 100);
NOT DB_GLO_DefeatCounter(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, "LOW_HouseOfHope_RaphaelCombat");

PROC
PROC_HouseOfHope_SetRaphaelArrival()
AND
NOT QRY_LOW_HouseOfHope_HelpedOrthon()
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_HouseOfHope_Orthon_905611e9-4399-47e3-a576-aaa840ab1724, 50);
PROC_SetRelationMutual((FACTION)Act3_LOW_HouseOfHope_Orthon_905611e9-4399-47e3-a576-aaa840ab1724,(FACTION)Act3_LOW_HouseOfHope_Raphael_65b207f5-756f-4980-ace1-b418ed8f477b, 100);
PROC_SetRelationMutual((FACTION)Act3_LOW_HouseOfHope_Orthon_905611e9-4399-47e3-a576-aaa840ab1724, (FACTION)Act3_LOW_HouseOfHope_Hope_1dfaf4ca-187c-4a62-8978-af235ca6ce9f, 50);


QRY
QRY_LOW_HouseOfHope_HelpedOrthon()
AND
NOT DB_GlobalFlag((FLAG)SHA_Orthon_State_DiedOnce_8dd589d6-90fc-4a3b-b369-10440bd56520)
AND
DB_GlobalFlag((FLAG)SHA_Orthon_State_ContractEnded_26c35edd-3617-82b3-b4d7-1b7bb6410485)
THEN
DB_NOOP(1);

// Setting up Korrilla

PROC
PROC_HouseOfHope_SetRaphaelArrival()
AND
QRY_State_IsBeforeState(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_HouseOfHope_WithRaphael")
THEN
PROC_State_Progress(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_HouseOfHope_WithRaphael");
PROC_SetRelationToPlayers((FACTION)Act3_LOW_HouseOfHope_Warlock_c5736f4b-26bd-4681-a467-7490617139df, 50);
PROC_GLO_SetupForAct_Place(
	(CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297,
	(TRIGGER)S_LOW_HouseOfHope_KorrillaPoint_74aac219-0190-42ca-a185-291cc857f1cf, 
	(FACTION)Act3_LOW_HouseOfHope_Warlock_c5736f4b-26bd-4681-a467-7490617139df,
	(DIALOGRESOURCE)LOW_HouseOfHope_Korrilla_5f079fe8-02c0-e0ac-369f-68c1774cd175,
	"LOW_HouseOfHope_WarlockWithRaphaelReady");
PROC_SetAnubisConfig((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "DefaultCharacter");
PROC_SetOnStage(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, 0);
PROC_CharacterFullRestore((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297);
NOT DB_PreventPermaDefeated(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297);
SetImmortal((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297,0);
PROC_GLO_Warlock_RemoveAllStatuses();

//Setting up Orthon 
PROC
PROC_HouseOfHope_SetRaphaelArrival()
THEN
PROC_RemoveDialog(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c);
DB_NoLowAttitudeDialog((CHARACTER)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c);
NOT DB_PreventPermaDefeated(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c);
SetImmortal((CHARACTER)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c,0);
SetTag(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c,AI_USESPELL_A_33aa698c-aea0-43e2-bd16-582aa718fd3e);
SetTag(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c,AI_USESPELL_B_3297ed55-ccc1-473e-8475-ac4162a63fdd);
SetTag(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c,ACT3_HOH_ORTHON_SPELL_LIMIT_5f13326a-be94-4ca9-926b-8d6bec318ab0);
SetTag(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c,ACT3_LOW_HOUSEOFHOPE_BANISHABLECHARACTER_13a5d85a-5624-4d8d-bad7-c2ab834b2856);
RemoveStatus(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c,"INVISIBLE",S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c);
RemoveStatus(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c,"DISINTEGRATE_DEATH",S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c);
RequestSetBaseArchetype(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c,"orthon_melee");

PROC
PROC_HouseOfHope_SetRaphaelArrival()
THEN
PROC_TriggerRegisterForParty((TRIGGER)S_LOW_HouseOfHope_RaphaelDialogArea_3a225d44-7df9-4f80-baa9-9de20e204e94);
//PROC_TriggerRegisterForParty((TRIGGER)S_LOW_HouseOfHope_RaphaelSpotTrigger_3cde71eb-71cb-43d0-8a1d-bcc4e1cc0e1f);

// Raphael will arrive when players got what they came here for
/*
IF 
DB_InRegion(_Player, (TRIGGER)S_LOW_HouseOfHope_RaphaelSpotTrigger_3cde71eb-71cb-43d0-8a1d-bcc4e1cc0e1f)
AND
DB_Players(_Player)
AND
NOT DB_HiddenCharacters(_Player, _)
AND
QRY_OnlyOnce("LOW_HouseOfHope_RaphaelAppearance")
THEN
DB_LOW_HouseOfHope_PlayerForRaphaelDialog_Fallback(_Player);
PROC_HouseOfHope_RaphaelArrived();
*/

QRY
QRY_LOW_HouseOfHope_PlayersNotGathered()
AND
DB_Players(_Player)
AND
NOT DB_Defeated(_Player)
AND
NOT DB_InRegion(_Player, S_LOW_HouseOfHope_FoyerRoom_de540d6b-f846-4c74-9f9e-56f49eb36cee)
THEN
DB_NOOP(1);

PROC
PROC_BlockUseOfItem(_Player, S_LOW_DevilsFee_ReceivingPortalHoH_e87812da-a916-4d8c-bef7-73040524e587)
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_RaphaelIsDead_655d7d21-99a2-4138-9a7a-af1850932e75)
AND
DB_PartyMembers(_Player)
AND
QRY_LOW_HouseOfHope_PlayersNotGathered()
THEN
DB_CustomUseItemResponse(_Player, S_LOW_DevilsFee_ReceivingPortalHoH_e87812da-a916-4d8c-bef7-73040524e587, 0);
//PROC_TryStartAD(LOW_HouseOfHope_AD_CantUsePortal_74c877b7-60e2-54dc-e30b-3dbd0b3b95a1, S_LOW_DevilsFee_ReceivingPortalHoH_e87812da-a916-4d8c-bef7-73040524e587);

PROC
PROC_BlockUseOfItem(_Player, S_LOW_DevilsFee_ReceivingPortalHoH_e87812da-a916-4d8c-bef7-73040524e587)
AND
DB_PartyMembers(_Player)
AND
NOT QRY_LOW_HouseOfHope_PlayersNotGathered()
AND
DB_LOW_HouseOfHope_AlarmIsReady(1)
AND
QRY_OnlyOnce("LOW_HouseOfHope_RaphaelAppearance")
THEN
DB_CustomUseItemResponse(_Player, S_LOW_DevilsFee_ReceivingPortalHoH_e87812da-a916-4d8c-bef7-73040524e587, 0);
DB_LOW_HouseOfHope_PlayerForRaphaelDialog(_Player);
PROC_HouseOfHope_RaphaelArrived();

// Here are the devils
PROC
PROC_HouseOfHope_RaphaelArrived()
THEN
ClearFlag(LOW_DevilsFee_Event_OpeningPortal_4dfbe814-2457-40ae-bead-b997d0724af2);
ObjectTimerLaunch(S_LOW_DevilsFee_ReceivingPortalHoH_e87812da-a916-4d8c-bef7-73040524e587, "LOW_HouseOfHope_PortalDeactivate", 200);

IF
ObjectTimerFinished(S_LOW_DevilsFee_ReceivingPortalHoH_e87812da-a916-4d8c-bef7-73040524e587, "LOW_HouseOfHope_PortalDeactivate")
THEN
PROC_SetOnStage(S_LOW_DevilsFee_ReceivingPortalHoH_e87812da-a916-4d8c-bef7-73040524e587, 0);

// Teleport Hope to Foyer to get included in the dialogue
PROC
PROC_HouseOfHope_RaphaelArrived()
AND
NOT DB_Defeated(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce)
AND
DB_GlobalFlag((FLAG)LOW_HouseOfHope_Event_HopeRescued_119342c6-2a7b-8c90-e96e-3f3a5930e91a)
THEN
PROC_LOW_HouseOfHope_PoofHope(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce);
TeleportTo(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, S_LOW_HouseOfHope_RealHopePoint_c0a33c62-6671-474d-83e0-d274e5cd5c38, "", 0, 0);
PROC_LOW_HouseOfHope_FoopHope(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce);
DB_LOW_HouseOfHope_IncludeHope(1);

// Kill Hope if players haven't saved her
PROC
PROC_HouseOfHope_RaphaelArrived()
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_Event_HopeRescued_119342c6-2a7b-8c90-e96e-3f3a5930e91a)
THEN
DB_LOW_HouseOfHope_RaphaelBurnedHope(1);

PROC
PROC_HouseOfHope_RaphaelArrived()
AND
DB_Defeated(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce)
AND
NOT DB_Dead((CHARACTER)S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce)
THEN
DB_LOW_HouseOfHope_RaphaelBurnedHope(1);

IF
DB_LOW_HouseOfHope_RaphaelBurnedHope(1)
THEN
CreatePuddle(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, "SurfaceHellfire", 300, 400, 25, 35, 15.0);
Die(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, DEATHTYPE.Incinerate, S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, 0, 1);

//SHIELD FROM "IMPOSSIBLE" SCENARIO

PROC
PROC_HouseOfHope_RaphaelArrived()
AND
IsInTrigger(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, (TRIGGER)S_LOW_HouseOfHope_SUB_49462249-7f39-4b91-af1d-ba121c711213, 0)
THEN
PROC_GLO_SetupForAct_Place(
	(CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8,
	(TRIGGER)S_LOW_HouseOfHope_RaphaelPoint_38b385de-047f-4f5c-b214-cb219a00ea95, 
	(FACTION)Act3_LOW_HouseOfHope_Raphael_65b207f5-756f-4980-ace1-b418ed8f477b,
	(DIALOGRESOURCE)LOW_HouseOfHope_RaphaelAppearance_d48628c9-ac3a-6fe8-2312-a856f1a1f9fa,
	"LOW_HouseOfHope_RaphaelReady");
PROC_SetOnStage((CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, 0);

PROC
PROC_HouseOfHope_RaphaelArrived()
AND
IsInTrigger(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, (TRIGGER)S_LOW_HouseOfHope_SUB_49462249-7f39-4b91-af1d-ba121c711213, 0)
THEN
PROC_GLO_SetupForAct_Place(
	(CHARACTER)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c,
	(TRIGGER)S_LOW_HouseOfHope_OrthonPoint_a29bb35d-c5f3-404f-9a27-d75c67322bcb, 
	(FACTION)Act3_LOW_HouseOfHope_Orthon_905611e9-4399-47e3-a576-aaa840ab1724);
PROC_SetOnStage((CHARACTER)S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, 0);

PROC
PROC_HouseOfHope_RaphaelArrived()
AND
IsInTrigger(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, (TRIGGER)S_LOW_HouseOfHope_SUB_49462249-7f39-4b91-af1d-ba121c711213, 0)
THEN
PROC_GLO_SetupForAct_Place(
	(CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297,
	(TRIGGER)S_LOW_HouseOfHope_KorrillaPoint_74aac219-0190-42ca-a185-291cc857f1cf, 
	(FACTION)Act3_LOW_HouseOfHope_Warlock_c5736f4b-26bd-4681-a467-7490617139df,
	(DIALOGRESOURCE)LOW_HouseOfHope_Korrilla_5f079fe8-02c0-e0ac-369f-68c1774cd175,
	"LOW_HouseOfHope_WarlockWithRaphaelReady");
PROC_SetOnStage(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, 0);


//END SHIELD


PROC
PROC_HouseOfHope_RaphaelArrived()
AND
NOT QRY_SpeakerIsAvailable(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, 1)
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_HouseOfHope_Raphael_65b207f5-756f-4980-ace1-b418ed8f477b, 0);

PROC
PROC_HouseOfHope_RaphaelArrived()
AND
DB_LOW_HouseOfHope_PlayerForRaphaelDialog(_ChosenPlayer)
AND
NOT DB_Players(_ChosenPlayer)
THEN
NOT DB_LOW_HouseOfHope_PlayerForRaphaelDialog(_ChosenPlayer);

PROC
PROC_HouseOfHope_RaphaelArrived()
AND
DB_LOW_HouseOfHope_PlayerForRaphaelDialog(_ChosenPlayer)
AND
QRY_GetClosestAvailableCharacterTo(S_LOW_HouseOfHope_RaphaelPoint_38b385de-047f-4f5c-b214-cb219a00ea95, 0, 0, NULL_00000000-0000-0000-0000-000000000000, (CHARACTER)S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce,1,1,1)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_Player,S_LOW_HouseOfHope_RaphaelPoint_38b385de-047f-4f5c-b214-cb219a00ea95,_,_)
THEN
NOT DB_LOW_HouseOfHope_PlayerForRaphaelDialog(_ChosenPlayer);
DB_LOW_HouseOfHope_PlayerForRaphaelDialog(_Player);

PROC
PROC_HouseOfHope_RaphaelArrived()
AND
NOT DB_LOW_HouseOfHope_PlayerForRaphaelDialog(_)
AND
QRY_GetClosestAvailableCharacterTo(S_LOW_HouseOfHope_RaphaelPoint_38b385de-047f-4f5c-b214-cb219a00ea95, 0, 0, NULL_00000000-0000-0000-0000-000000000000, (CHARACTER)S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce,1,1,1)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_Player,S_LOW_HouseOfHope_RaphaelPoint_38b385de-047f-4f5c-b214-cb219a00ea95,_,_)
THEN
DB_LOW_HouseOfHope_PlayerForRaphaelDialog(_Player);


// We ensure that dialog starts 

PROC
PROC_HouseOfHope_RaphaelArrived()
AND
DB_LOW_HouseOfHope_PlayerForRaphaelDialog((CHARACTER)_Player)
THEN
DB_DropMutingStatussesDialog((DIALOGRESOURCE)LOW_HouseOfHope_RaphaelAppearance_d48628c9-ac3a-6fe8-2312-a856f1a1f9fa);
DB_DialogStarted_IgnoreStopConditions((DIALOGRESOURCE)LOW_HouseOfHope_RaphaelAppearance_d48628c9-ac3a-6fe8-2312-a856f1a1f9fa);

// Dialogue with Raphael without Hope
PROC
PROC_HouseOfHope_RaphaelArrived()
AND
DB_LOW_HouseOfHope_PlayerForRaphaelDialog(_Player)
AND
NOT DB_LOW_HouseOfHope_IncludeHope(1)
AND
NOT QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_HouseOfHope_RaphaelAppearance_d48628c9-ac3a-6fe8-2312-a856f1a1f9fa, S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, 
S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, NULL_00000000-0000-0000-0000-000000000000, _Player)
THEN
PROC_LOW_HouseOfHope_RaphaelGoesHostile();

// Dialogue with Raphael with some Hope
PROC
PROC_HouseOfHope_RaphaelArrived()
AND
DB_LOW_HouseOfHope_PlayerForRaphaelDialog(_Player)
AND
DB_LOW_HouseOfHope_IncludeHope(1)
AND
NOT QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_HouseOfHope_RaphaelAppearance_d48628c9-ac3a-6fe8-2312-a856f1a1f9fa, S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, 
S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, _Player)
THEN
PROC_LOW_HouseOfHope_RaphaelGoesHostile();

// If dialog can't start then lead to combat
PROC
PROC_HouseOfHope_RaphaelArrived()
AND
NOT DB_LOW_HouseOfHope_PlayerForRaphaelDialog(_)
THEN
PROC_LOW_HouseOfHope_RaphaelGoesHostile();

IF
DialogEnded((DIALOGRESOURCE)LOW_HouseOfHope_RaphaelAppearance_d48628c9-ac3a-6fe8-2312-a856f1a1f9fa,_)
THEN
PROC_LOW_HouseOfHope_RaphaelGoesHostile();

// Raphael appears after the dialogue starts (or, if there's no dialogue, poof them in)
IF
FlagSet((FLAG)LOW_HouseOfHope_Event_RaphaelAppeared_c25358e0-5ea1-929b-b511-6e745596d789, _, _)
THEN
PROC_SetOnStage((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, 1);
PROC_SetOnStage(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, 1);
PROC_SetOnStage(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, 1);

PROC
PROC_LOW_HouseOfHope_RaphaelGoesHostile()
AND
IsOnStage(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, 0)
THEN
PROC_GLO_Monitor_EntityFoop((CHARACTER)S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297);
PROC_GLO_Monitor_EntityFoop(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8);
PROC_GLO_Monitor_EntityFoop(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c);

PROC
PROC_LOW_HouseOfHope_RaphaelGoesHostile()
AND
NOT DB_GlobalFlag(LOW_HouseOfHope_Event_RaphaelAppeared_c25358e0-5ea1-929b-b511-6e745596d789)
THEN
PROC_GlobalSetFlagAndCache(LOW_HouseOfHope_Event_RaphaelAppeared_c25358e0-5ea1-929b-b511-6e745596d789);

// Raphael goes hostile
PROC
PROC_LOW_HouseOfHope_RaphaelGoesHostile()
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_HouseOfHope_Raphael_65b207f5-756f-4980-ace1-b418ed8f477b, 0);
PROC_SetRelationToPlayers((FACTION)Act3_LOW_HouseOfHope_Warlock_c5736f4b-26bd-4681-a467-7490617139df, 0);
PROC_GLO_Monitor_EntityFoop(S_LOW_HouseOfHope_RaphaelCambion01_4535facb-487c-4ab8-82e2-0f28558a7d16);
PROC_GLO_Monitor_EntityFoop(S_LOW_HouseOfHope_RaphaelCambion02_3164499e-24cd-4417-baca-5f057b4d9518);
PROC_GLO_Monitor_EntityFoop(S_LOW_HouseOfHope_RaphaelCambion03_abc96d0e-846e-4986-ae72-39befabb128b);
PROC_GLO_Monitor_EntityFoop(S_LOW_HouseOfHope_RaphaelCambion04_25c6573c-acb8-437f-9fcf-81a80c56f540);
PROC_GLO_Monitor_EntityFoop(S_LOW_HouseOfHope_RaphaelCambion05_f7b77fc8-d732-4cf7-a541-34d16ad01dc6);
PROC_GLO_Monitor_EntityFoop(S_LOW_HouseOfHope_RaphaelCambion06_c9c4475f-a2e7-43d6-8df9-de081fef3f89);

PROC
PROC_LOW_HouseOfHope_RaphaelGoesHostile()
AND
NOT DB_LOW_HouseOfHope_OrthonIsAlly(1)
THEN
PROC_SetRelationToPlayers((FACTION)Act3_LOW_HouseOfHope_Orthon_905611e9-4399-47e3-a576-aaa840ab1724, 0);

IF
EnteredCombat(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8,_)
AND
NOT QRY_State_IsBeforeState((CHARACTER)S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", "GLO_Monitor_HouseOfHope")
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_Event_RaphaelTransforms_e2d1800c-0959-4543-bf5f-e1d25d216e22)
THEN
SetFlag((FLAG)LOW_HouseOfHop_Event_RaphaelTransforms_e2d1800c-0959-4543-bf5f-e1d25d216e22, NULL_00000000-0000-0000-0000-000000000000);


// Kill the players

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_HouseOfHope_Event_RaphaelTakesSouls_b6c5a114-61bf-4e20-a197-7cf328f1debc)
AND
DB_Players(_Player)
THEN
Die(_Player, DEATHTYPE.Incinerate, S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, 0, 1, 0.0);

// All "enemies" should disappear - no one will distract Raphael himself
// Not removing Prison guards for now just to check how it feels - though at this point players in prison will also see how Hope dies if she wasn't saved
/*
PROC
PROC_HouseOfHope_RaphaelArrived()
AND
DB_LOW_HouseOfHope_PrisonGuards(_Guard)
AND
NOT DB_PermaDefeated(_Guard)
THEN
PROC_GLO_Monitor_EntityPoof(_Guard);
*/

PROC
PROC_HouseOfHope_RaphaelArrived()
AND
DB_LOW_HouseOfHope_DebtorTransformed(_, _Demon)
AND
NOT DB_PermaDefeated(_Demon)
AND
IsOnStage(_Demon, 1)
THEN
PROC_GLO_Monitor_EntityPoof(_Demon);

PROC
PROC_HouseOfHope_RaphaelArrived()
AND
DB_LOW_HouseOfHope_DebtorsIntoDemons(_Debtor,_)
AND
NOT DB_PermaDefeated(_Debtor)
AND
IsOnStage(_Debtor, 1)
THEN
PROC_GLO_Monitor_EntityPoof(_Debtor);

PROC
PROC_HouseOfHope_RaphaelArrived()
AND
DB_LOW_HouseOfHope_BoudoirImps(_Guard,_,_,_)
AND
NOT DB_PermaDefeated(_Guard)
AND
IsOnStage(_Guard, 1)
THEN
PROC_GLO_Monitor_EntityPoof(_Guard);

PROC
PROC_HouseOfHope_RaphaelArrived()
AND
NOT DB_PermaDefeated(S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306)
AND
IsOnStage(S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306, 1)
THEN
PROC_GLO_Monitor_EntityPoof(S_LOW_HouseOfHope_Archivist_d2d4a5ac-4a57-40dd-a317-f749146da306);

PROC
PROC_HouseOfHope_RaphaelArrived()
AND
NOT DB_PermaDefeated(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26)
AND
IsOnStage(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26, 1)
THEN
PROC_GLO_Monitor_EntityPoof(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26);

// Disable inferno as well
PROC
PROC_HouseOfHope_RaphaelArrived()
THEN
DB_LOW_HouseOfHope_DisableInferno(1);


//Raphael transforms
IF
FlagSet(LOW_HouseOfHope_Event_RaphaelTransforms_e2d1800c-0959-4543-bf5f-e1d25d216e22,_,_)
THEN
Transform(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8,(CHARACTER)QUEST_Monitor_DevilForm_1f9da419-8224-42e8-894a-8907cb978360,(SHAPESHIFTRULE)Physical_4acc6277-6dcd-4110-9450-b9379beaedac);

IF
FlagSet((FLAG)LOW_HouseOfHope_Event_RaphaelTransformsIntoBeast_bf7b226a-a684-4723-9a43-46716e276099,_,_)
THEN
Transform(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8,(CHARACTER)QUEST_Monitor_BeastForm_001b64f6-4918-4045-8197-878cf263e893,(SHAPESHIFTRULE)Physical_4acc6277-6dcd-4110-9450-b9379beaedac);

//END_REGION

//REGION Raphael's Postmortem
IF
DB_PermaDefeated(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8)
AND
DB_State_Current(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", "GLO_Monitor_HouseOfHope")
THEN
PROC_State_Progress(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8,"GLO_Monitor","GLO_Monitor_DefeatedInHell");

IF
DB_PermaDefeated(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297)
AND
DB_State_Current(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_HouseOfHope_WithRaphael")
THEN
PROC_State_Progress(S_GOB_Warlock_d432aafd-f728-4d9d-9707-732e1cdd8297, "GLO_Warlock", "GLO_Warlock_DefeatedInHell");


// Remove House of Hope as a Danger Zone: it's not anymore. 
PROC
PROC_State_Changed(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8,"GLO_Monitor","GLO_Monitor_HouseOfHope","GLO_Monitor_DefeatedInHell",_)
THEN
SetFlag((FLAG)LOW_HouseOfHope_State_RaphaelIsDead_655d7d21-99a2-4138-9a7a-af1850932e75);
DB_LOW_HouseOfHope_UnlockTreasures(1);

PROC
PROC_GLO_DefeatCounter_AllPermaDefeated("LOW_HouseOfHope_RaphaelCombat")
THEN
PROC_LOW_HouseOfHope_Postmortem();

PROC
PROC_LOW_HouseOfHope_Postmortem()
AND
DB_LOW_HouseOfHope_HopeRescuer(_Rescuer)
THEN
PROC_RemovePartyFollower((CHARACTER)S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce);

PROC
PROC_GLO_PostReassignFollowerHook(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, (CHARACTER)_OldLeader, (CHARACTER)_NewLeader)
THEN
NOT DB_LOW_HouseOfHope_HopeRescuer(_OldLeader);
DB_LOW_HouseOfHope_HopeRescuer(_NewLeader);
SetFlag((FLAG)LOW_HouseOfHope_HasMet_SavedHope_4950dfa2-a3c8-0e84-393c-2f2d8f2c29a4, _NewLeader); // prevent dialog with Hope from replaying when reassigned.

IF
DB_GlobalFlag((FLAG)GLO_Monitor_State_Defeated_a5032bc9-878b-4187-b086-d145bec99441)
AND
DB_Players(_Player)
AND
HasActiveStatus(_Player, "LOW_RAPHAEL_SOULLESS", 1)
THEN
RemoveStatus(_Player, "LOW_RAPHAEL_SOULLESS", S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8);


// Orthon often enters Invisibility during combat
PROC
PROC_LOW_HouseOfHope_Postmortem()
AND
NOT DB_PermaDefeated(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
AND
HasActiveStatusWithGroup(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, "SG_Invisible", 1)
THEN
RemoveStatusesWithGroup(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c,"SG_Invisible",S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c);

// Resetting the Emperor dialogue
PROC
PROC_LOW_HouseOfHope_Postmortem()
AND
QRY_OnlyOnce_Reset("LOW_DevilsFee_EmperorTalksAfterVisitingHouse")
THEN
PROC_TriggerRegisterForPlayers(S_LOW_DevilsFee_ReturnToDiabolist_74e65e00-d475-4e32-87db-a8cc92b42b06);

IF
FlagSet((FLAG)LOW_HouseOfHope_State_PlayersStoleMainTreasure_ffa3d3be-d30f-296f-d794-4c24d63eb25c,_,_)
AND
QRY_OnlyOnce_Reset("LOW_DevilsFee_EmperorTalksAfterVisitingHouse")
THEN
PROC_TriggerRegisterForPlayers(S_LOW_DevilsFee_ReturnToDiabolist_74e65e00-d475-4e32-87db-a8cc92b42b06);

// Handling Hope after killing Raphael
PROC
PROC_LOW_HouseOfHope_Postmortem()
THEN
TimerLaunch("LOW_HouseOfHope_PostmortemPause", 3000);

IF
TimerFinished("LOW_HouseOfHope_PostmortemPause")
THEN
PROC_LOW_HouseOfHope_PostmortemDialogueHandling();

PROC
PROC_LOW_HouseOfHope_PostmortemDialogueHandling()
AND
NOT DB_PermaDefeated(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce)
AND
QRY_GetClosestAvailableCharacterTo(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, 0, 0, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_Player,S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce,_Dist,_)
AND
_Dist < 20
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_HouseOfHope_Hope_789e111a-7402-9ea0-feca-7106a0889675, S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, _Player)
THEN
DB_LOW_HouseOfHope_ShouldMoveHopeAfterDialogue(1);

PROC
PROC_LOW_HouseOfHope_PostmortemDialogueHandling()
AND
NOT DB_PermaDefeated(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce)
AND
NOT DB_LOW_HouseOfHope_ShouldMoveHopeAfterDialogue(1)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_RaphaelGone_2d27ab51-c79a-bef1-58ba-839bb7e2c01d, S_LOW_DevilsFee_ReceivingPortalHoH_e87812da-a916-4d8c-bef7-73040524e587);
PROC_CharacterMoveTo((CHARACTER)S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, S_LOW_HouseOfHope_RealHopePoint_c0a33c62-6671-474d-83e0-d274e5cd5c38, "Walk", "");

IF
DialogEnded(LOW_HouseOfHope_Hope_789e111a-7402-9ea0-feca-7106a0889675, _)
AND
DB_LOW_HouseOfHope_ShouldMoveHopeAfterDialogue(1)
THEN
PurgeOsirisQueue((CHARACTER)S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce);
NOT DB_LOW_HouseOfHope_ShouldMoveHopeAfterDialogue(1);


// Handling Orthon after combat 

PROC
PROC_LOW_HouseOfHope_Postmortem()
AND
NOT DB_PermaDefeated(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
THEN
CharacterDisableCrime(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, "Steal");

PROC
PROC_LOW_HouseOfHope_PostmortemDialogueHandling()
AND
NOT DB_PermaDefeated(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
THEN
PROC_GlobalSetFlagAndCache((FLAG)LOW_HouseOfHope_State_OrthonSurvived_293a15c2-d28b-a39e-e0ed-c865f8b17ccd);
DB_Dialogs(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, (DIALOGRESOURCE)LOW_HouseOfHope_YurgirFarewell_039f4bc4-ad64-ef77-9172-eaca8b30bcfd);

PROC
PROC_LOW_HouseOfHope_PostmortemDialogueHandling()
AND
DB_PermaDefeated(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce)
AND
NOT DB_PermaDefeated(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
AND
QRY_GetClosestAvailableCharacterTo(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, 0, 0, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_Player,S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c,_Dist,_)
AND
_Dist < 20
AND
QRY_StartDialog((DIALOGRESOURCE)LOW_HouseOfHope_YurgirFarewell_039f4bc4-ad64-ef77-9172-eaca8b30bcfd, S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, _Player)
THEN
DB_LOW_HouseOfHope_TalkedToOrthonAutomatically(1);

PROC
PROC_LOW_HouseOfHope_PostmortemDialogueHandling()
AND
DB_PermaDefeated(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce)
AND
NOT DB_PermaDefeated(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
AND
NOT DB_LOW_HouseOfHope_TalkedToOrthonAutomatically(1)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_RaphaelGone_2d27ab51-c79a-bef1-58ba-839bb7e2c01d, S_LOW_DevilsFee_ReceivingPortalHoH_e87812da-a916-4d8c-bef7-73040524e587);

PROC
PROC_LOW_HouseOfHope_PostmortemDialogueHandling()
AND
NOT DB_PermaDefeated(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce)
AND
NOT DB_PermaDefeated(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
THEN
PROC_CharacterMoveTo(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, S_LOW_HouseOfHope_OrthonPoint_a29bb35d-c5f3-404f-9a27-d75c67322bcb, "Walk", "");

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)LOW_HouseOfHope_Event_OrthonLeaves_21f49b19-2a45-72b1-fbb7-ce817ce8a1cc)
THEN
CharacterEnableCrime(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, "Steal");
PROC_GLO_Monitor_EntityPoof(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c);

IF
LeftTrigger(_Player,(TRIGGER)S_LOW_HouseOfHope_SUB_49462249-7f39-4b91-af1d-ba121c711213)
AND
NOT QRY_TriggerEvents_AnyPlayerInTriggerSet("LOW_HouseOfHope")
AND
DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_RaphaelIsDead_655d7d21-99a2-4138-9a7a-af1850932e75)
AND
NOT DB_PermaDefeatedOrOffstage(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
THEN
CharacterEnableCrime(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, "Steal");
PROC_GLO_Monitor_EntityPoof(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c);

// No one came to the party

PROC
PROC_LOW_HouseOfHope_PostmortemDialogueHandling()
AND
DB_PermaDefeated(S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce)
AND
DB_PermaDefeated(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c)
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_RaphaelGone_2d27ab51-c79a-bef1-58ba-839bb7e2c01d, S_LOW_DevilsFee_ReceivingPortalHoH_e87812da-a916-4d8c-bef7-73040524e587);

// Open up the portal

PROC
PROC_LOW_HouseOfHope_PostmortemDialogueHandling()
THEN
PROC_SetOnStage(S_LOW_DevilsFee_ReceivingPortalHoH_e87812da-a916-4d8c-bef7-73040524e587, 1);
ObjectTimerLaunch(S_LOW_DevilsFee_ReceivingPortalHoH_e87812da-a916-4d8c-bef7-73040524e587, "LOW_HouseOfHope_PortalActivate", 200);

IF
ObjectTimerFinished(S_LOW_DevilsFee_ReceivingPortalHoH_e87812da-a916-4d8c-bef7-73040524e587, "LOW_HouseOfHope_PortalActivate")
THEN
SetFlag(LOW_DevilsFee_Event_OpeningPortal_4dfbe814-2457-40ae-bead-b997d0724af2);
//mostly for debug cases
SetFlag((FLAG)LOW_DevilsFee_State_RitualAlreadyDone_3bc4c164-0e98-fbc7-0cef-f244e390b3b4); 
SetFlag((FLAG)LOW_DevilsFee_State_TraveledOnceToHouseOfHope_36950cf9-1642-a398-e116-0adb189d3b7d);


//END_REGION

//REGION Raphael combat support

IF
DB_LOW_HouseOfHope_SoulPillars(_Pillar)
THEN
DB_GLO_DefeatCounter(_Pillar, "LOW_HouseOfHope_RaphaelPillars");
PROC_SetOnStage(_Pillar, 0);

// Dealing with pillars on Raphael's arrival

PROC
PROC_LOW_HouseOfHope_RaphaelGoesHostile()
AND
DB_LOW_HouseOfHope_SoulPillarsDeactivated(_SoulPillar)
THEN
PROC_SetOnStage(_SoulPillar, 0);

PROC
PROC_LOW_HouseOfHope_RaphaelGoesHostile()
AND
DB_LOW_HouseOfHope_SoulPillars(_SoulPillar)
THEN
PROC_SetOnStage(_SoulPillar, 1);

PROC
PROC_GLO_DefeatCounter_Notify("LOW_HouseOfHope_RaphaelPillars", _, _DefeatedCount, _PermaDefeatedCount)
AND
NOT DB_GlobalFlag((FLAG)GLO_Monitor_State_PermaDefeated_92f6d5f6-86af-4339-ad8a-da9d629f0dae)
AND
IntegerSum(_DefeatedCount, _PermaDefeatedCount, _NewCount)
AND
DB_LOW_HouseOfHope_RaphaelBeastStatuses(_NewCount, _StatusName)
THEN
ApplyStatus(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _StatusName, -1.0, 1, S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8);

// Destroying Soul pillars with Raphael's death 

IF
DB_GlobalFlag((FLAG)GLO_Monitor_State_PermaDefeated_92f6d5f6-86af-4339-ad8a-da9d629f0dae)
AND
DB_LOW_HouseOfHope_SoulPillars(_SoulPillar)
AND
NOT DB_Destroyed(_SoulPillar)
THEN
Die(_SoulPillar, DEATHTYPE.DoT, S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, 0, 1, 1.0);

// Allowing souls to be temporarily dispelled when a pillar is hit by Radiant Samage  

IF
AttackedBy(_Pillar, _, _, "Radiant", _, _, _)
AND
DB_LOW_HouseOfHope_SoulPillars((ITEM)_Pillar)
AND
HasActiveStatus(_Pillar,"LOW_HOUSEOFHOPE_SOULPILLAR_FX",1)
AND
HasActiveStatus(_Pillar,"LOW_RAPHAEL_PILLAR_BLOCKED",0)
THEN
ApplyStatus(_Pillar,"LOW_RAPHAEL_PILLAR_BLOCKED",2.0,0,NULL_00000000-0000-0000-0000-000000000000);

// Remove Inevitable Resolve on being knocked_out

IF
StatusApplied(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "LOW_RAPHAEL_WILLPOWER",_,_)
AND
DB_KnockedOut(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8)
THEN
RemoveStatus(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "LOW_RAPHAEL_WILLPOWER");


//END_REGION

//REGION Save Hope journal

// Abrupt Ending

IF
DialogEnded((DIALOGRESOURCE)LOW_HouseOfHope_HopeSpirit01_32a22a1a-6052-0556-509b-a30105e5f4dc,_)
AND
DB_GlobalFlag((FLAG)LOW_HouseOfHope_HopeSpirit01_State_HopeDisappearedEarly_401be2e5-556b-116f-caee-918dec4139e1)
AND
NOT DB_GlobalFlag((FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
AND
NOT DB_GlobalFlag((FLAG)GLO_Orpheus_Knows_OrphicHammerIsTheKey_980541fb-1483-ea1a-3387-64405eace9a2)
THEN
DB_LOW_HouseOfHope_HopeAbruptQuestStart(1);
NOT DB_QuestDef_State_ConditionalFlag((FLAG)LOW_HouseOfHope_Event_AgreedToHelpHope_525e29e1-58c6-2320-aba9-832d0ca8ff33, "LOW_SaveHope", "MetHope_NoDeal", 0, (FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc);
QuestUpdate("LOW_SaveHope", "MetHope_AbruptEnd_WhatHammer");

IF
DialogEnded((DIALOGRESOURCE)LOW_HouseOfHope_HopeSpirit01_32a22a1a-6052-0556-509b-a30105e5f4dc,_)
AND
DB_GlobalFlag((FLAG)LOW_HouseOfHope_HopeSpirit01_State_HopeDisappearedEarly_401be2e5-556b-116f-caee-918dec4139e1)
AND
NOT DB_GlobalFlag((FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
AND
DB_GlobalFlag((FLAG)GLO_Orpheus_Knows_OrphicHammerIsTheKey_980541fb-1483-ea1a-3387-64405eace9a2)
THEN
DB_LOW_HouseOfHope_HopeAbruptQuestStart(1);
NOT DB_QuestDef_State_ConditionalFlag((FLAG)LOW_HouseOfHope_Event_AgreedToHelpHope_525e29e1-58c6-2320-aba9-832d0ca8ff33, "LOW_SaveHope", "MetHope_NoDeal", 0, (FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc);
QuestUpdate("LOW_SaveHope", "MetHope_AbruptEnd_OrphicHammer");

IF
DialogEnded((DIALOGRESOURCE)LOW_HouseOfHope_HopeSpirit01_32a22a1a-6052-0556-509b-a30105e5f4dc,_)
AND
DB_GlobalFlag((FLAG)LOW_HouseOfHope_HopeSpirit01_State_HopeDisappearedEarly_401be2e5-556b-116f-caee-918dec4139e1)
AND
DB_GlobalFlag((FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
THEN
NOT DB_QuestDef_State_ConditionalFlag((FLAG)LOW_HouseOfHope_Event_AgreedToHelpHope_525e29e1-58c6-2320-aba9-832d0ca8ff33, "LOW_SaveHope", "MetHope_MadeDeal", 1, (FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc);
QuestUpdate("LOW_SaveHope", "MetHope_AbruptEnd_MadeDeal");

IF
FlagSet((FLAG)LOW_HouseOfHope_Knows_TreasureInArchive_b213dfe2-6afb-9772-d748-9ba9430a6aae,_,_)
AND
DB_LOW_HouseOfHope_HopeAbruptQuestStart(1)
THEN
QuestUpdate("LOW_SaveHope", "FoundHammer");

// Save Hope flow

IF
DialogEnded((DIALOGRESOURCE)LOW_HouseOfHope_HopeSpirit_Prison_33f61440-9fb9-b8d3-270b-0dc0aa8a9792,_)
AND
DB_GlobalFlag((FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
THEN
DB_LOW_HouseOfHope_PrisonKnowledge(1);
QuestUpdate("LOW_SaveHope", "FoundPrison");

IF
DialogEnded((DIALOGRESOURCE)LOW_HouseOfHope_HopeSpirit_Prison_33f61440-9fb9-b8d3-270b-0dc0aa8a9792,_)
AND
NOT DB_GlobalFlag((FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
THEN
DB_LOW_HouseOfHope_PrisonKnowledge(1);

IF
FlagSet((FLAG)LOW_HouseOfHope_Nubaldin_Event_ToldPrisonLocation_6b37980e-ec6f-8435-b0dd-35b3067d8d13,_,_)
AND
NOT DB_LOW_HouseOfHope_PrisonKnowledge(1)
THEN
DB_LOW_HouseOfHope_PrisonKnowledge(1);

IF
DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_HammerIsStolen_1b248e8d-fef1-4671-aa55-afd0e34c2682)
AND
DB_LOW_HouseOfHope_PrisonKnowledge(1)
THEN
QuestUpdate("LOW_SaveHope", "FoundPrison");


IF
FlagSet((FLAG)LOW_HouseOfHope_HasMet_SavedHope_4950dfa2-a3c8-0e84-393c-2f2d8f2c29a4,_,_)
AND
DB_GlobalFlag((FLAG)GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc)
AND
NOT DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_ContractIsDestroyed_1a51a77c-d549-4d50-95df-97ab9d1ef9f6)
THEN
QuestUpdate("LOW_SaveHope", "TalkedToHope_NoContract");

IF
DialogEnded((DIALOGRESOURCE)LOW_HouseOfHope_HopeSpirit_Alarm_b44dd29f-d9ca-faac-91e6-8de7eb05641d,_)
AND
DB_GlobalFlag((FLAG)LOW_HouseOfHope_State_NoHammerInHouse_29adfa78-2141-4599-a46a-53dd49acdb23)
THEN
QuestUpdate("LOW_SaveHope", "ForgotHammer");

PROC
PROC_LOW_HouseOfHope_RaphaelGoesHostile()
THEN
QuestUpdate("LOW_SaveHope", "EncounteredRaphael");

PROC
PROC_LOW_HouseOfHope_Postmortem()
THEN
QuestUpdate("LOW_SaveHope", "RaphaelDefeated");

IF
DB_LOW_HouseOfHope_RaphaelBurnedHope(1)
THEN
QuestUpdate("LOW_SaveHope", "HopeBurned");

//Move Prison marker

IF
DB_InRegion(_, (TRIGGER)S_LOW_HouseOfHope_Prison_SUB_829b3df1-01b1-4d31-b251-0495c7692bec)
AND
NOT DB_LOW_HouseOfHope_PrisonMarkerMoved(1)
AND
DB_LOW_HouseOfHope_ShouldUpdatePrisonMarker(1)
THEN
DB_LOW_HouseOfHope_PrisonMarkerMoved(1);
TeleportTo(S_LOW_HouseOfHope_PrisonMarker_d4291032-7d29-41da-8c06-974c7c0a1b79, S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce);

IF
DB_InRegion(_, (TRIGGER)S_LOW_HouseOfHope_SUB_49462249-7f39-4b91-af1d-ba121c711213)
AND
DB_LOW_HouseOfHope_ShouldUpdatePrisonMarker(1)
AND
DB_LOW_HouseOfHope_PrisonMarkerMoved(1)
AND
NOT QRY_AnyCharacterInTrigger((TRIGGER)S_LOW_HouseOfHope_Prison_SUB_829b3df1-01b1-4d31-b251-0495c7692bec)
THEN
NOT DB_LOW_HouseOfHope_PrisonMarkerMoved(1);
TeleportTo(S_LOW_HouseOfHope_PrisonMarker_d4291032-7d29-41da-8c06-974c7c0a1b79, S_DOOR_HoH_HatchToEngine_1b108f4d-190c-4d17-aabe-80e8aa9e7089);

//END_REGION

//REGION Topical greetings

IF
EnteredTrigger(_Player, (TRIGGER)S_LOW_HouseOfHope_SUB_49462249-7f39-4b91-af1d-ba121c711213)
AND
DB_Avatars(_Player)
THEN
SetFlag((FLAG)TG_LOW_InHouseOfHope_55d9e556-3466-41ec-83c5-bcbafa5efdc0, _Player);

PROC
PROC_LOW_HouseOfHope_Postmortem()
AND
DB_Avatars(_Player)
THEN
SetFlag((FLAG)TG_LOW_RaphaelDefeated_ae4475b6-f303-4187-844b-903bd40d616f, _Player);

//END_REGION

//REGION Raphael combat ADs
IF
StatusApplied(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "LOW_RAPHAEL_MONSTER_FORM", _, _)
THEN
PROC_LOW_HouseOfHope_HoldRaphaelCombatAD();

IF
StatusRemoved(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "LOW_RAPHAEL_MONSTER_FORM", _, _)
THEN
PROC_LOW_HouseOfHope_ResumeRaphaelCombatAD();

// After first transformation remove all the "OnTurn ADs"
PROC
PROC_LOW_HouseOfHope_HoldRaphaelCombatAD()
AND
DB_CombatReact_AD_OnTurn(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _AD, _Turn)
THEN
NOT DB_CombatReact_AD_OnTurn(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _AD, _Turn);

// After every transformation set up a new AD for the next turn
PROC
PROC_LOW_HouseOfHope_HoldRaphaelCombatAD()
AND
QRY_OnlyOnce_Reset("LOW_HouseOfHope_Raphael_SetNextTurnAD")
THEN
DB_NOOP(1);

PROC
PROC_LOW_HouseOfHope_HoldRaphaelCombatAD()
AND
DB_CombatReact_AD_OnNextTurn(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _AD)
THEN
NOT DB_CombatReact_AD_OnNextTurn(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _AD);

PROC
PROC_LOW_HouseOfHope_ResumeRaphaelCombatAD()
AND
DB_LOW_HouseOfHope_SetNextTurnAD(_AD)
AND
QRY_OnlyOnce("LOW_HouseOfHope_Raphael_SetNextTurnAD")
THEN
NOT DB_LOW_HouseOfHope_SetNextTurnAD(_AD);
DB_CombatReact_AD_OnNextTurn(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _AD);

// Hold for casting

PROC
PROC_LOW_HouseOfHope_HoldRaphaelCombatAD()
AND
DB_CombatReact_AD_OnCast(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _AD, _Spell)
THEN
NOT DB_CombatReact_AD_OnCast(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _AD, _Spell);
DB_LOW_HouseOfHope_OnCast_Hold(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _AD, _Spell);

PROC
PROC_LOW_HouseOfHope_ResumeRaphaelCombatAD()
AND
DB_LOW_HouseOfHope_OnCast_Hold(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _AD, _Spell)
THEN
NOT DB_LOW_HouseOfHope_OnCast_Hold(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _AD, _Spell);
DB_CombatReact_AD_OnCast(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _AD, _Spell);

// Reaction on Yurgir's death if he decides to help players
IF
DB_LOW_HouseOfHope_OrthonIsAlly(1)
THEN
DB_CombatReact_AD_OnDeathOther(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, (DIALOGRESOURCE)LOW_HouseOfHope_AD_Raphael_Combat_YurgirBetrayerDied_140c5e5d-91a1-7e07-5f0d-118ac8815f46);

// Reaction on Hope's death
IF
DB_LOW_HouseOfHope_IncludeHope(1)
THEN
DB_CombatReact_AD_OnDeathOther(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, S_LOW_RealHope_1947e869-a95d-43c6-81f7-b4c4f90d95ce, (DIALOGRESOURCE)LOW_HouseOfHope_AD_Raphael_Combat_HopeDied_e7b360f6-b845-7556-c3af-41ee4cc4dc00);

PROC
PROC_LOW_HouseOfHope_HoldRaphaelCombatAD()
AND
DB_CombatReact_AD_OnDeathOther(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _DyingNPC, _AD)
THEN
NOT DB_CombatReact_AD_OnDeathOther(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _DyingNPC, _AD);
DB_LOW_HouseOfHope_OnDeathOther_Hold(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _DyingNPC, _AD);

PROC
PROC_LOW_HouseOfHope_ResumeRaphaelCombatAD()
AND
DB_LOW_HouseOfHope_OnDeathOther_Hold(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _DyingNPC, _AD)
THEN
NOT DB_LOW_HouseOfHope_OnDeathOther_Hold(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _DyingNPC, _AD);
DB_CombatReact_AD_OnDeathOther(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _DyingNPC, _AD);

IF
StatusApplied((CHARACTER)_Player, "LOW_RAPHAEL_SOULLESS",_,_)
AND
DB_Players(_Player)
AND
HasAppliedStatus(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "LOW_RAPHAEL_MONSTER_FORM", 0)
AND
QRY_OnlyOnce("LOW_HouseOfHope_RaphaelTakesSoul")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_Raphael_Combat_SoulTaken_a557f941-cee5-6c44-32ef-12cff76eea27, S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8);

IF
CastSpell((CHARACTER)_Player, "Target_LOW_Raphael_RestoreSoul",_,_,_)
AND
DB_Players(_Player)
AND
QRY_OnlyOnce("LOW_HouseOfHope_SoulRestored")
THEN
PROC_TryStartAD((DIALOGRESOURCE)LOW_HouseOfHope_AD_Raphael_Combat_SoulIsBack_3e4a4057-47a3-fe48-7d90-043966efc715, S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8);

//END_REGION

//REGION Incubus followup

// Debug

IF
TextEvent("LOW_HOH_IncubusFollowup")
AND
GetHostCharacter(_Player)
THEN
SetFlag(LOW_HouseOfHope_State_GaveBodyToIncubus_54fb1ca4-b259-c4d8-7f9b-47b3dd889020, _Player);
SetFlag(LOW_HouseOfHope_State_IncubusFollowup_6bfd6aaa-853d-437e-8b09-3370d04c9894);

// Setting up the followup

IF
FlagSet((FLAG)LOW_HouseOfHope_State_GaveBodyToIncubus_54fb1ca4-b259-c4d8-7f9b-47b3dd889020,_,_)
AND
NOT DB_PermaDefeated(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26)
THEN
DB_LOW_HouseOfHope_IncubusFollowup(1);

IF
DB_PermaDefeated(S_LOW_HouseOfHope_Incubus_3947e0e2-3b4c-4a39-ac53-454e95665b26)
AND
DB_LOW_HouseOfHope_IncubusFollowup(1)
THEN
NOT DB_LOW_HouseOfHope_IncubusFollowup(1);

PROC
PROC_LongRest()
AND
DB_LOW_HouseOfHope_IncubusFollowup(1)
THEN
SetFlag((FLAG)LOW_HouseOfHope_State_IncubusFollowup_6bfd6aaa-853d-437e-8b09-3370d04c9894);
NOT DB_LOW_HouseOfHope_IncubusFollowup(1);

// Triggering the followup

IF
FlagSet(LOW_HouseOfHope_State_IncubusFollowup_6bfd6aaa-853d-437e-8b09-3370d04c9894,_,_)
AND
DB_LOW_HouseOfHope_IncubusFollowupTriggers(_Trigger)
THEN
PROC_TriggerRegisterForPlayers(_Trigger);

IF
EnteredTrigger(_Player, _Trigger)
AND
DB_LOW_HouseOfHope_IncubusFollowupTriggers(_Trigger)
AND
GetFlag(LOW_HouseOfHope_State_GaveBodyToIncubus_54fb1ca4-b259-c4d8-7f9b-47b3dd889020, _Player, 1)
THEN
PROC_LOW_HouseOfHope_IncubusFollowup(_Player);

PROC
PROC_LOW_HouseOfHope_IncubusFollowup((CHARACTER)_Player)
AND
QRY_SpeakerIsAvailable(_Player)
AND
QRY_StartDialog_Fixed((DIALOGRESOURCE)LOW_HouseOfHope_Incubus_BodyGivenFollowup_ae9218a4-07b1-4212-dacb-c539266150b8, _Player)
THEN
PROC_LOW_HouseOfHope_UnregisterIncubusFollowup();

PROC
PROC_LOW_HouseOfHope_UnregisterIncubusFollowup()
AND
DB_LOW_HouseOfHope_IncubusFollowupTriggers(_Trigger)
THEN
PROC_TriggerUnregisterForPlayers(_Trigger);

//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act3b"
