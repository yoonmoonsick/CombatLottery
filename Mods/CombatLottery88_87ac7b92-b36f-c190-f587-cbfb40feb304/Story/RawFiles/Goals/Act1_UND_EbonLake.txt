Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_UND_EbonLake_Raft_Parts((ITEM)S_UND_EbonLake_RaftInvisibleHelperAtCave_dc1b4e53-bd15-43d7-8a19-0fc32e875e7d, (ITEM)S_UND_EbonLake_RaftAtCave_FullRaft_a24aa852-9f72-48bc-8d94-7a92da7ca4c1);
DB_UND_EbonLake_Raft_Parts(S_UND_EbonLake_RaftInvisibleHelperAtCamp_98ee3fd4-031b-4d3a-b305-34b4889c2040, S_UND_EbonLake_RaftAtCamp_FullRaft_eec3661a-7173-48c2-8793-2970d2c9618d);

DB_UND_EbonLake_Raft_Dialogs((ITEM)S_UND_EbonLake_RaftInvisibleHelperAtCave_dc1b4e53-bd15-43d7-8a19-0fc32e875e7d, (DIALOGRESOURCE)UND_DarkLake_Boat_3a2b4e5e-2406-f9c1-9879-c36072d1580f);
DB_UND_EbonLake_Raft_Dialogs(S_UND_EbonLake_RaftInvisibleHelperAtCamp_98ee3fd4-031b-4d3a-b305-34b4889c2040, UND_DarkLake_Boat_3a2b4e5e-2406-f9c1-9879-c36072d1580f);
DB_UND_EbonLake_Raft_Dialogs(S_UND_EbonLake_RaftInvisibleHelperAtLake_7a06c836-c692-4682-afcb-a67421b43c5a, UND_DarkLake_Boat_3a2b4e5e-2406-f9c1-9879-c36072d1580f);

DB_UND_EbonLake_Raft_DefaultLocations((ITEM)S_UND_EbonLake_RaftInvisibleHelperAtCave_dc1b4e53-bd15-43d7-8a19-0fc32e875e7d, (FLAG)UND_EbonLake_State_RaftAtCave_beb83efd-711a-4e20-8d87-470050aebee8);
DB_UND_EbonLake_Raft_DefaultLocations((ITEM)S_UND_EbonLake_RaftInvisibleHelperAtLake_7a06c836-c692-4682-afcb-a67421b43c5a, (FLAG)UND_EbonLake_State_RaftAtLake_8ff8fe26-4546-40e0-94a5-03dba9001650);
DB_UND_EbonLake_Raft_DefaultLocations((ITEM)S_UND_EbonLake_RaftInvisibleHelperAtCamp_98ee3fd4-031b-4d3a-b305-34b4889c2040, (FLAG)UND_EbonLake_State_RaftAtCamp_526b966d-e826-4290-8331-e4747c1df3a5);

// helper, go to destination flag, destination flag
DB_UND_EbonLake_Raft_Locations((ITEM)S_UND_EbonLake_RaftInvisibleHelperAtCave_dc1b4e53-bd15-43d7-8a19-0fc32e875e7d, (FLAG)UND_EbonLake_State_RaftAtLake_8ff8fe26-4546-40e0-94a5-03dba9001650, (FLAG)UND_EbonLake_Event_MoveToLake_c3786fb8-8c5e-4ad5-8742-3b50477aedfa);
DB_UND_EbonLake_Raft_Locations((ITEM)S_UND_EbonLake_RaftInvisibleHelperAtCave_dc1b4e53-bd15-43d7-8a19-0fc32e875e7d, UND_EbonLake_State_RaftAtCamp_526b966d-e826-4290-8331-e4747c1df3a5, UND_EbonLake_Event_MoveToCamp_0da8fee9-b7cb-4551-9baa-ec930c118716);
DB_UND_EbonLake_Raft_Locations(S_UND_EbonLake_RaftInvisibleHelperAtLake_7a06c836-c692-4682-afcb-a67421b43c5a, UND_EbonLake_State_RaftAtCave_beb83efd-711a-4e20-8d87-470050aebee8, UND_EbonLake_Event_MoveToCave_00de3138-c329-4446-86a0-33c0b2956793);
DB_UND_EbonLake_Raft_Locations(S_UND_EbonLake_RaftInvisibleHelperAtLake_7a06c836-c692-4682-afcb-a67421b43c5a, UND_EbonLake_State_RaftAtCamp_526b966d-e826-4290-8331-e4747c1df3a5, UND_EbonLake_Event_MoveToCamp_0da8fee9-b7cb-4551-9baa-ec930c118716);
DB_UND_EbonLake_Raft_Locations(S_UND_EbonLake_RaftInvisibleHelperAtCamp_98ee3fd4-031b-4d3a-b305-34b4889c2040, UND_EbonLake_State_RaftAtCave_beb83efd-711a-4e20-8d87-470050aebee8, UND_EbonLake_Event_MoveToCave_00de3138-c329-4446-86a0-33c0b2956793);

DB_UND_EbonLake_Raft_Locations_PlayerPositions((FLAG)UND_EbonLake_State_RaftAtCave_beb83efd-711a-4e20-8d87-470050aebee8, 1, (TRIGGER)S_UND_DarkLake_BoatPassengerPositionAtCave_906d8dc6-3824-4d37-a09a-40d49831ef74);
DB_UND_EbonLake_Raft_Locations_PlayerPositions(UND_EbonLake_State_RaftAtCave_beb83efd-711a-4e20-8d87-470050aebee8, 2, S_UND_DarkLake_BoatPassengerPositionAtCave_906d8dc6-3824-4d37-a09a-40d49831ef74);
DB_UND_EbonLake_Raft_Locations_PlayerPositions(UND_EbonLake_State_RaftAtCave_beb83efd-711a-4e20-8d87-470050aebee8, 3, S_UND_DarkLake_BoatPassengerPositionAtCave_906d8dc6-3824-4d37-a09a-40d49831ef74);
DB_UND_EbonLake_Raft_Locations_PlayerPositions(UND_EbonLake_State_RaftAtCave_beb83efd-711a-4e20-8d87-470050aebee8, 4, S_UND_DarkLake_BoatPassengerPositionAtCave_906d8dc6-3824-4d37-a09a-40d49831ef74);

DB_UND_EbonLake_Raft_Locations_PlayerPositions(UND_EbonLake_State_RaftAtLake_8ff8fe26-4546-40e0-94a5-03dba9001650, 1, S_UND_DarkLake_PlayerPositionOnBoat_001_5fcbda6a-c5fa-42ce-99b4-026c7c437833);
DB_UND_EbonLake_Raft_Locations_PlayerPositions(UND_EbonLake_State_RaftAtLake_8ff8fe26-4546-40e0-94a5-03dba9001650, 2, S_UND_DarkLake_PlayerPositionOnBoat_002_901baaec-bbfd-4d73-bba7-1b6274438e9d);
DB_UND_EbonLake_Raft_Locations_PlayerPositions(UND_EbonLake_State_RaftAtLake_8ff8fe26-4546-40e0-94a5-03dba9001650, 3, S_UND_DarkLake_PlayerPositionOnBoat_003_568d79f5-d6a7-4b3d-a3a1-dd3b1ef721e4);
DB_UND_EbonLake_Raft_Locations_PlayerPositions(UND_EbonLake_State_RaftAtLake_8ff8fe26-4546-40e0-94a5-03dba9001650, 4, S_UND_DarkLake_PlayerPositionOnBoat_004_3aa8d1e5-ea5e-425e-a47e-8f37a0908f26);

//TODO: add separate positions for Ketheric Release
DB_UND_EbonLake_Raft_Locations_PlayerPositions(UND_EbonLake_State_RaftAtCamp_526b966d-e826-4290-8331-e4747c1df3a5, 1, S_UND_DarkLake_BoatPassengerPositionAtCamp_3478b34d-0e4f-4a4b-8f9f-b7d9361eec8b);
DB_UND_EbonLake_Raft_Locations_PlayerPositions(UND_EbonLake_State_RaftAtCamp_526b966d-e826-4290-8331-e4747c1df3a5, 2, S_UND_DarkLake_BoatPassengerPositionAtCamp_3478b34d-0e4f-4a4b-8f9f-b7d9361eec8b);
DB_UND_EbonLake_Raft_Locations_PlayerPositions(UND_EbonLake_State_RaftAtCamp_526b966d-e826-4290-8331-e4747c1df3a5, 3, S_UND_DarkLake_BoatPassengerPositionAtCamp_3478b34d-0e4f-4a4b-8f9f-b7d9361eec8b);
DB_UND_EbonLake_Raft_Locations_PlayerPositions(UND_EbonLake_State_RaftAtCamp_526b966d-e826-4290-8331-e4747c1df3a5, 4, S_UND_DarkLake_BoatPassengerPositionAtCamp_3478b34d-0e4f-4a4b-8f9f-b7d9361eec8b);

// invisible helper, raft, default state
DB_UND_EbonLake_Raft_Hideable((ITEM)S_UND_EbonLake_RaftInvisibleHelperAtCave_dc1b4e53-bd15-43d7-8a19-0fc32e875e7d, (FLAG)UND_EbonLake_State_RaftAtCave_beb83efd-711a-4e20-8d87-470050aebee8, S_UND_EbonLake_RaftAtCave_FullRaft_a24aa852-9f72-48bc-8d94-7a92da7ca4c1, 1);
DB_UND_EbonLake_Raft_Hideable(S_UND_EbonLake_RaftInvisibleHelperAtCamp_98ee3fd4-031b-4d3a-b305-34b4889c2040, UND_EbonLake_State_RaftAtCamp_526b966d-e826-4290-8331-e4747c1df3a5, S_UND_EbonLake_RaftAtCamp_FullRaft_eec3661a-7173-48c2-8793-2970d2c9618d, 0);

DB_UND_EbonLake_Raft_ComposeCrewFromTrigger((ITEM)S_UND_EbonLake_RaftInvisibleHelperAtLake_7a06c836-c692-4682-afcb-a67421b43c5a, (TRIGGER)S_UND_DarkLake_LakeEncounterTrigger_d26a46e5-4711-4fd9-80c6-18c5a1196ec9);

DB_GLO_CompoundFlag((FLAG)UND_DarkLake_State_PeacefulResolution_629a38e0-ba91-2a6b-bdcc-636fdbb9d20e, (FLAG)UND_DarkLake_State_LakeEncounterHappened_8fbcde00-13b9-633c-7ccf-2486d983ca3e);
DB_GLO_CompoundFlag((FLAG)UND_DarkLake_State_HostileResolution_d9683a6f-10b4-87e5-9921-e25287267211, (FLAG)UND_DarkLake_State_LakeEncounterHappened_8fbcde00-13b9-633c-7ccf-2486d983ca3e);

DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)UND_DarkLake_Boat_3a2b4e5e-2406-f9c1-9879-c36072d1580f, (TRIGGER)S_UND_DarkLake_BoatDialogTriggerAtCave_d3060315-27c6-4060-b4ca-335dc03bf2d0, 1, 0, 1);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)UND_DarkLake_Boat_3a2b4e5e-2406-f9c1-9879-c36072d1580f, (TRIGGER)S_UND_DarkLake_LakeEncounterTrigger_d26a46e5-4711-4fd9-80c6-18c5a1196ec9, 1, 0, 1);
DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)UND_DarkLake_RaftEvent_10631f38-24d4-b8eb-c913-286fedfb5cfc, (TRIGGER)S_UND_DarkLake_LakeEncounterTrigger_d26a46e5-4711-4fd9-80c6-18c5a1196ec9, 1, 0, 1);

//REGION Preparing the duergar team
SetFlag(UND_DarkLake_State_DuergarsAtLake_85d7bbfc-bffe-48bb-955d-f1f450b16e39, NULL_00000000-0000-0000-0000-000000000000);
TriggerRegisterForCharacter(S_UND_DarkLake_RaftCaptainBoxOnPlayerRaft_e8dcba26-a7e1-4a72-8d9d-4a6f52dd3eef, S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec);
//END_REGION Preparing the duergar team

//REGION Duegar Squad
DB_UND_DuergarSquad((CHARACTER)S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec);
DB_UND_DuergarSquad(S_UND_DuergarSquadDefiant_3cec487d-d5cf-42c9-a009-0124cb432341);
DB_UND_DuergarSquad(S_UND_DuergarSquadDilligent_a7338653-4d88-440e-aee6-4d5b3e611a2d);
DB_UND_DuergarSquad(S_UND_DuergarSquadRatty_64e38ef0-9779-499c-9f0a-ea013ee81442);
DB_UND_DuergarSquad(S_UND_DuergarSquadRude_b15669aa-831b-43d7-ac7b-efea2eb09018);
DB_UND_DuergarSquad(S_UND_DuergarSquadAlchemist_2243e892-f360-44cf-b2ef-90364059dd22);

DB_UND_DuergarSquad_PositionsAtShore((CHARACTER)S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec, S_UND_DarkLake_AfterCombatPosition_000_a14be182-83c7-41a6-818c-1660bb78f910);
DB_UND_DuergarSquad_PositionsAtShore(S_UND_DuergarSquadDefiant_3cec487d-d5cf-42c9-a009-0124cb432341, S_UND_DarkLake_AfterCombatPosition_001_d1cc2458-259a-4655-950a-0fa8387e021f);
DB_UND_DuergarSquad_PositionsAtShore(S_UND_DuergarSquadDilligent_a7338653-4d88-440e-aee6-4d5b3e611a2d, S_UND_DarkLake_AfterCombatPosition_002_e786d8e9-43a1-47f2-a0a4-a8ee4625e160);
DB_UND_DuergarSquad_PositionsAtShore(S_UND_DuergarSquadRatty_64e38ef0-9779-499c-9f0a-ea013ee81442, S_UND_DarkLake_AfterCombatPosition_003_f48f438b-c619-4203-9a5b-5b56a4347b70);
DB_UND_DuergarSquad_PositionsAtShore(S_UND_DuergarSquadRude_b15669aa-831b-43d7-ac7b-efea2eb09018, S_UND_DarkLake_AfterCombatPosition_004_5946d2b1-c154-44f8-8372-ebf5a3eb1b5d);
DB_UND_DuergarSquad_PositionsAtShore(S_UND_DuergarSquadAlchemist_2243e892-f360-44cf-b2ef-90364059dd22, S_UND_DarkLake_AfterCombatPosition_005_adff257e-73d3-4f08-9219-b818e0fd9808);

DB_Dialogs(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec, UND_DarkLake_RaftEvent_10631f38-24d4-b8eb-c913-286fedfb5cfc);
DB_Dialogs(S_UND_DuergarSquadDefiant_3cec487d-d5cf-42c9-a009-0124cb432341, UND_DuergarSquadDefiant_66347140-d6d5-9b5e-04b0-4602e0bd6339);
DB_Dialogs(S_UND_DuergarSquadDilligent_a7338653-4d88-440e-aee6-4d5b3e611a2d, UND_DuergarSquadDilligent_cf562f4e-1a0f-71ff-1637-37200d1efb5a);
DB_Dialogs(S_UND_DuergarSquadRatty_64e38ef0-9779-499c-9f0a-ea013ee81442, UND_DuergarSquadRatty_245eb40c-fa30-e79e-7695-3497433d1a9c);
DB_Dialogs(S_UND_DuergarSquadRude_b15669aa-831b-43d7-ac7b-efea2eb09018, UND_DuergarSquadRude_981754dd-ffd5-40c4-d465-51d1308a177c);
DB_Dialogs(S_UND_DuergarSquadAlchemist_2243e892-f360-44cf-b2ef-90364059dd22, (DIALOGRESOURCE)UND_DuergarSquadAlchemist_b12a3303-3f06-0a29-54fb-5ae03b18064a);
DB_DialogBlockTradeButton((DIALOGRESOURCE)UND_DarkLake_RaftEvent_10631f38-24d4-b8eb-c913-286fedfb5cfc);
DB_UND_EbonLake_RaftCaptainTrackDialogAttack(1);
//END_REGION

DB_DangerZone(S_UND_DarkLake_LakeEncounterTrigger_d26a46e5-4711-4fd9-80c6-18c5a1196ec9, "UND_EbonLake_LakeEncounter");

PROC_TriggerRegisterForPlayers(S_UND_DarkLake_BoatDialogTriggerAtCave_d3060315-27c6-4060-b4ca-335dc03bf2d0);
PROC_TriggerRegisterForPlayers(S_UND_DarkLake_BoatDialogTriggerAtCave_ReadyCheck_90302dc3-8659-4b13-beb3-0194ccb3be38);
PROC_TriggerRegisterForPlayers(S_UND_DarkLake_BoatAtCaveArea_ec8377d5-69da-43bb-a4e4-6de0caf59924);
PROC_TriggerRegisterForPlayers(S_UND_DarkLake_LakeVB_14a19173-ec4c-403a-bfb1-715bc1430219);

SetFlag(UND_EbonLake_State_RaftAtCave_beb83efd-711a-4e20-8d87-470050aebee8, NULL_00000000-0000-0000-0000-000000000000); 

DB_FlagReactionAfterDialog((FLAG)UND_DarkLake_Event_PushRaftCaptainOffRaft_fa9f5b35-925c-c18d-4d00-6497194b1293, DIALOGRESOURCEGUID_UND_DarkLake_RaftEvent_10631f38-24d4-b8eb-c913-286fedfb5cfc);
DB_FlagReactionAfterDialog((FLAG)UND_DarkLake_Event_MoveToCave_d580a352-2202-7c43-07c6-3ede5683cb0f, (DIALOGRESOURCE)UND_DarkLake_RaftEvent_10631f38-24d4-b8eb-c913-286fedfb5cfc);
DB_GlobalFlagReactionAfterDialog(UND_DarkLake_State_HostileResolution_d9683a6f-10b4-87e5-9921-e25287267211, DIALOGRESOURCEGUID_UND_DarkLake_RaftEvent_10631f38-24d4-b8eb-c913-286fedfb5cfc);
DB_GlobalFlagReactionAfterDialog(UND_DarkLake_State_PeacefulResolution_629a38e0-ba91-2a6b-bdcc-636fdbb9d20e, DIALOGRESOURCEGUID_UND_DarkLake_RaftEvent_10631f38-24d4-b8eb-c913-286fedfb5cfc);

DB_AutoSaveTrigger(S_UND_DarkLake_Autosave_218c10ed-142f-4952-970f-3db54bf7bf71);
DB_OneShot_VoiceBarkTrigger(S_UND_DarkLake_LakeVB_14a19173-ec4c-403a-bfb1-715bc1430219, UND_DarkLake_VB_FoundBoat_1dd40113-54e6-c3ef-01df-d778bd964e7b, "PerUserAndNearbyPlayers");

//REGION Patrol
SetOnStage(S_UND_DarkLake_Patrol_000_cb258cd3-3b7f-48b4-883e-a008ea6e9e38, 0);
SetOnStage(S_UND_DarkLake_Patrol_001_a154f62e-771e-4bac-8af6-c28d62019d1a, 0);
//END_REGION Patrol

//REGION Boats
DB_UND_EbonLake_BoatsAtCamp((ITEM)S_UND_DuergarCamp_Boat001_75d50606-a7ff-4b37-9791-6cb80f2dbbb6);
DB_UND_EbonLake_BoatsAtCamp((ITEM)S_UND_DuergarCamp_Boat002_8206ab2e-3a61-4412-916d-53487698f7f6);
DB_UND_EbonLake_BoatsAtCamp((ITEM)S_UND_DuergarCamp_Boat003_a3e38c4f-c095-4ec0-892c-cec99e8ded5e);
DB_UND_EbonLake_BoatsAtCamp((ITEM)S_UND_DuergarCamp_Boat004_04b4dff4-faef-4d03-9e20-d75f068ce8fb);

DB_UND_EbonLake_BoatsAtCave((ITEM)S_UND_DuergarCamp_BoatAtCave_f350ecc8-67ab-4ffa-ba0f-2ca6a4bc9845);

DB_FlagReactionAfterDialog((FLAG)UND_DarkLake_Event_MoveToCaveOnBoat_443df3f1-d0c4-4e72-a968-194ee6dc6c40, UND_DarkLake_DuergarBoatAtCamp_b7ab6b74-0da5-938f-40e3-ae8d1222c77a);
DB_FlagReactionAfterDialog((FLAG)UND_DarkLake_Event_MoveToCampOnBoat_28ab45e0-54ae-48a3-a164-82f39971e64e, UND_DarkLake_DuergarBoatAtCave_0c3d00d8-77ac-d41e-0ed2-f2d213d94c00);
//END_REGION Boats

//REGION Duergar Camp Checkpoint
DB_DialogBlockTradeButton((DIALOGRESOURCE)UND_DuergarCamp_Checkpoint_c40716bd-9e42-54a5-06ea-7c0cbea85a8e);
DB_DialogBlockAttackButton((DIALOGRESOURCE)UND_DuergarCamp_Checkpoint_c40716bd-9e42-54a5-06ea-7c0cbea85a8e);
DB_GlobalFlagReactionAfterDialog(UND_DuergarCamp_State_DocsHostile_c2e36c80-970a-4fc0-ac4b-45a665bbfcd4, (DIALOGRESOURCE)UND_DuergarCamp_Checkpoint_c40716bd-9e42-54a5-06ea-7c0cbea85a8e);
//END_REGION Duergar Camp Checkpoint

PROC_TriggerRegisterForPlayers(S_UND_DarkLake_BoatAtCampArea_467f81f9-f1d6-4c2a-a3d5-1ac0d8897b76);

DB_DialogMoneyTransfer(1, UND_DuergarCamp_Checkpoint_c40716bd-9e42-54a5-06ea-7c0cbea85a8e, 100); // Bribe

DB_AddCharactersInTriggerToDialog((DIALOGRESOURCE)UND_DuergarCamp_Checkpoint_c40716bd-9e42-54a5-06ea-7c0cbea85a8e, (TRIGGER)S_UND_DarkLake_BoatAtCampArea_467f81f9-f1d6-4c2a-a3d5-1ac0d8897b76, 1);

TriggerRegisterForItems((TRIGGER)S_UND_DarkLake_LakeEncounter_ItemTrigger_81f523da-e930-433f-8734-4988d3bdd1ef);
KBSECTION
//REGION Debug code
IF
EnteredTrigger(_, S_UND_DarkLake_BoatAtCampArea_467f81f9-f1d6-4c2a-a3d5-1ac0d8897b76)
AND
GetFlag(Debug_UND_DarkLake_HostileResolution_1eb679da-0be9-cb33-4f02-b4c7ebd4e72a, NULL_00000000-0000-0000-0000-000000000000, 1)
THEN
PROC_Debug_UND_EbonLake_HostileResolution();

PROC
PROC_Debug_UND_EbonLake_HostileResolution()
THEN
SetFlag(UND_DarkLake_State_HostileResolution_d9683a6f-10b4-87e5-9921-e25287267211, NULL_00000000-0000-0000-0000-000000000000, 0);
SetFlag(UND_DarkLake_State_LakeEncounterHappened_8fbcde00-13b9-633c-7ccf-2486d983ca3e, NULL_00000000-0000-0000-0000-000000000000, 0);
ClearFlag(UND_EbonLake_State_RaftAtCave_beb83efd-711a-4e20-8d87-470050aebee8, NULL_00000000-0000-0000-0000-000000000000); 
SetFlag(UND_EbonLake_State_RaftAtCamp_526b966d-e826-4290-8331-e4747c1df3a5, NULL_00000000-0000-0000-0000-000000000000);
PROC_UND_EbonLake_Raft_Show((FLAG)UND_EbonLake_State_RaftAtCamp_526b966d-e826-4290-8331-e4747c1df3a5);
PROC_UND_EbonLake_Raft_Hide((ITEM)S_UND_EbonLake_RaftInvisibleHelperAtCave_dc1b4e53-bd15-43d7-8a19-0fc32e875e7d);
PROC_GlobalClearFlagAndCache(Debug_UND_DarkLake_HostileResolution_1eb679da-0be9-cb33-4f02-b4c7ebd4e72a);
ObjectTimerLaunch(S_UND_DuergarGuard_AtPier_01_5ff28d97-e070-4805-a856-3112df670e1f, "UND_DuergarCamp_DocsCheckpoint", 1000);

IF
ObjectTimerFinished(S_UND_DuergarGuard_AtPier_01_5ff28d97-e070-4805-a856-3112df670e1f, "UND_DuergarCamp_DocsCheckpoint")
THEN
DB_SpotPlayers(S_UND_DuergarGuard_AtPier_01_5ff28d97-e070-4805-a856-3112df670e1f, "UND_DuergarCamp_DocsCheckpoint", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_Debug_UND_EbonLake_HostileResolution()
AND
DB_UND_DuergarSquad(_SquadMember)
THEN
Die(_SquadMember, DEATHTYPE.DoT, 1);
SetOnStage(_SquadMember, 0);

IF
EnteredTrigger(_, S_UND_DarkLake_BoatAtCampArea_467f81f9-f1d6-4c2a-a3d5-1ac0d8897b76)
AND
GetFlag(Debug_UND_DarkLake_PeacefulResolution_c7997694-456a-1529-be70-362b77c1050a, NULL_00000000-0000-0000-0000-000000000000, 1)
THEN
SetCombatGroupID(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec,"");
PROC_Debug_UND_EbonLake_PeacefulResolution();

PROC
PROC_Debug_UND_EbonLake_PeacefulResolution()
THEN
SetFlag((FLAG)UND_DarkLake_State_PeacefulResolution_629a38e0-ba91-2a6b-bdcc-636fdbb9d20e, NULL_00000000-0000-0000-0000-000000000000, 0);
SetFlag((FLAG)UND_DarkLake_State_LakeEncounterHappened_8fbcde00-13b9-633c-7ccf-2486d983ca3e, NULL_00000000-0000-0000-0000-000000000000, 0);
ClearFlag(UND_EbonLake_State_RaftAtCave_beb83efd-711a-4e20-8d87-470050aebee8, NULL_00000000-0000-0000-0000-000000000000); 
SetFlag(UND_EbonLake_State_RaftAtCamp_526b966d-e826-4290-8331-e4747c1df3a5, NULL_00000000-0000-0000-0000-000000000000);
PROC_UND_EbonLake_Raft_Show((FLAG)UND_EbonLake_State_RaftAtCamp_526b966d-e826-4290-8331-e4747c1df3a5);
PROC_UND_EbonLake_Raft_Hide((ITEM)S_UND_EbonLake_RaftInvisibleHelperAtCave_dc1b4e53-bd15-43d7-8a19-0fc32e875e7d);
TeleportTo(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec, S_Debug_DuergarCamp_bf6e6f0b-0e6c-47e6-bff4-474a427372a0);
SetOnStage(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec, 1);
ObjectTimerLaunch(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec, "UND_DarkLake_RaftCaptain_StartSpottingInCamp", 1000);
PROC_GlobalClearFlagAndCache(Debug_UND_DarkLake_PeacefulResolution_c7997694-456a-1529-be70-362b77c1050a);

IF
TextEvent("debug_toraft")
AND
DB_Players(_Player)
THEN
Die(S_UND_LoneDuergar_BoatGuard_8146788d-9d39-4cf2-99ca-03484deb0c55);
Die(S_UND_LoneDuergar_05c338d9-4590-4c4b-b87e-8c27ea2c2b18);
SetFlag(Debug_ShadowHeartIsPlayer_50d74708-485b-4342-2b1a-2efb5f1ba211, NULL_00000000-0000-0000-0000-000000000000);
SetFlag(Debug_AddShadowHeart_c3be7a23-a663-d778-50f9-a52f6cfe78bf, _Player);
PROC_TeleportPartiesTo((TRIGGER)S_UND_DarkLake_BoatPassengerPositionAtCave_906d8dc6-3824-4d37-a09a-40d49831ef74, "");
//END_REGION Debug

//REGION Init
IF
DB_UND_DuergarSquad(_Duergar)
THEN
DB_GLO_DefeatCounter(_Duergar, "UND_EbonLake_DuergarSquad");
//END_REGION Init

//REGION Movement
IF
DB_UND_EbonLake_Raft_Hideable(_, _, _Raft, 0)
THEN
SetOnStage(_Raft, 0);

IF
UseFinished(_Char, _RaftPart, 1)
AND
DB_Players(_Char)
AND
DB_UND_EbonLake_Raft_Parts(_InvisibleHelper, _RaftPart)
THEN
PROC_UND_EbonLake_ProcessUseOfRaft(_Char, _InvisibleHelper);

PROC
PROC_UND_EbonLake_ProcessUseOfRaft((CHARACTER)_Player, (ITEM)_InvisibleHelper)
AND
DB_Players(_Player)
AND
DB_UND_EbonLake_Raft_Dialogs(_InvisibleHelper, _Dialog)
AND
NOT DB_Is_InCombat(_Player, _)
THEN
DB_UND_EbonLake_RaftUsed((DIALOGRESOURCE)_Dialog, (CHARACTER)_Player);
SysClear("DB_UND_EbonLake_ReadyPlayers", 1);
PROC_UND_EbonLake_RaftUsedReadyCheck(_Player);

PROC
PROC_UND_EbonLake_RaftUsedReadyCheck((CHARACTER)_Player)
AND
QRY_UND_EbonLake_GetPlayerInRaftTrigger(_Player, (CHARACTER)NULL_00000000-0000-0000-0000-000000000000, (CHARACTER)NULL_00000000-0000-0000-0000-000000000000)
AND
DB_QRYRTN_UND_EbonLake_GetPlayerInRaftTrigger((CHARACTER)_Player2)
AND
QRY_UND_EbonLake_GetPlayerInRaftTrigger(_Player,_Player2,(CHARACTER)NULL_00000000-0000-0000-0000-000000000000)
AND
DB_QRYRTN_UND_EbonLake_GetPlayerInRaftTrigger((CHARACTER)_Player3)
AND
QRY_UND_EbonLake_GetPlayerInRaftTrigger(_Player,_Player2,_Player3)
AND
DB_QRYRTN_UND_EbonLake_GetPlayerInRaftTrigger((CHARACTER)_Player4)
THEN
DB_UND_EbonLake_ReadyPlayers(_Player);
DB_UND_EbonLake_ReadyPlayers(_Player2);
DB_UND_EbonLake_ReadyPlayers(_Player3);
DB_UND_EbonLake_ReadyPlayers(_Player4);
PROC_UND_EbonLake_BlockReadyCheckForGlutOwner(_Player);
PROC_UND_EbonLake_BlockReadyCheckForGlutOwner(_Player2);
PROC_UND_EbonLake_BlockReadyCheckForGlutOwner(_Player3);
PROC_UND_EbonLake_BlockReadyCheckForGlutOwner(_Player4);
PROC_UND_EbonLake_ReadyCheckSpecific(_Player, _Player2, _Player3, _Player4);

// no matter who clicks on the boat, the ready check for the owner of Glut fails and Glut starts a dialog with the owner
PROC
PROC_UND_EbonLake_BlockReadyCheckForGlutOwner((CHARACTER)_Player)
AND
CharacterGetOwner(S_UND_Myconid_BroodingSovereign_82af0858-d739-4c9d-84c8-5e6760e22e46, _Player)
AND
QRY_UND_BroodingSovereign_GoHomeQRY(_Player)
AND
QRY_UND_BroodingSovereign_LeaveDialog(UND_Myconid_BroodingSovereign_Raft_f6f33683-5889-e6b0-e6a9-0810856ec3ea,_Player,_Player)
THEN
DB_UND_EbonLake_GlutOwnerReadyCheckBlocked(_Player);
SetReadyCheckBlocked(_Player, 1);

PROC
PROC_UND_EbonLake_ReadyCheckSpecific((CHARACTER)_Player, (CHARACTER)_Player2, (CHARACTER)_Player3, (CHARACTER)_Player4)
AND
_Player2 == NULL_00000000-0000-0000-0000-000000000000 // only one player present, no need for checks
AND
DB_UND_EbonLake_GlutOwnerReadyCheckBlocked(_AnyPlayer)
THEN
NOT DB_UND_EbonLake_GlutOwnerReadyCheckBlocked(_AnyPlayer);
SetReadyCheckBlocked(_AnyPlayer, 0);

PROC
PROC_UND_EbonLake_ReadyCheckSpecific((CHARACTER)_Player, (CHARACTER)_Player2, (CHARACTER)_Player3, (CHARACTER)_Player4)
AND
_Player2 == NULL_00000000-0000-0000-0000-000000000000 // only one player present, no need for checks
AND
DB_UND_EbonLake_RaftUsed(_Dialog, _Player)
AND
QRY_StartDialog_Fixed(_Dialog, _Player)
THEN
DB_NOOP(1);

PROC
PROC_UND_EbonLake_ReadyCheckSpecific((CHARACTER)_Player, (CHARACTER)_Player2, (CHARACTER)_Player3, (CHARACTER)_Player4)
AND
_Player2 != NULL_00000000-0000-0000-0000-000000000000
THEN
ReadyCheckSpecific("ReadyCheck_EbonLake", "ReadyCheck_EbonLake", 0, _Player, _Player2, _Player3, _Player4);

QRY
QRY_UND_EbonLake_GetPlayerInRaftTrigger((CHARACTER)_Ignore1,(CHARACTER)_Ignore2,(CHARACTER)_Ignore3)
THEN
SysClear("DB_QRYRTN_UND_EbonLake_GetPlayerInRaftTrigger", 1);

// we need unique user characters
QRY
QRY_UND_EbonLake_GetPlayerInRaftTrigger((CHARACTER)_Ignore1,(CHARACTER)_Ignore2,(CHARACTER)_Ignore3)
AND
DB_Players(_Player)
AND
IsInTrigger(_Player, S_UND_DarkLake_BoatDialogTriggerAtCave_ReadyCheck_90302dc3-8659-4b13-beb3-0194ccb3be38, 1)
AND
NOT DB_QRYRTN_UND_EbonLake_GetPlayerInRaftTrigger(_)
AND
_Player != _Ignore1
AND
NOT QRY_SameUser(_Player, _Ignore1)
AND
_Player != _Ignore2
AND
NOT QRY_SameUser(_Player, _Ignore2)
AND
_Player != _Ignore3
AND
NOT QRY_SameUser(_Player, _Ignore3)
THEN
DB_QRYRTN_UND_EbonLake_GetPlayerInRaftTrigger(_Player);

QRY
QRY_UND_EbonLake_GetPlayerInRaftTrigger((CHARACTER)_Ignore1, (CHARACTER)_Ignore2, (CHARACTER)_Ignore3)
AND
NOT DB_QRYRTN_UND_EbonLake_GetPlayerInRaftTrigger(_)
THEN
DB_QRYRTN_UND_EbonLake_GetPlayerInRaftTrigger(NULL_00000000-0000-0000-0000-000000000000);

IF
ReadyCheckPassed("ReadyCheck_EbonLake")
AND
DB_UND_EbonLake_RaftUsed(_Dialog, _Player)
AND
QRY_StartDialog_Fixed(_Dialog, _Player)
THEN
DB_NOOP(1);

IF
ReadyCheckPassed("ReadyCheck_EbonLake")
AND
DB_UND_EbonLake_RaftUsed(_Dialog, _Player)
THEN
SysClear("DB_UND_EbonLake_RaftUsed", 2);

IF
ReadyCheckPassed("ReadyCheck_EbonLake")
AND
DB_UND_EbonLake_GlutOwnerReadyCheckBlocked(_Player)
THEN
NOT DB_UND_EbonLake_GlutOwnerReadyCheckBlocked(_Player);
SetReadyCheckBlocked(_Player, 0);

IF
ReadyCheckFailed("ReadyCheck_EbonLake")
AND
DB_UND_EbonLake_RaftUsed(_Dialog, _Player)
THEN
SysClear("DB_UND_EbonLake_RaftUsed", 2);

IF
ReadyCheckFailed("ReadyCheck_EbonLake")
AND
DB_UND_EbonLake_GlutOwnerReadyCheckBlocked(_Player)
THEN
NOT DB_UND_EbonLake_GlutOwnerReadyCheckBlocked(_Player);
SetReadyCheckBlocked(_Player, 0);

IF
DialogEnded(_Dialog, _ID)
AND
DB_UND_EbonLake_Raft_Dialogs(_, _Dialog)
AND
DB_UND_EbonLake_Raft_DefaultLocations(_InvisibleHelper, _LocationFlag)
AND
DB_GlobalFlag(_LocationFlag)
AND
DB_UND_EbonLake_Raft_Locations(_InvisibleHelper, _NewLocationStateFlag, _MoveToLocationFlag)
AND
DB_DialogPlayers(_ID, _Player, 1)
AND
GetFlag(_MoveToLocationFlag, _Player, 1)
THEN
ClearFlag(_MoveToLocationFlag, _Player);
PROC_UND_EbonLake_PrepareAndMoveRaft_Internal(_InvisibleHelper, (CHARACTER)_Player, _NewLocationStateFlag);

PROC
PROC_UND_EbonLake_PrepareAndMoveRaft_Internal((ITEM)_InvisibleHelper, (CHARACTER)_Player, (FLAG)_NewLocationStateFlag)
AND
NOT DB_UND_EbonLake_Raft_ComposeCrewFromTrigger(_InvisibleHelper, _)
THEN
PROC_UND_EbonLake_PrepareAndMoveRaft(_InvisibleHelper, _Player, _NewLocationStateFlag);

PROC
PROC_UND_EbonLake_PrepareAndMoveRaft_Internal((ITEM)_InvisibleHelper, (CHARACTER)_Player, (FLAG)_NewLocationStateFlag)
AND
DB_UND_EbonLake_Raft_ComposeCrewFromTrigger(_InvisibleHelper, _Trigger)
THEN
PROC_UND_EbonLake_PrepareAndMoveRaftFromTrigger(_InvisibleHelper, _Trigger, _NewLocationStateFlag);

PROC
PROC_UND_EbonLake_PrepareAndMoveRaft((ITEM)_InvisibleHelper, (CHARACTER)_Player, (FLAG)_NewLocationStateFlag)
THEN
SysClear("DB_UND_EbonLake_Raft_Captain", 1);
SysClear("DB_UND_EbonLake_Raft_Crew", 1);
PROC_UND_EbonLake_Raft_ComposeCrew(_Player);
PROC_UND_EbonLake_Raft_MoveCrewIn();
PROC_UND_EbonLake_Raft_Hide(_InvisibleHelper);
PROC_UND_EbonLake_Raft_Move(_NewLocationStateFlag);

PROC
PROC_UND_EbonLake_PrepareAndMoveRaftFromTrigger((ITEM)_InvisibleHelper, (TRIGGER)_Trigger, (FLAG)_NewLocationStateFlag)
THEN
SysClear("DB_UND_EbonLake_Raft_Crew", 1);
PROC_UND_EbonLake_Raft_ComposeCrewFrom(_Trigger);
PROC_UND_EbonLake_Raft_MoveCrewIn();
PROC_UND_EbonLake_Raft_Hide(_InvisibleHelper);
PROC_UND_EbonLake_Raft_Move(_NewLocationStateFlag);

PROC
PROC_UND_EbonLake_Raft_ComposeCrew((CHARACTER)_Character)
THEN
DB_UND_EbonLake_Raft_Captain((CHARACTER)_Character);
DB_UND_EbonLake_Raft_Crew((CHARACTER)_Character);

PROC
PROC_UND_EbonLake_Raft_ComposeCrew((CHARACTER)_Character)
AND
DB_Players(_Character2)
AND
_Character != _Character2
AND
IsInPartyWith(_Character2, _Character, 1)
AND
InSamePartyGroup(_Character2, _Character, 1)
THEN
DB_UND_EbonLake_Raft_Crew(_Character2);

PROC
PROC_UND_EbonLake_Raft_ComposeCrew((CHARACTER)_Character)
AND
DB_UND_EbonLake_ReadyPlayers(_Character2)
AND
_Character != _Character2
AND
_Character2 != NULL_00000000-0000-0000-0000-000000000000
THEN
DB_UND_EbonLake_Raft_Crew(_Character2);


PROC
PROC_UND_EbonLake_Raft_ComposeCrew((CHARACTER)_Character)
AND
DB_UND_EbonLake_ReadyPlayers(_Character2)
AND
_Character2 != _Character
AND
_Character2 != NULL_00000000-0000-0000-0000-000000000000
AND
DB_Players(_Character3)
AND
_Character3 != _Character
AND
_Character3 != _Character2
AND
IsInPartyWith(_Character3, _Character2, 1)
AND
InSamePartyGroup(_Character3, _Character2, 1)
THEN
DB_UND_EbonLake_Raft_Crew(_Character3);

PROC
PROC_UND_EbonLake_Raft_ComposeCrewFrom((TRIGGER)_Trigger)
AND
DB_Players(_Character)
AND
IsInTrigger(_Character, _Trigger, 1)
THEN
DB_UND_EbonLake_Raft_Crew(_Character);

IF
DB_UND_EbonLake_Raft_Crew(_Character)
THEN
PROC_ForceStopDialog(_Character);

PROC
PROC_UND_EbonLake_Raft_MoveCrewIn()
AND
DB_UND_EbonLake_Raft_Crew(_Character)
THEN
SetVisible(_Character, 0);
PROC_SetInvulnerable(_Character, 1);
Freeze(_Character);
PROC_UND_EbonLake_Fading_FadeOut(_Character, 1.0);

PROC
PROC_UND_EbonLake_Raft_Hide((ITEM)_InvisibleHelper)
AND
DB_UND_EbonLake_Raft_Hideable(_InvisibleHelper, _, _RaftRepresentative, _)
THEN
SetOnStage(_RaftRepresentative, 0);

PROC
PROC_UND_EbonLake_Raft_Move((FLAG)_NewLocationStateFlag)
THEN
DB_UND_EbonLake_Raft_InTrip(_NewLocationStateFlag);
TimerLaunch("UND_EbonLake_Timer_RaftMoving", 1000);

IF
TimerFinished("UND_EbonLake_Timer_RaftMoving")
AND
DB_UND_EbonLake_Raft_InTrip(_NewLocationStateFlag)
THEN
PROC_UND_EbonLake_Raft_ClearLocation();
SetFlag(_NewLocationStateFlag, NULL_00000000-0000-0000-0000-000000000000);
PROC_UND_EbonLake_Raft_Show(_NewLocationStateFlag);
TimerLaunch("UND_EbonLake_Timer_RaftMoved", 1000);

PROC
PROC_UND_EbonLake_Raft_ClearLocation()
AND
DB_UND_EbonLake_Raft_Locations(_, _Flag, _)
THEN
ClearFlag(_Flag, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_UND_EbonLake_Raft_Show((FLAG)_NewLocationStateFlag)
AND
DB_UND_EbonLake_Raft_Hideable(_, _NewLocationStateFlag, _Raft, _)
THEN
SetOnStage(_Raft, 1);

IF
TimerFinished("UND_EbonLake_Timer_RaftMoved")
AND
DB_UND_EbonLake_Raft_InTrip(_NewLocationStateFlag)
THEN
NOT DB_UND_EbonLake_Raft_InTrip(_NewLocationStateFlag);
PROC_UND_EbonLake_DisembarkCrew(_NewLocationStateFlag);
PROC_UND_EbonLake_Raft_Arrived_Hook(_NewLocationStateFlag);

PROC
PROC_UND_EbonLake_Raft_Arrived_Hook((FLAG)_NewLocationStateFlag)
THEN
DB_NOOP(1);
//END_REGION Movement

//REGION GENERIC Fading

PROC
PROC_UND_EbonLake_Fading_FadeOut((CHARACTER)_Player, (REAL)_FadeOutTime)
AND
DB_Players(_Player)
AND
GetReservedUserID(_Player, _UserId)
AND
NOT DB_UND_EbonLake_Fading_FadedOutUsers(_UserId)
THEN
ScreenFadeTo(_Player, _FadeOutTime, 0, "UND_EbonLake_Fading");
DB_UND_EbonLake_Fading_FadedOutUsers(_UserId);

PROC
PROC_UND_EbonLake_Fading_FadeIn((CHARACTER)_Player, (REAL)_FadeInTime)
AND
DB_Players(_Player)
AND
GetReservedUserID(_Player, _UserId)
AND
DB_UND_EbonLake_Fading_FadedOutUsers(_UserId)
THEN
ClearScreenFade(_Player, _FadeInTime, "UND_EbonLake_Fading");
NOT DB_UND_EbonLake_Fading_FadedOutUsers(_UserId);

//END_REGION GENERIC Fading

//REGION Disembarking
PROC
PROC_UND_EbonLake_DisembarkCrew((FLAG)_NewLocationStateFlag)
THEN
DB_UND_EbonLake_Raft_DisembarkPlayerIndex(0);
PROC_UND_EbonLake_Raft_Disembark(_NewLocationStateFlag);
TimerLaunch("UND_EbonLake_ChainParty", 100);
SysClear("DB_UND_EbonLake_Raft_DisembarkPlayerIndex", 1);
SysClear("DB_UND_EbonLake_Raft_Disembarked", 1);

PROC
PROC_UND_EbonLake_Raft_Disembark((FLAG)_NewLocationStateFlag)
AND
DB_UND_EbonLake_Raft_Crew(_Player)
AND
NOT DB_UND_EbonLake_Raft_Disembarked(_Player)
AND
DB_UND_EbonLake_Raft_DisembarkPlayerIndex(_Index)
AND
IntegerSum(_Index, 1, _NewIndex)
AND
DB_UND_EbonLake_Raft_Locations_PlayerPositions(_NewLocationStateFlag, _NewIndex, _NewPosition)
THEN
DB_UND_EbonLake_Raft_Disembarked((CHARACTER)_Player);
DB_UND_EbonLake_Raft_DisembarkPlayerIndex(_NewIndex);
NOT DB_UND_EbonLake_Raft_DisembarkPlayerIndex(_Index);
TeleportTo(_Player, _NewPosition, "", 0, 1, 1);
Unfreeze(_Player);
PROC_SetInvulnerable(_Player, 0);
SetVisible(_Player, 1);
PROC_UND_EbonLake_Fading_FadeIn(_Player, 1.0);

IF
TimerFinished("UND_EbonLake_ChainParty")
THEN
PROC_UND_EbonLake_Raft_ChainParty();

PROC
PROC_UND_EbonLake_Raft_ChainParty()
AND
DB_UND_EbonLake_Raft_Captain(_Captain)
AND
IsInTrigger(_Captain, S_UND_DarkLake_LakeEncounterTrigger_d26a46e5-4711-4fd9-80c6-18c5a1196ec9, 0)
AND
DB_UND_EbonLake_Raft_Crew(_Player)
AND
_Player != _Captain
THEN
AttachToPartyGroup(_Player, _Captain);
//END_REGION Disembarking

//REGION NON-GENERIC Lake Encounter
//Spot Players
PROC
PROC_UND_EbonLake_Raft_Arrived_Hook(UND_EbonLake_State_RaftAtLake_8ff8fe26-4546-40e0-94a5-03dba9001650)
AND
GetFlag(UND_EbonLake_State_RaftAtLake_8ff8fe26-4546-40e0-94a5-03dba9001650, NULL_00000000-0000-0000-0000-000000000000, 1)
THEN
PROC_UND_EbonLake_ImitatePassageOfTime(S_UND_DarkLake_LakeEncounterTrigger_d26a46e5-4711-4fd9-80c6-18c5a1196ec9);
PROC_UND_DarkLake_StartRaftDialog();

PROC
PROC_UND_EbonLake_ImitatePassageOfTime((TRIGGER)_Trigger)
AND
DB_Players(_Player)
AND
IsInTrigger(_Player, _Trigger, 1)
THEN
PROC_RemoveMutingPolymorphs(_Player);
PROC_RemoveMutingStatusses(_Player);
RemoveStatusesWithGroup(_Player, "SG_Invisible");
PROC_GLO_BreakConcentration(_Player);
RemoveSplatters(_Player);

PROC
PROC_UND_DarkLake_StartRaftDialog()
AND
DB_UND_EbonLake_Raft_Captain(_Player)
AND
NOT QRY_StartDialog_Fixed(UND_DarkLake_RaftEvent_10631f38-24d4-b8eb-c913-286fedfb5cfc, S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec, _Player)
THEN
PROC_UND_DarkLake_OnDialogFailedToStart();

IF 
DialogRequestFailed(UND_DarkLake_RaftEvent_10631f38-24d4-b8eb-c913-286fedfb5cfc, _)
THEN
PROC_UND_DarkLake_OnDialogFailedToStart();

PROC
PROC_UND_DarkLake_OnDialogFailedToStart()
THEN
PROC_UND_DarkLake_MakeJump();
SetFlag(UND_DarkLake_State_HostileResolution_d9683a6f-10b4-87e5-9921-e25287267211, NULL_00000000-0000-0000-0000-000000000000);
PROC_SetRelationToPlayers(ACT1_UND_DuergarSquad_0b8fb7f0-e0c2-1c15-7f87-20fdb1d220f2, 0);

IF
DialogStarted(UND_DarkLake_RaftEvent_10631f38-24d4-b8eb-c913-286fedfb5cfc, _)
THEN
TeleportTo(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec, S_UND_DarkLake_RaftCaptainPointOnPlayerRaft_1d030056-f5ca-486e-8d56-1b6d62f99210); 

PROC
PROC_UND_DarkLake_MakeJump()
THEN
UseSpell(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec, "Projectile_UND_DarkLake_RaftCaptainJump", S_UND_DarkLake_RaftCaptainPointOnPlayerRaft_1d030056-f5ca-486e-8d56-1b6d62f99210);

PROC
PROC_GlobalFlagReactionAfterDialog(UND_DarkLake_State_PeacefulResolution_629a38e0-ba91-2a6b-bdcc-636fdbb9d20e)
THEN
PROC_UND_DarkLake_MoveToCampAfterLakeEncounter();

PROC
PROC_GlobalFlagReactionAfterDialog(UND_DarkLake_State_HostileResolution_d9683a6f-10b4-87e5-9921-e25287267211)
THEN
PROC_SetRelationToPlayers(ACT1_UND_DuergarSquad_0b8fb7f0-e0c2-1c15-7f87-20fdb1d220f2, 0);

IF
DialogAttackRequested(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec, _Player)
AND
DB_UND_EbonLake_RaftCaptainTrackDialogAttack(1)
THEN
SetFlag(UND_DarkLake_State_HostileResolution_d9683a6f-10b4-87e5-9921-e25287267211, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_UND_EbonLake_RaftCaptainTrackDialogAttack(1);

PROC
PROC_UND_DarkLake_MoveToCampAfterLakeEncounter()
THEN
ClearFlag((FLAG)UND_DarkLake_State_DuergarsAtLake_85d7bbfc-bffe-48bb-955d-f1f450b16e39, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_UND_EbonLake_PrepareAndMoveRaftFromTrigger((ITEM)S_UND_EbonLake_RaftInvisibleHelperAtLake_7a06c836-c692-4682-afcb-a67421b43c5a, (TRIGGER)S_UND_DarkLake_LakeEncounterTrigger_d26a46e5-4711-4fd9-80c6-18c5a1196ec9, (FLAG)UND_EbonLake_State_RaftAtCamp_526b966d-e826-4290-8331-e4747c1df3a5);
PROC_UND_DarkLake_SendDuergarCrewToPatrol();

PROC
PROC_UND_DarkLake_SendDuergarCrewToPatrol()
AND
DB_UND_DuergarSquad(_Character)
AND
_Character != S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec
THEN
SetOnStage(_Character, 0);

//END_REGION

//REGION Duergar Camp Intro with Raft Captain
PROC
PROC_UND_EbonLake_Raft_Arrived_Hook(UND_EbonLake_State_RaftAtCamp_526b966d-e826-4290-8331-e4747c1df3a5)
AND
DB_GlobalFlag(UND_DarkLake_State_PeacefulResolution_629a38e0-ba91-2a6b-bdcc-636fdbb9d20e)
AND
QRY_OnlyOnce("UND_DarkLake_RaftCaptainCampIntroductionDialog")
THEN
PROC_UND_EbonLake_ImitatePassageOfTime(S_UND_DarkLake_BoatAtCampArea_467f81f9-f1d6-4c2a-a3d5-1ac0d8897b76);
TeleportTo(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec, S_UND_DarkLake_RaftCaptainPositionAtCamp_9a4f395f-d268-458e-a878-b7c1adfc2cd3, "UND_EbonLake_TeleportedToCamp");

IF
EntityEvent(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec, "UND_EbonLake_TeleportedToCamp")
THEN
ObjectTimerLaunch(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec, "UND_DarkLake_RaftCaptain_StartSpottingInCamp", 1000);

IF
ObjectTimerFinished(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec, "UND_DarkLake_RaftCaptain_StartSpottingInCamp")
THEN
SetFlag((FLAG)UND_DarkLake_State_CampIntro_d488b36c-6d1c-d5b4-7862-7f771c02bb24, S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec);
NOT DB_UND_EbonLake_RaftCaptainTrackDialogAttack(1);

IF
DialogEnded(UND_DarkLake_RaftEvent_10631f38-24d4-b8eb-c913-286fedfb5cfc, _ID)
AND
DB_GlobalFlag((FLAG)UND_DarkLake_State_PeacefulResolution_629a38e0-ba91-2a6b-bdcc-636fdbb9d20e)
AND
DB_UND_EbonLake_Raft_Captain(_Player)
AND
NOT QRY_StartDialog_Fixed(UND_DuergarCamp_Checkpoint_c40716bd-9e42-54a5-06ea-7c0cbea85a8e, (CHARACTER)S_UND_DuergarGuard_AtPier_01_5ff28d97-e070-4805-a856-3112df670e1f, _Player, (CHARACTER)S_UND_DuergarGuard_AtPier_02_2dd2a840-35ff-4ed6-bf43-f9aae0e69c32, S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec)
THEN
DB_NOOP(1);

IF
DialogActorLeft(UND_DuergarCamp_Checkpoint_c40716bd-9e42-54a5-06ea-7c0cbea85a8e, _, S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec, _)
AND
GetFlag((FLAG)UND_DarkLake_State_CampIntro_d488b36c-6d1c-d5b4-7862-7f771c02bb24, S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec, 1)
THEN
ClearFlag((FLAG)UND_DarkLake_State_CampIntro_d488b36c-6d1c-d5b4-7862-7f771c02bb24, S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec);

IF
FlagCleared(UND_DarkLake_State_CampIntro_d488b36c-6d1c-d5b4-7862-7f771c02bb24, S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec, _)
AND
GetCombatGroupID(S_UND_DuergarGuardSergeant_0aeb5411-5f13-4263-acb0-87f0689de2e5,_CombatGroupID)
THEN
PROC_RemoveAllDialogEntriesForSpeaker((CHARACTER)S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec);
DB_Dialogs((CHARACTER)S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec,UND_DuergarRaftCaptain_Camp_84d266a9-3764-b81b-05e4-69da1f331d67);
PROC_CharacterMoveTo(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec, S_UND_DuergarRaftCaptain_DebriefTrigger_822a3bfd-ff40-44f5-b07d-f4ef20909a1c, "Run", "UND_DuergarCamp_SquadMemberReturned");
PROC_GlobalSetFlagAndCache(UND_DuergarRaftCaptain_Debrief_df399331-418a-4990-9759-076b46f2de56);
DB_GLO_DefeatCounter(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec, "UND_PermaDefeatedExcavationGuards");
DB_GLO_DefeatCounter(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec,"UND_PermaDefeatedDuergarAbsolutists");
DB_UND_DuergarGuards_Excavation(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec,(TRIGGER)S_UND_DuergarRaftCaptain_DebriefTrigger_822a3bfd-ff40-44f5-b07d-f4ef20909a1c);
DB_UND_DuergarCamp_Absolutists(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec);
SetFaction(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec,(FACTION)ACT1_UND_DuergarGuards_ec33d1c9-262d-05e5-5c15-05bcb84cc6a5);
SetCombatGroupID(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec,_CombatGroupID);

//END_REGION Duergar Camp Intro with Raft Captain

//REGION Duergar Camp Intro without Raft Captain
PROC
PROC_UND_EbonLake_Raft_Arrived_Hook(UND_EbonLake_State_RaftAtCamp_526b966d-e826-4290-8331-e4747c1df3a5)
AND
DB_GlobalFlag(UND_DarkLake_State_HostileResolution_d9683a6f-10b4-87e5-9921-e25287267211)
AND
QRY_OnlyOnce("UND_DarkLake_NoRaftCaptainCampIntroductionDialog")
THEN
PROC_UND_EbonLake_ImitatePassageOfTime(S_UND_DarkLake_BoatAtCampArea_467f81f9-f1d6-4c2a-a3d5-1ac0d8897b76);

IF
DialogEnded(UND_DarkLake_RaftEvent_10631f38-24d4-b8eb-c913-286fedfb5cfc, _)
AND
DB_GlobalFlag((FLAG)UND_DarkLake_State_HostileResolution_d9683a6f-10b4-87e5-9921-e25287267211)
THEN
DB_UND_DarkLake_CheckpointFadingWithoutCaptain(1);

IF 
FlagSet(UND_EbonLake_Event_MoveToCamp_0da8fee9-b7cb-4551-9baa-ec930c118716, _,_)
AND
DB_UND_DarkLake_CheckpointFadingWithoutCaptain(1)
THEN
DB_UND_DarkLake_MovingToCamp(1);

IF
DialogEnded((DIALOGRESOURCE)UND_DarkLake_Boat_3a2b4e5e-2406-f9c1-9879-c36072d1580f, _ID)
AND
DB_UND_DarkLake_CheckpointFadingWithoutCaptain(1)
AND
DB_UND_DarkLake_MovingToCamp(1)
AND
DB_UND_EbonLake_Raft_Captain(_Player)
AND
NOT QRY_StartDialog_Fixed(UND_DuergarCamp_Checkpoint_c40716bd-9e42-54a5-06ea-7c0cbea85a8e, (CHARACTER)S_UND_DuergarGuard_AtPier_01_5ff28d97-e070-4805-a856-3112df670e1f, _Player, (CHARACTER)S_UND_DuergarGuard_AtPier_02_2dd2a840-35ff-4ed6-bf43-f9aae0e69c32)
THEN
DB_NOOP(1);

IF
DialogEnded((DIALOGRESOURCE)UND_DarkLake_Boat_3a2b4e5e-2406-f9c1-9879-c36072d1580f, _)
AND
DB_UND_DarkLake_CheckpointFadingWithoutCaptain(1)
AND
DB_UND_DarkLake_MovingToCamp(1)
THEN
NOT DB_UND_DarkLake_MovingToCamp(1);
NOT DB_UND_DarkLake_CheckpointFadingWithoutCaptain(1);

IF
DialogStarted(UND_DuergarCamp_Checkpoint_c40716bd-9e42-54a5-06ea-7c0cbea85a8e,_ID)
AND
DB_DialogPlayers(_ID,_Player,1)
THEN
PROC_UnlockWaypoint("WAYP_UND_Duergar",(CHARACTER)_Player);

IF
DialogEnded(UND_DuergarCamp_Checkpoint_c40716bd-9e42-54a5-06ea-7c0cbea85a8e, _)
THEN
TimerLaunch("UND_EbonLake_ArrivalAutoSave", 1000); // AutoSave() immediately after DialogEnded does not work

IF
TimerFinished("UND_EbonLake_ArrivalAutoSave")
THEN
AutoSave();
//END_REGION Duergar Camp Intro without Raft Captain

//REGION Docs Hostility
QRY
QRY_DialogAttackRequested_CustomResponse((CHARACTER)S_UND_DuergarRebel_AtPier_01_5ff28d97-e070-4805-a856-3112df670e1f, _Player)
THEN
PROC_GlobalSetFlagAndCache(UND_DuergarCamp_State_DocsHostile_c2e36c80-970a-4fc0-ac4b-45a665bbfcd4);
PROC_OnDialogAttackRequested((CHARACTER)S_UND_DuergarRebel_AtPier_01_5ff28d97-e070-4805-a856-3112df670e1f, _Player);

PROC
PROC_GlobalFlagReactionAfterDialog((FLAG)UND_DuergarCamp_State_DocsHostile_c2e36c80-970a-4fc0-ac4b-45a665bbfcd4)
THEN
PROC_UND_EbonLake_MakeDocksHostile();

PROC
PROC_UND_EbonLake_MakeDocksHostile()
THEN
PROC_SetRelationToPlayers((FACTION)ACT1_UND_DuergarGuards_DocsCheckpoint_2054725d-78b9-4704-8a87-93a0b9a1c5fd, 0);
//END_REGION Docs Hostility

//REGION Pushing the Squad Leader off the raft
PROC
PROC_FlagReactionAfterDialog(_Player,(FLAG)UND_DarkLake_Event_PushRaftCaptainOffRaft_fa9f5b35-925c-c18d-4d00-6497194b1293)
AND
DB_Players((CHARACTER)_Player)
THEN
Die(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec, DEATHTYPE.DoT, _Player, 1, 1);
SetOnStage(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec, 0);
//END_REGION

//REGION Gnome Hunt flag
IF
QuestUpdateUnlocked(_Player, "UND_LoneDuergar", "GaveQuest")
THEN
SetFlag(UND_DarkLake_Knows_GnomeHunt_0c91ee97-9683-5d3a-77c5-44e67bd8677d, NULL_00000000-0000-0000-0000-000000000000);

IF
QuestUpdateUnlocked(_Player, "UND_LoneDuergar", "ToldQuest")
THEN
SetFlag(UND_DarkLake_Knows_GnomeHunt_0c91ee97-9683-5d3a-77c5-44e67bd8677d, NULL_00000000-0000-0000-0000-000000000000);
//END_REGION Gnome Hunt flag

//REGION Move back to the cave
PROC
PROC_FlagReactionAfterDialog(_Player, (FLAG)UND_DarkLake_Event_MoveToCave_d580a352-2202-7c43-07c6-3ede5683cb0f, (DIALOGRESOURCE)UND_DarkLake_RaftEvent_10631f38-24d4-b8eb-c913-286fedfb5cfc)
THEN
ClearFlag(UND_DarkLake_Event_MoveToCave_d580a352-2202-7c43-07c6-3ede5683cb0f, _Player);
PROC_UND_EbonLake_PrepareAndMoveRaftFromTrigger(S_UND_EbonLake_RaftInvisibleHelperAtLake_7a06c836-c692-4682-afcb-a67421b43c5a, S_UND_DarkLake_LakeEncounterTrigger_d26a46e5-4711-4fd9-80c6-18c5a1196ec9, UND_EbonLake_State_RaftAtCave_beb83efd-711a-4e20-8d87-470050aebee8);
TeleportTo(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec, S_UND_DarkLake_DuergarPositionsOnRaft_11bbae59-5ebc-4546-8d28-e537a2c3ecbb, "UND_DarkLake_TeleportRaftCaptainBack", 0, 0, 0);

IF
EntityEvent(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec, "UND_DarkLake_TeleportRaftCaptainBack")
THEN
LookFromTrigger(S_UND_DuergarRaftCaptain_473ae3b0-d8e9-428d-9129-bbffe449b8ec, S_UND_DarkLake_DuergarPositionsOnRaft_11bbae59-5ebc-4546-8d28-e537a2c3ecbb, 1);
//END_REGION Move back to the cave

//REGION Lake Combat
PROC
PROC_GLO_DefeatCounter_AllDefeated("UND_EbonLake_DuergarSquad")
THEN
PROC_UND_DarkLake_AfterCombatResolution();

IF
CombatEnded(_CombatID)
AND
QRY_UND_EbonLake_IsLakeCombat(_CombatID)
THEN
TimerLaunch("UND_DarkLake_AfterCombatResolution", 2000);

QRY
QRY_UND_EbonLake_IsLakeCombat((GUIDSTRING)_CombatID)
AND
GetFlag(UND_EbonLake_State_RaftAtLake_8ff8fe26-4546-40e0-94a5-03dba9001650, NULL_00000000-0000-0000-0000-000000000000, 1)
AND
DB_UND_DuergarSquad(_Character)
AND
DB_Was_InCombat(_Character, _CombatID)
THEN
DB_NOOP(1);

IF
TimerFinished("UND_DarkLake_AfterCombatResolution")
THEN
PROC_UND_DarkLake_AfterCombatResolution();

// 1. all dead - send the raft back to the shore and spawn new duergar guards
PROC
PROC_UND_DarkLake_AfterCombatResolution()
AND
NOT QRY_UND_DarkLake_PlayerSquadWon()
AND
NOT QRY_UND_DarkLake_DuergarSquadWon()
AND
QRY_OnlyOnce("UND_EbonLake_LakeEncounterEnded")
THEN
PROC_UND_DarkLake_SetCaveRaftAsCurrentRaft();
PROC_UND_DarkLake_SendNewDuergarSquadToShore();
PROC_UND_DarkLake_SendPlayerBodiesToShore();

// 2. player won - highlight the Rudder, so that the player understands what to do next
PROC
PROC_UND_DarkLake_AfterCombatResolution()
AND
QRY_UND_DarkLake_PlayerSquadWon()
AND
NOT QRY_UND_DarkLake_DuergarSquadWon()
AND
QRY_OnlyOnce("UND_EbonLake_LakeEncounterEnded")
THEN
PROC_LoopEffect(VFX_Script_Perception_Default_01_46bd169e-bbb5-a6fe-0fe7-97c64f620d5d, S_UND_EbonLake_Rudder_21e36312-bb41-4187-ad50-50979e5e43a2, "UND_EbonLake_Rudder", "WLD_Main_A", "");
DB_UND_EbonLake_RudderHighlighted(1);

IF
UseStarted(_Player, S_UND_EbonLake_Rudder_21e36312-bb41-4187-ad50-50979e5e43a2)
AND
DB_UND_EbonLake_RudderHighlighted(1)
THEN
PROC_StopLoopEffect((ITEM)S_UND_EbonLake_Rudder_21e36312-bb41-4187-ad50-50979e5e43a2, "UND_EbonLake_Rudder");

// 3. duergar won - remove harmful statuses and send them to the shore
PROC
PROC_UND_DarkLake_AfterCombatResolution()
AND
NOT QRY_UND_DarkLake_PlayerSquadWon()
AND
QRY_UND_DarkLake_DuergarSquadWon()
AND
QRY_OnlyOnce("UND_EbonLake_LakeEncounterEnded")
THEN
PROC_UND_DarkLake_SetCaveRaftAsCurrentRaft();
PROC_UND_DarkLake_SendDuergarSquadToShore();
PROC_UND_DarkLake_SendPlayerBodiesToShore();

// 4. player won & duergar won - player somehow stopped the fight (gone invisible)
// do nothing, wait for the player to finish off the Duergar Squad
PROC
PROC_UND_DarkLake_SendNewDuergarSquadToShore()
THEN
PROC_Foop(S_UND_DarkLake_Patrol_000_cb258cd3-3b7f-48b4-883e-a008ea6e9e38);
PROC_Foop(S_UND_DarkLake_Patrol_001_a154f62e-771e-4bac-8af6-c28d62019d1a);

PROC
PROC_UND_DarkLake_SendDuergarSquadToShore()
AND
DB_UND_DuergarSquad_PositionsAtShore(_Duergar, _PositionAtShore)
AND
NOT DB_PermaDefeated(_Duergar)
THEN
RemoveHarmfulStatuses(_Duergar);
PROC_Poof(_Duergar);
TeleportTo(_Duergar, _PositionAtShore, "UND_DarkLake_DuergarTeleportedToShore", 0, 0, 1);

IF
EntityEvent(_Duergar, "UND_DarkLake_DuergarTeleportedToShore")
THEN
PROC_Foop(_Duergar);
PROC_ClearStoryMove((CHARACTER)_Duergar);
SetEntityEvent(_Duergar, "ClearPeaceReturn", 1);

PROC
PROC_UND_DarkLake_SetCaveRaftAsCurrentRaft()
THEN
ClearFlag(UND_EbonLake_State_RaftAtLake_8ff8fe26-4546-40e0-94a5-03dba9001650, NULL_00000000-0000-0000-0000-000000000000);
SetFlag(UND_EbonLake_State_RaftAtCave_beb83efd-711a-4e20-8d87-470050aebee8, NULL_00000000-0000-0000-0000-000000000000);
PROC_UND_EbonLake_Raft_Show(UND_EbonLake_State_RaftAtCave_beb83efd-711a-4e20-8d87-470050aebee8);

QRY
QRY_UND_DarkLake_PlayerSquadWon()
AND
DB_UND_EbonLake_Raft_Crew(_Player)
AND
QRY_UND_EbonLake_PlayerIsVictor(_Player)
THEN
DB_NOOP(1);

QRY
QRY_UND_EbonLake_PlayerIsVictor((CHARACTER)_Player)
AND
IsInTrigger(_Player, S_UND_DarkLake_LakeEncounterTrigger_d26a46e5-4711-4fd9-80c6-18c5a1196ec9, 1)
AND
NOT DB_Defeated(_Player)
THEN
DB_NOOP(1);

QRY
QRY_UND_DarkLake_DuergarSquadWon()
AND
DB_UND_DuergarSquad(_Duergar)
AND
IsInTrigger(_Duergar, S_UND_DarkLake_LakeEncounterTrigger_d26a46e5-4711-4fd9-80c6-18c5a1196ec9, 1)
AND
NOT DB_Defeated(_Duergar)
THEN
DB_NOOP(1);

IF
UseStarted(_Player, S_UND_EbonLake_Rudder_21e36312-bb41-4187-ad50-50979e5e43a2)
AND
QRY_StartDialog_Fixed(UND_DarkLake_Boat_3a2b4e5e-2406-f9c1-9879-c36072d1580f, _Player)
THEN
DB_NOOP(1);
//END_REGION Lake Combat

//REGION Sending dead players to the shore
PROC
PROC_UND_DarkLake_SendPlayerBodiesToShore()
AND
QRY_UND_EbonLake_AtLeastOnePlayerIsAlive()
AND
DB_Players(_Player)
AND
IsInTrigger(_Player, S_UND_DarkLake_LakeEncounterTrigger_d26a46e5-4711-4fd9-80c6-18c5a1196ec9, 1)
THEN
PROC_UND_EbonLake_SendDeadCharacterToShore(_Player);

QRY
QRY_UND_EbonLake_AtLeastOnePlayerIsAlive()
AND
DB_Players(_Player)
AND
NOT DB_Defeated(_Player)
THEN
DB_NOOP(1);

PROC
PROC_UND_EbonLake_SendDeadCharacterToShore((CHARACTER)_Player)
AND
GUIDToString(_Player, _TimerName)
THEN
PROC_UND_EbonLake_Fading_FadeOut(_Player, 1.0);
TimerLaunch(_TimerName, 1000);
DB_UND_DarkLake_Combat_GUIDTimers((CHARACTER)_Player, _TimerName);

IF
TimerFinished(_TimerName)
AND
DB_UND_DarkLake_Combat_GUIDTimers(_Char, _TimerName)
AND
TriggerGetRandomPosition(S_UND_Raft_CorpseTrigger_2f2ae987-aaf8-4244-b790-63d5bc7f9a14, _X, _Y, _Z)
AND
FindValidPosition(_X, _Y, _Z, 0.5, _Char, 0, _ValidX, _ValidY, _ValidZ)
THEN
NOT DB_UND_DarkLake_Combat_GUIDTimers(_Char, _TimerName);
TeleportToPosition(_Char, _ValidX, _ValidY, _ValidZ, "", 0, 0, 1);
PROC_UND_EbonLake_Fading_FadeIn(_Char, 1.0);

IF
TimerFinished(_TimerName)
AND
DB_UND_DarkLake_Combat_GUIDTimers(_Char, _TimerName)
AND
TriggerGetRandomPosition(S_UND_Raft_CorpseTrigger_2f2ae987-aaf8-4244-b790-63d5bc7f9a14, _X, _Y, _Z)
THEN
NOT DB_UND_DarkLake_Combat_GUIDTimers(_Char, _TimerName);
TeleportToPosition(_Char, _X, _Y, _Z, "", 0, 0, 1);
PROC_UND_EbonLake_Fading_FadeIn(_Char, 1.0);
//END_REGION Sending dead players to the shore

//REGION Duergar Boats
IF
DB_UND_EbonLake_BoatsAtCamp(_Boat)
THEN
DB_Dialogs(_Boat, (DIALOGRESOURCE)UND_DarkLake_DuergarBoatAtCamp_b7ab6b74-0da5-938f-40e3-ae8d1222c77a);

IF
DB_UND_EbonLake_BoatsAtCave(_Boat)
THEN
DB_Dialogs(_Boat, (DIALOGRESOURCE)UND_DarkLake_DuergarBoatAtCave_0c3d00d8-77ac-d41e-0ed2-f2d213d94c00);
SetOnStage(_Boat, 0);

PROC
PROC_FlagReactionAfterDialog(_Player, UND_DarkLake_Event_MoveToCaveOnBoat_443df3f1-d0c4-4e72-a968-194ee6dc6c40)
THEN
ClearFlag(UND_DarkLake_Event_MoveToCaveOnBoat_443df3f1-d0c4-4e72-a968-194ee6dc6c40, _Player);
TeleportTo(_Player, S_UND_DuergarCamp_Boats_PassengerPositionAtCave_16c4c455-c8f6-41e7-bf6b-d36c624ddb8a, "UND_EbonLake_UsedDuergarBoat", 1, 1, 1, 0, 1);

PROC
PROC_FlagReactionAfterDialog(_Player, UND_DarkLake_Event_MoveToCampOnBoat_28ab45e0-54ae-48a3-a164-82f39971e64e)
THEN
ClearFlag(UND_DarkLake_Event_MoveToCampOnBoat_28ab45e0-54ae-48a3-a164-82f39971e64e, _Player);
TeleportTo(_Player, S_UND_DuergarCamp_Boats_PassengerPositionAtCamp_2bd5015d-157e-4b7a-8255-f503740b16e0, "UND_EbonLake_UsedDuergarBoat", 1, 1, 1, 0, 1);

// using a boat in the duergar camp for the first time sets on stage the boats in the main part of the Underdark
IF
EntityEvent(_, "UND_EbonLake_UsedDuergarBoat")
AND
QRY_OnlyOnce("UND_EbonLake_UsedDuergarBoat")
AND
DB_UND_EbonLake_BoatsAtCave(_Boat)
THEN
SetOnStage(_Boat, 1);
//END_REGION Duergar Boats

//REGION Saving Items left at the Lake Encounter in the middle of the lake
// We store the owner of them items that enter the trigger and we return the items to the owner
// when the owner leaves the trigger
// even if they owner dies they still get teleported out of trigger to either the shore or the duergar camp
IF
ItemEnteredTrigger(_Item, S_UND_DarkLake_LakeEncounter_ItemTrigger_81f523da-e930-433f-8734-4988d3bdd1ef, _)
AND
Exists(_Item,1)
AND
GetOwner(_Item, _Owner)
AND
DB_Players(_Owner)
AND
GetStackAmount(_Item, _Amount, _)
THEN
DB_UND_EbonLake_StoredItems((ITEM)_Item, (INTEGER)_Amount, (CHARACTER)_Owner);

IF
DB_UND_EbonLake_StoredItems(_Item, _Amount, _Owner)
AND
DB_Destroyed(_Item)
THEN
NOT DB_UND_EbonLake_StoredItems(_Item, _Amount, _Owner);

IF
ItemLeftTrigger(_Item, (TRIGGER)S_UND_DarkLake_LakeEncounter_ItemTrigger_81f523da-e930-433f-8734-4988d3bdd1ef, _)
AND
DB_UND_EbonLake_StoredItems(_Item, _Amount, _Owner)
THEN
NOT DB_UND_EbonLake_StoredItems(_Item, _Amount, _Owner);

IF
LeftTrigger(_Owner, (TRIGGER)S_UND_DarkLake_LakeEncounterTrigger_d26a46e5-4711-4fd9-80c6-18c5a1196ec9)
AND
DB_UND_EbonLake_StoredItems(_Item, _Amount, _Owner)
AND
Exists(_Item,1)
THEN
ToInventory(_Item, _Owner, _Amount, 1, 0);

IF
LeftTrigger(_Owner, (TRIGGER)S_UND_DarkLake_LakeEncounterTrigger_d26a46e5-4711-4fd9-80c6-18c5a1196ec9)
AND
DB_UND_EbonLake_StoredItems(_Item, _Amount, _Owner)
THEN
NOT DB_UND_EbonLake_StoredItems(_Item, _Amount, _Owner);
//END_REGION

//REGION Peaceful Resolution XP
PROC
PROC_GlobalFlagReactionAfterDialog(UND_DarkLake_State_PeacefulResolution_629a38e0-ba91-2a6b-bdcc-636fdbb9d20e)
AND
DB_UND_DuergarSquad(_Duergar)
THEN
PROC_PeacefulResolve(_Duergar);
//END_REGION

//REGION Fix for the issue with the raft being occasionally displaced
IF
EnteredChasm(S_UND_EbonLake_RaftAtCamp_FullRaft_eec3661a-7173-48c2-8793-2970d2c9618d, _, _, _, _, _)
THEN
EnterChasmProcessed(S_UND_EbonLake_RaftAtCamp_FullRaft_eec3661a-7173-48c2-8793-2970d2c9618d, 1);
//END_REGION

//REGION Goal Completion
PROC
PROC_LevelLoadedOnce("BGO_Main_A")
THEN
GoalCompleted;
//END_REGION
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "Act1"
